<!DOCTYPE html>
<!-- Tambahkan translate="no" dan class="notranslate" di sini -->
<html lang="en" translate="no" class="notranslate">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="google" content="notranslate">
    <title>Ujian Online Dinamis (Session Auto Clear)</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #3730a3;
            --secondary: #4338ca;
            --bg: #f8fafc;
            --text: #1f2937;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --touch-highlight: #e0e7ff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); color: var(--text); margin: 0; padding: 0; line-height: 1.5;
            user-select: none; -webkit-user-select: none; top: 0 !important;
        }
        .skiptranslate { display: none !important; }

        .container {
            width: 100%; max-width: 600px; margin: 0 auto; background: var(--bg);
            padding: 0 0 80px 0; min-height: 100vh;
        }

        /* HEADER */
        .header {
            background: white; padding: 12px 15px; position: relative; z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px;
        }
        .header-left { display: flex; align-items: center; gap: 10px; flex: 1; }
        .school-logo { width: 45px; height: 45px; object-fit: cover; border-radius: 50%; border: 2px solid var(--border); }
        .header-text h1 { margin: 0; font-size: 1rem; font-weight: 700; line-height: 1.2; }
        .header-text p { margin: 2px 0 0 0; font-size: 0.75rem; color: #64748b; }

        /* DATA DIRI */
        .identity-box {
            background: white; margin: 15px; padding: 20px; border-radius: 12px;
            border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }
        .identity-box h3 { margin-top: 0; font-size: 1.1rem; color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-row { display: flex; gap: 10px; }
        .form-row .form-group { flex: 1; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 0.9rem; font-weight: 600; color: #475569; }
        .form-group input {
            width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px;
            font-size: 1rem; background: #f8fafc; transition: border-color 0.2s;
        }
        .form-group input:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

        /* SOAL CARDS */
        .question-card {
            background: white; margin: 15px; padding: 20px; border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03); border: 1px solid var(--border);
        }
        .question-card.unanswered { border: 2px solid #ef4444; background-color: #fff1f2; }
        .question-text { font-size: 1.05rem; font-weight: 600; margin-bottom: 15px; color: #1e293b; }
        .reading-text {
            background-color: #f1f5f9; border-left: 4px solid var(--primary); padding: 12px;
            margin-bottom: 15px; font-size: 0.95rem; font-style: italic; color: #334155;
            white-space: pre-line; border-radius: 0 8px 8px 0;
        }
        .question-img { max-width: 100%; height: auto; border-radius: 8px; border: 1px solid var(--border); margin: 10px 0; }

        /* OPSI JAWABAN */
        .options { display: flex; flex-direction: column; gap: 10px; }
        .options label {
            display: flex; align-items: center; padding: 12px 15px; background: #ffffff;
            border: 1px solid #cbd5e1; border-radius: 10px; cursor: pointer;
            transition: all 0.2s; font-size: 0.95rem; min-height: 48px;
        }
        .options label:active { background-color: var(--touch-highlight); transform: scale(0.98); }
        .options input[type="radio"] { width: 20px; height: 20px; margin-right: 12px; accent-color: var(--primary); }
        /* Style huruf opsi (A, B, C...) */
        .opt-label { font-weight: bold; margin-right: 8px; min-width: 20px; color: var(--primary); }
        .options label:has(input:checked) { background-color: #eef2ff; border-color: var(--primary); }

        /* BUTTONS & MODALS */
        .btn-submit {
            display: block; width: calc(100% - 30px); margin: 25px auto; background: var(--primary);
            color: white; border: none; padding: 16px; font-size: 1.1rem; font-weight: bold;
            border-radius: 12px; cursor: pointer; box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3);
            transition: transform 0.1s, background 0.2s;
        }
        .btn-submit:active { transform: scale(0.97); background: var(--primary-dark); }

        #result-area, #locked-screen {
            margin: 20px 15px; padding: 25px 20px; background: white; border-radius: 16px;
            text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        #locked-screen { border: 2px solid #e11d48; background: #fff1f2; }
        
        .result-card {
            background: #f8fafc; border: 1px solid #cbd5e1; padding: 15px;
            border-radius: 12px; margin-top: 15px; text-align: left;
        }
        .result-table td { padding: 8px 0; font-size: 0.95rem; }
        .result-table td:first-child { width: 100px; color: #64748b; }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); display: none; justify-content: center;
            align-items: center; z-index: 10000; font-weight: bold; color: var(--primary);
            flex-direction: column;
        }
        
        /* RULE OVERLAY STYLES */
        #rule-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 20000; display: flex; 
            justify-content: center; align-items: center; padding: 20px;
        }
        .rule-box {
            max-width: 500px; width: 100%;
            background: white;
            text-align: center;
        }
        .rule-list {
            text-align: left;
            margin: 20px 0;
            background: #fff1f2;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #fda4af;
        }
        .rule-list li { margin-bottom: 10px; color: #881337; font-weight: 500; }

        .spinner {
            width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #admin-panel { padding: 15px; background: white; margin-bottom: 50px; display: none; }
        .admin-controls button { display: block; width: 100%; margin-bottom: 10px; padding: 12px; }
    </style>
</head>
<body oncontextmenu="return false;">

<!-- RULE OVERLAY (PERINGATAN AWAL) -->
<div id="rule-overlay">
    <div class="rule-box">
        <img src="https://cdn-icons-png.flaticon.com/512/1000/1000997.png" alt="Warning" style="width: 80px; margin-bottom: 15px;">
        <h2 style="color: #be123c; margin: 0 0 10px 0;">PERATURAN UJIAN</h2>
        <p style="color: #4b5563;">Harap baca aturan berikut sebelum memulai.</p>
        
        <ul class="rule-list">
            <li>üö´ <b>Dilarang membuka tab lain</b> atau keluar dari aplikasi ini.</li>
            <li>üëÄ Sistem memiliki <b>pendeteksi kecurangan</b> otomatis.</li>
            <li>‚ö†Ô∏è Jika melanggar lebih dari <b>3 kali</b>, jawaban akan dikirim <b>OTOMATIS</b> dan ujian berakhir.</li>
            <li>üíæ Jawaban tersimpan saat <b>Refresh</b>, tapi <b>HILANG</b> jika tab/browser <b>DITUTUP</b>.</li>
        </ul>

        <button onclick="acceptRules()" class="btn-submit" style="background: #059669; margin-top: 0;">
            SAYA MENGERTI & MULAI
        </button>
    </div>
</div>

<div id="loader" class="loading-overlay">
    <div class="spinner"></div>
    <div>Sedang memproses...</div>
</div>

<div class="container">
    <div class="header">
        <div class="header-left">
            <img src="https://raw.githubusercontent.com/atha-cyber/logo-/5eeaaecc00cf02080842f1cd6f4fc7bf13fe7f18/images.jfif" alt="Logo" class="school-logo">
            <div class="header-text">
                <h1>SMP NEGERI 4 PANDAK</h1>
                <p>Remidi Bahasa Inggris Kelas 7</p>
            </div>
        </div>
    </div>

    <!-- IDENTITAS -->
    <div class="identity-box">
        <h3>üìã Data Diri Siswa</h3>
        <div class="form-group">
            <label>Nama Lengkap</label>
            <input type="text" id="studentName" placeholder="Nama Lengkap..." autocomplete="off" required>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Kelas</label>
                <input type="text" id="studentClass" placeholder="Contoh: 7A" autocomplete="off" required>
            </div>
            <div class="form-group">
                <label>Absen</label>
                <input type="number" id="studentAbsen" placeholder="No." autocomplete="off" required>
            </div>
        </div>
    </div>

    <form id="examForm" onsubmit="event.preventDefault(); gradeExam();" autocomplete="off">
        <div id="questions-container">
            <!-- Soal akan muncul otomatis di sini -->
        </div>
        <button type="button" class="btn-submit" onclick="gradeExam()">Selesai & Kumpulkan Jawaban</button>
    </form>

    <!-- LAYAR TERKUNCI (HASIL) -->
    <div id="locked-screen" style="display:none;">
        <div style="font-size: 3rem; margin-bottom: 10px;">üîí</div>
        <h2 style="color:#be123c; margin-top:0;">Ujian Selesai!</h2>
        <p style="font-size:1rem; margin-bottom:20px; color: #4b5563;">
            Jawaban Anda telah tersimpan di server.
        </p>
        
        <!-- MODIFIKASI: Tombol Reset untuk Siswa Berikutnya -->
        <button onclick="resetSession()" style="background:#059669; color:white; border:none; padding:12px 25px; font-size:1rem; font-weight:bold; border-radius:8px; cursor:pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%;">
            üîÑ Selesai & Reset (Siswa Baru)
        </button>
    </div>

    <!-- HASIL (HIDDEN) -->
    <div id="result-area" style="display:none;">
        <h2 style="color:var(--primary);">Hasil Ujian</h2>
        <div class="result-card">
            <table class="result-table" style="width:100%;">
                <tr><td>Nama Siswa</td><td>: <span id="res-nama" style="font-weight:600;"></span></td></tr>
                <tr><td>Kelas</td><td>: <span id="res-kelas"></span></td></tr>
                <tr><td>No. Absen</td><td>: <span id="res-absen"></span></td></tr>
                <tr><td>Nilai Akhir</td><td>: <span id="res-nilai" style="font-weight:bold; color:#059669; font-size:1.4rem;"></span></td></tr>
            </table>
            <div style="margin-top: 15px; border-top: 1px dashed #cbd5e1; padding-top: 10px; font-size: 0.8rem; text-align: center; color: #94a3b8;">
                Validasi: <span id="res-kode" style="font-family: monospace;"></span>
            </div>
        </div>
        <p id="feedback-text" style="font-weight:bold; margin-top:20px;">Nilai Anda belum mencukupi.</p>
        
        <!-- Tombol Reset di dalam view hasil juga -->
        <button onclick="resetSession()" style="background:#6b7280; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; margin-top:20px;">
            Keluar & Reset
        </button>
    </div>

    <!-- ADMIN -->
    <div id="admin-panel">
        <div class="admin-controls">
            <h3 style="color:#b91c1c; margin-top:0;">üîê Database Guru</h3>
            <button onclick="downloadCSV()" style="background:#059669; color:white; border:none; border-radius:8px;">üì• Download Excel</button>
            <button onclick="hapusData()" style="background:#dc2626; color:white; border:none; border-radius:8px;">üóëÔ∏è Hapus Semua Data</button>
            <button onclick="tutupAdmin()" style="background:#6b7280; color:white; border:none; border-radius:8px;">Tutup Panel</button>
        </div>
        <div style="overflow-x:auto; margin-top:15px;">
            <table border="1" style="width:100%; border-collapse:collapse; border-color:#e2e8f0; font-size:0.85rem;">
                <thead><tr style="background:#f1f5f9;"><th style="padding:8px;">Nama</th><th style="padding:8px;">Kls</th><th style="padding:8px;">Nilai</th></tr></thead>
                <tbody id="tabel-nilai"><tr><td colspan='3' style='text-align:center; padding:10px;'>Memuat data...</td></tr></tbody>
            </table>
        </div>
    </div>
    <button onclick="bukaAdmin()" style="position:fixed; bottom:20px; right:20px; background:rgba(255,255,255,0.8); border:1px solid #cbd5e1; font-size:1.5rem; cursor:pointer; border-radius:50%; width:45px; height:45px; z-index:9999; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">üîí</button>
</div>

<!-- LOGIKA APLIKASI -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // --- VARIABEL STATE & CONFIG ---
    let isExamFinished = false; 
    let violationCount = 0;
    let isRuleAccepted = false; // State untuk aturan
    const MAX_VIOLATIONS = 3;

    // Kunci Storage
    const STORAGE_KEY = 'exam_eng_7_data'; 
    const ORDER_KEY = 'exam_eng_7_order'; 
    const VIOLATION_KEY = 'exam_eng_7_violations'; 
    const STATUS_KEY = 'exam_eng_7_status'; 
    const RULE_ACCEPTED_KEY = 'exam_eng_7_rule_accepted';

    // --- CONFIG UTAMA: Ganti localStorage dengan sessionStorage ---
    // Ini adalah kunci agar saat tab ditutup, data hilang (Auto Reset)
    const storage = sessionStorage; 

    const firebaseConfig = {
      apiKey: "AIzaSyDy6E0FpxFAV8Fq2ayO1UWd2UMC19xLHgM",
      authDomain: "vooting-guru.firebaseapp.com",
      projectId: "vooting-guru",
      storageBucket: "vooting-guru.firebasestorage.app",
      messagingSenderId: "643701954972",
      appId: "1:643701954972:web:5db3499faeb8ca91919059",
      measurementId: "G-MZV18MY9VM"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const COLLECTION_NAME = 'exam_results_english_7';
    const passwordGuru = "!@#$%^&*()"; 

    // --- BANK SOAL ---
    const BANK_SOAL = [
        { id: 1, tanya: 'When do you say "Good morning"?', opsi: {A: "After lunch", B: "Before breakfast", C: "In the evening", D: "In the morning"}, kunci: "D" },
        { id: 2, tanya: "Which one is a common informal greeting between friends?", opsi: {A: "Good evening, Sir.", B: "How do you do?", C: "Hey, what's up?", D: "Nice to meet you."}, kunci: "C" },
        { id: 3, tanya: "Which greeting is appropriate when meeting someone for the first time?", opsi: {A: "Long time no see.", B: "What's your name? I'm Leony.", C: "How do you do?", D: "Good night, see you tomorrow."}, kunci: "C" },
        { id: 4, tanya: "What do you say when someone helps you?", opsi: {A: "Sorry.", B: "Goodbye.", C: "Thank you.", D: "See you."}, kunci: "C" },
        { id: 5, tanya: 'How do you respond to "Thank you"?', opsi: {A: "I'm sorry.", B: "You're welcome.", C: "Never mind.", D: "No way."}, kunci: "B" },
        { id: 6, bacaan: "Anna : Hi, Tom. Thank you very much for your help with my homework.\nTom : No problem, Anna. I am happy to help you.\nAnna : I really appreciate it. I feel confused before you explain it.\nTom : You're welcome. If you need help, just ask.\nAnna : That means a lot. Thanks again", tanya: "Why does Anna thank Tom?", opsi: {A: "He gives her food.", B: "He helps her with homework.", C: "He calls her.", D: "He walks her home."}, kunci: "B" },
        { id: 7, bacaan: "Anna : Hi, Tom. Thank you very much for your help with my homework.\nTom : No problem, Anna. I am happy to help you.\nAnna : I really appreciate it. I feel confused before you explain it.\nTom : You're welcome. If you need help, just ask.\nAnna : That means a lot. Thanks again", tanya: "What does Tom say when Anna says thank you?", opsi: {A: "I don't know.", B: "You're welcome.", C: "See you later.", D: "That's not true."}, kunci: "B" },
        { id: 8, bacaan: "Anna : Hi, Tom. Thank you very much for your help with my homework.\nTom : No problem, Anna. I am happy to help you.\nAnna : I really appreciate it. I feel confused before you explain it.\nTom : You're welcome. If you need help, just ask.\nAnna : That means a lot. Thanks again", tanya: "What does Anna feel before Tom helps her?", opsi: {A: "Happy", B: "Sad", C: "Confused", D: "Angry"}, kunci: "C" },
        { id: 9, bacaan: "Sarah : Hi, Emma. I'm really sorry I am late.\nEmma : It's okay. What happens?\nSarah : I miss the bus and wait for the next one.\nEmma : I see. Thanks for telling me\nSarah : Again, I'm really sorry for making you wait.\nEmma : No problem. Let's go now.", tanya: "Why does Sarah say sorry?", opsi: {A: "She forgets her bag.", B: "She is late.", C: "She goes home early.", D: "She doesn't come."}, kunci: "B" },
        { id: 10, bacaan: "Sarah : Hi, Emma. I'm really sorry I am late.\nEmma : It's okay. What happens?\nSarah : I miss the bus and wait for the next one.\nEmma : I see. Thanks for telling me\nSarah : Again, I'm really sorry for making you wait.\nEmma : No problem. Let's go now.", tanya: "What happens to Sarah?", opsi: {A: "She doesn't wake up.", B: "She is sick.", C: "She misses the bus.", D: "She goes to the wrong place."}, kunci: "C" },
        { id: 11, bacaan: "Roni : Hi Reni, when will you have your birthday party.\nReni : Hi Roni, next week on Saturday evening.\nRoni : What time will it start?\nReni : It will start at 7 o'clock.\nRoni : What is the date of your birth?\nReni : It is the 29th of November.\nRoni : So, how old will you turn?\nReni : I will turn 13 years old this Saturday.\nRoni : That will be your first party of your teenaged hood.\nReni : Exactly. Come to my birthday party, right?\nRoni : I will. Well the bell is ringing. See you later", tanya: "What does the conversation talk about?", opsi: {A: "Reni's identity", B: "Reni's date of birth", C: "Roni's celebration", D: "The time of Reni's birthday party"}, kunci: "D" },
        { id: 12, bacaan: "Roni : Hi Reni, when will you have your birthday party.\nReni : Hi Roni, next week on Saturday evening.\nRoni : What time will it start?\nReni : It will start at 7 o'clock.\nRoni : What is the date of your birth?\nReni : It is the 29th of November.\nRoni : So, how old will you turn?\nReni : I will turn 13 years old this Saturday.\nRoni : That will be your first party of your teenaged hood.\nReni : Exactly. Come to my birthday party, right?\nRoni : I will. Well the bell is ringing. See you later", tanya: "Where does the dialogue take place?", opsi: {A: "At home", B: "At school", C: "At a stop", D: "On the street"}, kunci: "B" },
        { id: 13, bacaan: "Roni : Hi Reni, when will you have your birthday party.\nReni : Hi Roni, next week on Saturday evening.\nRoni : What time will it start?\nReni : It will start at 7 o'clock.\nRoni : What is the date of your birth?\nReni : It is the 29th of November.\nRoni : So, how old will you turn?\nReni : I will turn 13 years old this Saturday.\nRoni : That will be your first party of your teenaged hood.\nReni : Exactly. Come to my birthday party, right?\nRoni : I will. Well the bell is ringing. See you later", tanya: "How old will Reni be?", opsi: {A: "Thirty years old", B: "Three years old", C: "Thirteen years old", D: "Thirty-three years old"}, kunci: "C" },
        { id: 14, bacaan: "Roni : Hi Reni, when will you have your birthday party.\nReni : Hi Roni, next week on Saturday evening.\nRoni : What time will it start?\nReni : It will start at 7 o'clock.\nRoni : What is the date of your birth?\nReni : It is the 29th of November.\nRoni : So, how old will you turn?\nReni : I will turn 13 years old this Saturday.\nRoni : That will be your first party of your teenaged hood.\nReni : Exactly. Come to my birthday party, right?\nRoni : I will. Well the bell is ringing. See you later", tanya: "What is the relationship between Roni and Reni?", opsi: {A: "Siblings", B: "Friends", C: "Aunt and niece", D: "Mother and daughter"}, kunci: "B" },
        { id: 15, bacaan: 'Ihsan is speaking in front of the class. This is what he says:\n"Hello, My name is Ihsan Nugroho. You can call me Ihsan. It\'s nice to meet you. I am from Yogyakarta. Now, I live at Nusantara Street number six, Bantul. I am thirteen years old. I was born on the 12th of April 2011. I am 160 cm tall and 57 kg of weight. I like playing games. My favourite food is fried chicken and my favourite drink is milk. The subject I like most is Sport. I am a second-year student of SMP Nusa Bangsa Bantul."', tanya: "What is the full name of the boy in the text?", opsi: {A: "Ihsan Raharjo", B: "Nugroho Ihsan", C: "Ihsan Nugroho", D: "Nugroho Raharjo"}, kunci: "C" },
        
        { id: 16, bacaan: 'Ihsan is speaking in front of the class. This is what he says:\n"Hello, My name is Ihsan Nugroho. You can call me Ihsan. It\'s nice to meet you. I am from Yogyakarta. Now, I live at Nusantara Street number six, Bantul. I am thirteen years old. I was born on the 12th of April 2011. I am 160 cm tall and 57 kg of weight. I like playing games. My favourite food is fried chicken and my favourite drink is milk. The subject I like most is Sport. I am a second-year student of SMP Nusa Bangsa Bantul."', tanya: "Why does Ihsan Nugroho speak in front of the class?", opsi: {A: "To meet his friends", B: "To tell his friends his favourite food", C: "To know his classmates", D: "To introduce himself"}, kunci: "D" },
        { id: 17, bacaan: 'Ihsan is speaking in front of the class. This is what he says:\n"Hello, My name is Ihsan Nugroho. You can call me Ihsan. It\'s nice to meet you. I am from Yogyakarta. Now, I live at Nusantara Street number six, Bantul. I am thirteen years old. I was born on the 12th of April 2011. I am 160 cm tall and 57 kg of weight. I like playing games. My favourite food is fried chicken and my favourite drink is milk. The subject I like most is Sport. I am a second-year student of SMP Nusa Bangsa Bantul."', tanya: "Where does Ihsan live now?", opsi: {A: "Yogyakarta City", B: "Nusantara Street number six, Bantul", C: "Bantul Street number six, Nusantara", D: "Malioboro Street, Yogyakarta"}, kunci: "B" },
        { id: 18, bacaan: 'Ihsan is speaking in front of the class. This is what he says:\n"Hello, My name is Ihsan Nugroho. You can call me Ihsan. It\'s nice to meet you. I am from Yogyakarta. Now, I live at Nusantara Street number six, Bantul. I am thirteen years old. I was born on the 12th of April 2011. I am 160 cm tall and 57 kg of weight. I like playing games. My favourite food is fried chicken and my favourite drink is milk. The subject I like most is Sport. I am a second-year student of SMP Nusa Bangsa Bantul."', tanya: "What is Ihsan's favourite drink?", opsi: {A: "Water", B: "Tea", C: "Milk", D: "Juice"}, kunci: "C" },
        
        { id: 19, tanya: "What time is it if the clock shows 10:15?", opsi: {A: "It is a quarter to ten.", B: "It is a quarter past ten.", C: "It is ten o'clock.", D: "It is half past ten."}, kunci: "B" },
        { id: 20, tanya: "The correct way to say 07:30 is...", opsi: {A: "It is thirty to seven.", B: "It is seven thirty o'clock.", C: "It is half past seven.", D: "It is thirty past seven."}, kunci: "C" },
        { id: 21, tanya: "If the time is 03:45, how do you express it using the phrase 'to'?", opsi: {A: "It is fifteen to three.", B: "It is three forty-five.", C: "It is a quarter to four.", D: "It is a quarter past three."}, kunci: "C" },
        { id: 22, gambar: "https://media.istockphoto.com/id/873908854/id/foto/bulat-dinding-kantor-jam-di-putih-setengah-dua-belas.jpg?s=1024x1024&w=is&k=20&c=ISROTHHz3neYPccMwQQVWlt7WXtwF803AoJgQpHR16o=", tanya: "What is the time shown in the picture?", opsi: {A: "Half past twelve", B: "Twelve o‚Äôclock", C: "Quarter past twelve", D: "Quarter to twelve"}, kunci: "A" },
        { id: 23, tanya: 'What time is it if someone says, "It is twenty-five past nine"?', opsi: {A: "09:15", B: "09:30", C: "09:25", D: "09:10"}, kunci: "C" },
        { id: 24, tanya: "What is the fourth month of the year?", opsi: {A: "June", B: "March", C: "April", D: "July"}, kunci: "C" },
        { id: 25, tanya: "Today is Monday, October 25th, what date was it the day before yesterday?", opsi: {A: "Sunday, October 24th", B: "Saturday, October 23rd", C: "Tuesday, October 26th", D: "Saturday, October 24th"}, kunci: "B" },
        { id: 26, tanya: "The correct way to write the date 12/05/2024 (using the day-month-year format) in English is...", opsi: {A: "The fifth of December, twenty twenty-four.", B: "The twelfth of May, twenty twenty-four.", C: "December fifth, twenty twenty-four.", D: "May twelfth, twenty twenty-four."}, kunci: "B" },
        { id: 27, tanya: "What do you use to clean your hands after playing outside?", opsi: {A: "Towel", B: "Soap", C: "Spoon", D: "Mirror"}, kunci: "B" },
        { id: 28, tanya: "This item is rectangular and is used to write down notes and drawings in class.", opsi: {A: "Pencil", B: "Crayon", C: "Book", D: "Notebook"}, kunci: "D" },
        { id: 29, tanya: "Which of these is a source of natural light during the day?", opsi: {A: "Lamp", B: "Candle", C: "Moon", D: "Sun"}, kunci: "D" },
        { id: 30, tanya: "We keep our clothes, jackets, and pants neatly inside this large piece of furniture in the bedroom.", opsi: {A: "Bed", B: "Desk", C: "Wardrobe", D: "Shelf"}, kunci: "C" },
        { id: 31, tanya: "What is the main tool used for eating soup?", opsi: {A: "Knife", B: "Fork", C: "Spoon", D: "Chopsticks"}, kunci: "C" },
        { id: 32, tanya: "I have four legs and a flat top. I am used for putting food on when eating. What am I?", opsi: {A: "Door", B: "Chair", C: "Table", D: "Window"}, kunci: "C" },
        { id: 33, tanya: "Which object is used to measure the temperature of a person?", opsi: {A: "Scale", B: "Ruler", C: "Thermometer", D: "Microscope"}, kunci: "C" },
        { id: 34, tanya: "This object is usually round and you can see your reflection in it.", opsi: {A: "Picture", B: "Vase", C: "Clock", D: "Mirror"}, kunci: "D" },
        { id: 35, tanya: "It is a place in the school where students borrow and read books.", opsi: {A: "Canteen", B: "Library", C: "Laboratory", D: "Hall"}, kunci: "B" },
        { id: 36, tanya: "What is the name of the white, rectangular board in the classroom where the teacher writes lessons?", opsi: {A: "Blueboard", B: "Whiteboard", C: "Bulletin board", D: "Notice board"}, kunci: "B" },
        { id: 37, tanya: "This thing is soft and is used to rest your head on when you sleep.", opsi: {A: "Blanket", B: "Curtain", C: "Pillow", D: "Carpet"}, kunci: "C" },
        { id: 38, tanya: "Before you leave the house, you open this to go outside.", opsi: {A: "Wall", B: "Roof", C: "Window", D: "Door"}, kunci: "D" },
        { id: 39, tanya: "Which of these is a type of weather?", opsi: {A: "Mountain", B: "Sunny", C: "River", D: "Flower"}, kunci: "B" },
        { id: 40, tanya: "We use this device in the living room to watch movies and news programs.", opsi: {A: "Computer", B: "Telephone", C: "Television", D: "Radio"}, kunci: "C" }
    ];

    // INIT
    async function initAuth() {
        try { await signInAnonymously(auth); } 
        catch (error) { console.error("Login gagal", error); }
    }
    initAuth();

    let currentUser = null;
    onAuthStateChanged(auth, (user) => { if(user) currentUser = user; });

    // --- FUNGSI ATURAN ---
    window.acceptRules = function() {
        isRuleAccepted = true;
        document.getElementById('rule-overlay').style.display = 'none';
        storage.setItem(RULE_ACCEPTED_KEY, 'true'); // Simpan state di session
    }

    // --- FUNGSI UTAMA (INIT FLOW) ---
    function startApp() {
        // Cek apakah aturan sudah disetujui di sesi ini
        if(storage.getItem(RULE_ACCEPTED_KEY) === 'true') {
             document.getElementById('rule-overlay').style.display = 'none';
             isRuleAccepted = true;
        }

        // 1. Cek Pelanggaran
        const savedViolations = storage.getItem(VIOLATION_KEY);
        if (savedViolations) {
            violationCount = parseInt(savedViolations, 10);
        }

        // 2. Cek Status Selesai
        const savedStatus = storage.getItem(STATUS_KEY);
        if (savedStatus === 'finished') {
            isExamFinished = true;
            document.getElementById('rule-overlay').style.display = 'none'; 
            showLockedScreen();
            return; 
        }

        // 3. Render Soal
        renderQuestions();
        loadProgress();
        attachSaveListeners();
    }

    // --- FUNGSI PENGACAK ARRAY ---
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // --- FUNGSI URUTAN TETAP (PERSISTENT SHUFFLE) ---
    function getFixedOrder() {
        const savedOrder = storage.getItem(ORDER_KEY);
        if (savedOrder) {
            try {
                const parsed = JSON.parse(savedOrder);
                if(parsed.questionOrder.length === BANK_SOAL.length) return parsed;
            } catch(e) { }
        }
        const questionOrder = shuffleArray([...BANK_SOAL].map(s => s.id));
        const optionOrders = {};
        BANK_SOAL.forEach(s => optionOrders[s.id] = shuffleArray(Object.keys(s.opsi)));
        const newOrder = { questionOrder, optionOrders };
        storage.setItem(ORDER_KEY, JSON.stringify(newOrder));
        return newOrder;
    }

    // --- RENDER SOAL ---
    function renderQuestions() {
        if (isExamFinished) return; 

        const container = document.getElementById('questions-container');
        container.innerHTML = ""; 

        const order = getFixedOrder();

        order.questionOrder.forEach((qId, index) => {
            const soal = BANK_SOAL.find(s => s.id === qId);
            if(!soal) return;

            let html = `<div class="question-card" id="card-q${soal.id}">`;
            if(soal.bacaan) html += `<div class="reading-text">${soal.bacaan}</div>`;
            html += `<div class="question-text">${index + 1}. ${soal.tanya}</div>`;
            if(soal.gambar) html += `<img src="${soal.gambar}" class="question-img" onerror="this.style.display='none'">`;
            html += `<div class="options">`;
            
            const opsiKeys = order.optionOrders[soal.id] || Object.keys(soal.opsi);
            const labels = ['A', 'B', 'C', 'D', 'E'];

            opsiKeys.forEach((key, idx) => {
                const textValue = soal.opsi[key];
                const visualLabel = labels[idx];
                html += `
                    <label>
                        <input type="radio" name="q${soal.id}" value="${key}">
                        <span class="opt-label">${visualLabel}.</span>
                        <span>${textValue}</span>
                    </label>
                `;
            });
            
            html += `</div></div>`;
            container.innerHTML += html;
        });
    }

    // --- LOGIKA SAVE & LOAD JAWABAN (SESSION ONLY) ---
    window.saveProgress = function() {
        if (isExamFinished) return;
        const formData = {
            nama: document.getElementById('studentName').value,
            kelas: document.getElementById('studentClass').value,
            absen: document.getElementById('studentAbsen').value,
            answers: {}
        };
        document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
            formData.answers[radio.name] = radio.value;
        });
        storage.setItem(STORAGE_KEY, JSON.stringify(formData));
    }

    function loadProgress() {
        if (isExamFinished) return;
        const savedData = storage.getItem(STORAGE_KEY);
        if (savedData) {
            try {
                const data = JSON.parse(savedData);
                if(data.nama) document.getElementById('studentName').value = data.nama;
                if(data.kelas) document.getElementById('studentClass').value = data.kelas;
                if(data.absen) document.getElementById('studentAbsen').value = data.absen;
                if(data.answers) {
                    for (const [key, value] of Object.entries(data.answers)) {
                        const radio = document.querySelector(`input[name="${key}"][value="${value}"]`);
                        if (radio) radio.checked = true;
                    }
                }
            } catch (e) { }
        }
    }

    function attachSaveListeners() {
        const textInputs = document.querySelectorAll('input[type="text"], input[type="number"]');
        textInputs.forEach(input => input.addEventListener('input', window.saveProgress));
        const container = document.getElementById('questions-container');
        container.addEventListener('change', (e) => {
            if (e.target.type === 'radio') {
                window.saveProgress();
                const card = e.target.closest('.question-card');
                if(card) card.classList.remove('unanswered');
            }
        });
    }

    // --- ANTI CHEAT ---
    document.addEventListener("visibilitychange", function() {
        // HANYA jika aturan sudah disetujui DAN ujian belum selesai
        if (document.hidden && !isExamFinished && isRuleAccepted) {
            violationCount++;
            storage.setItem(VIOLATION_KEY, violationCount);

            let sisa = MAX_VIOLATIONS - violationCount;
            if (violationCount < MAX_VIOLATIONS) {
                alert(`‚ö†Ô∏è PERINGATAN KECURANGAN!\n\nAnda terdeteksi meninggalkan halaman.\nSisa kesempatan: ${sisa}.`);
            } else {
                alert(`‚õî BATAS PELANGGARAN TERCAPAI!\nJawaban dikumpulkan OTOMATIS.`);
                gradeExam();
            }
        }
    });

    // --- FUNGSI RESET TOTAL ---
    window.resetSession = function() {
        if(confirm("Yakin ingin mereset untuk siswa baru? Data sesi ini akan hilang.")) {
            // Hapus semua storage
            storage.clear();
            
            // Reload halaman agar mulai dari awal
            window.location.reload();
        }
    }

    // --- HELPER UNTUK TAMPILAN TERKUNCI ---
    function showLockedScreen() {
        document.querySelector('.header').style.display = 'none';
        document.querySelector('.identity-box').style.display = 'none';
        document.getElementById('examForm').style.display = 'none';
        document.getElementById('locked-screen').style.display = 'block';
    }

    // --- GRADE & SUBMIT ---
    window.gradeExam = async function() {
        if (!auth.currentUser) { alert("Menghubungkan server..."); return; }

        const nama = document.getElementById('studentName').value.trim().toUpperCase();
        const kelas = document.getElementById('studentClass').value.trim().toUpperCase();
        const absen = document.getElementById('studentAbsen').value.trim();

        if ((nama === "" || kelas === "" || absen === "") && violationCount < MAX_VIOLATIONS) {
            alert("Lengkapi data diri dulu!"); return;
        }

        const finalNama = nama || "PELANGGARAN_NO_NAME";
        const finalKelas = kelas || "X";
        const finalAbsen = absen || "0";

        if (violationCount < MAX_VIOLATIONS) {
            let missed = [];
            document.querySelectorAll('.question-card').forEach(c => c.classList.remove('unanswered'));
            BANK_SOAL.forEach(soal => {
                if(!document.querySelector(`input[name="q${soal.id}"]:checked`)) {
                    missed.push(soal.id);
                    document.getElementById(`card-q${soal.id}`).classList.add('unanswered');
                }
            });
            if (missed.length > 0) {
                alert(`Masih ada soal yang belum dijawab.`);
                document.getElementById(`card-q${missed[0]}`).scrollIntoView({behavior:"smooth", block:"center"});
                return;
            }
        }

        document.getElementById('loader').style.display = 'flex';

        const docId = `${finalNama.replace(/\s+/g, '_')}_${finalKelas}_${finalAbsen}`;
        const docRef = doc(db, COLLECTION_NAME, docId);

        try {
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) { endProcess("Maaf, siswa ini SUDAH mengerjakan ujian."); return; }
            
            const q = query(collection(db, COLLECTION_NAME), where('nama', '==', finalNama));
            const querySnapshot = await getDocs(q);
            let dup = false;
            querySnapshot.forEach(d => { if(d.data().kelas === finalKelas) dup = true; });
            if(dup) { endProcess(`Siswa ${finalNama} di kelas ${finalKelas} SUDAH ujian.`); return; }

        } catch (e) {
            alert("Gagal koneksi. Coba lagi.");
            document.getElementById('loader').style.display = 'none';
            return;
        }

        isExamFinished = true;
        // Simpan status finished di sessionStorage (hilang saat tab ditutup)
        storage.setItem(STATUS_KEY, 'finished'); 

        let score = 0;
        BANK_SOAL.forEach(soal => {
            const el = document.querySelector(`input[name="q${soal.id}"]:checked`);
            if (el && el.value === soal.kunci) score++;
        });
        
        let finalScore = Math.round((score / BANK_SOAL.length) * 100);
        const r1 = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(Math.random()*26)];
        const r2 = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(Math.random()*26)];
        const kode = `#SEC-${r1}${100-finalScore}${r2}`;

        const dataSiswa = {
            waktu: new Date().toLocaleString(),
            nama: finalNama, kelas: finalKelas, absen: finalAbsen,
            nilai: finalScore, kode: kode
        };

        try {
            await setDoc(docRef, dataSiswa);
            // Hapus data form tapi biarkan status finished
            storage.removeItem(STORAGE_KEY);
            storage.removeItem(ORDER_KEY);
            storage.removeItem(VIOLATION_KEY);
            document.getElementById('examForm').reset();
        } catch(e) {
            alert("Gagal simpan data ke server. Coba lagi."); 
            document.getElementById('loader').style.display = 'none'; 
            isExamFinished = false; 
            return; 
        }

        document.getElementById('loader').style.display = 'none';
        showLockedScreen();

        document.getElementById('res-nama').innerText = finalNama;
        document.getElementById('res-kelas').innerText = finalKelas;
        document.getElementById('res-absen').innerText = finalAbsen;
        document.getElementById('res-nilai').innerText = finalScore;
        document.getElementById('res-kode').innerText = kode;
        
        const fb = document.getElementById('feedback-text');
        if(finalScore >= 70) { fb.innerText = "LULUS"; fb.style.color="green"; }
        else { fb.innerText = "BELUM LULUS"; fb.style.color="red"; }
        window.scrollTo(0,0);
    }

    function endProcess(msg) {
        document.getElementById('loader').style.display = 'none';
        alert(msg);
    }

    window.bukaHasilSiswa = function() {
        if(prompt("Password Guru:") === passwordGuru) {
            document.getElementById('locked-screen').style.display = 'none';
            document.getElementById('result-area').style.display = 'block';
        }
    }
    window.bukaAdmin = function() {
        if(!auth.currentUser) return alert("Tunggu sebentar...");
        if(prompt("Password Guru:") === passwordGuru) {
            document.getElementById('admin-panel').style.display = 'block';
            renderTabelNilai();
            document.getElementById('admin-panel').scrollIntoView({behavior:"smooth"});
        }
    }
    window.tutupAdmin = () => document.getElementById('admin-panel').style.display = 'none';

    window.renderTabelNilai = async function() {
        if(!auth.currentUser) return;
        const tbody = document.getElementById('tabel-nilai');
        tbody.innerHTML = "<tr><td colspan='3' style='text-align:center;'>Loading...</td></tr>";
        
        try {
            const snap = await getDocs(collection(db, COLLECTION_NAME));
            let data = [];
            snap.forEach(d => data.push(d.data()));
            if(data.length === 0) { tbody.innerHTML = "<tr><td colspan='3' style='text-align:center;'>Kosong</td></tr>"; return; }
            data.sort((a,b) => (a.kelas.localeCompare(b.kelas)) || (parseInt(a.absen) - parseInt(b.absen)));
            tbody.innerHTML = "";
            data.forEach(d => {
                tbody.innerHTML += `<tr>
                    <td style="padding:8px; border:1px solid #ddd;"><b>${d.nama}</b><br><small style="color:gray">${d.waktu.split(',')[1]||''}</small></td>
                    <td style="padding:8px; border:1px solid #ddd;">${d.kelas}</td>
                    <td style="padding:8px; border:1px solid #ddd; text-align:center;"><b>${d.nilai}</b></td>
                </tr>`;
            });
        } catch(e) { tbody.innerHTML = "<tr><td colspan='3'>Error</td></tr>"; }
    }

    window.hapusData = async function() {
        if(!auth.currentUser) return;
        if(confirm("HAPUS SEMUA DATA PERMANEN?")) {
            document.getElementById('loader').style.display = 'flex';
            const snap = await getDocs(collection(db, COLLECTION_NAME));
            await Promise.all(snap.docs.map(d => deleteDoc(d.ref)));
            renderTabelNilai();
            document.getElementById('loader').style.display = 'none';
            alert("Data terhapus.");
        }
    }

    window.downloadCSV = async function() {
        if(!auth.currentUser) return;
        const snap = await getDocs(collection(db, COLLECTION_NAME));
        let data = [];
        snap.forEach(d => data.push(d.data()));
        if(data.length === 0) return alert("Data kosong");
        data.sort((a,b) => (a.kelas.localeCompare(b.kelas)) || (parseInt(a.absen) - parseInt(b.absen)));
        let csv = "Waktu,Nama,Kelas,Absen,Nilai,Kode\n";
        data.forEach(r => csv += `"${r.waktu}","${r.nama}","${r.kelas}","${r.absen}",${r.nilai},"${r.kode}"\n`);
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob(["\uFEFF"+csv], {type: 'text/csv;charset=utf-8;'}));
        a.download = `Nilai_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
    }

    startApp();

    setInterval(() => {
        if(document.documentElement.classList.contains('translated-ltr') || document.documentElement.classList.contains('translated-rtl')) {
            alert("Matikan Auto Translate!"); location.reload();
        }
    }, 1000);
</script>
</body>
</html>
