<!DOCTYPE html>
<!-- Tambahkan translate="no" dan class="notranslate" di sini -->
<html lang="en" translate="no" class="notranslate">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="google" content="notranslate">
    <title>Ujian Sekolah (Remedial Support)</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #3730a3;
            --secondary: #4338ca;
            --bg: #f8fafc;
            --text: #1f2937;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --touch-highlight: #e0e7ff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); color: var(--text); margin: 0; padding: 0; line-height: 1.5;
            /* FITUR TETAP AKTIF: User Select None */
            user-select: none; -webkit-user-select: none; top: 0 !important;
        }
        .skiptranslate { display: none !important; }

        .container {
            width: 100%; max-width: 600px; margin: 0 auto; background: var(--bg);
            padding: 0 0 80px 0; min-height: 100vh;
        }

        /* HEADER */
        .header {
            background: white; padding: 12px 15px; position: relative; z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px;
        }
        .header-left { display: flex; align-items: center; gap: 10px; flex: 1; }
        .school-logo { width: 45px; height: 45px; object-fit: cover; border-radius: 50%; border: 2px solid var(--border); }
        .header-text h1 { margin: 0; font-size: 1rem; font-weight: 700; line-height: 1.2; }
        .header-text p { margin: 2px 0 0 0; font-size: 0.75rem; color: #64748b; }

        /* DATA DIRI */
        .identity-box {
            background: white; margin: 15px; padding: 20px; border-radius: 12px;
            border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }
        .identity-box h3 { margin-top: 0; font-size: 1.1rem; color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-row { display: flex; gap: 10px; }
        .form-row .form-group { flex: 1; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 0.9rem; font-weight: 600; color: #475569; }
        .form-group input, .form-group select {
            width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px;
            font-size: 1rem; background: #f8fafc; transition: border-color 0.2s;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

        /* SOAL CARDS */
        .question-card {
            background: white; margin: 15px; padding: 20px; border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03); border: 1px solid var(--border);
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .question-card.unanswered { border: 2px solid #ef4444; background-color: #fff1f2; }
        .question-text { font-size: 1.05rem; font-weight: 600; margin-bottom: 15px; color: #1e293b; }
        .reading-text {
            background-color: #f1f5f9; border-left: 4px solid var(--primary); padding: 12px;
            margin-bottom: 15px; font-size: 0.95rem; font-style: italic; color: #334155;
            white-space: pre-line; border-radius: 0 8px 8px 0;
        }
        .question-img { max-width: 100%; height: auto; border-radius: 8px; border: 1px solid var(--border); margin: 10px 0; }

        /* OPSI JAWABAN */
        .options { display: flex; flex-direction: column; gap: 10px; }
        .options label {
            display: flex; align-items: center; padding: 12px 15px; background: #ffffff;
            border: 1px solid #cbd5e1; border-radius: 10px; cursor: pointer;
            transition: all 0.2s; font-size: 0.95rem; min-height: 48px;
        }
        .options label:active { background-color: var(--touch-highlight); transform: scale(0.98); }
        .options input[type="radio"] { width: 20px; height: 20px; margin-right: 12px; accent-color: var(--primary); }
        /* Style huruf opsi (A, B, C...) */
        .opt-label { font-weight: bold; margin-right: 8px; min-width: 20px; color: var(--primary); }
        .options label:has(input:checked) { background-color: #eef2ff; border-color: var(--primary); }

        /* BUTTONS & MODALS */
        .btn-submit {
            display: block; width: calc(100% - 30px); margin: 25px auto; background: var(--primary);
            color: white; border: none; padding: 16px; font-size: 1.1rem; font-weight: bold;
            border-radius: 12px; cursor: pointer; box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3);
            transition: transform 0.1s, background 0.2s;
        }
        .btn-submit:active { transform: scale(0.97); background: var(--primary-dark); }

        #result-area, #locked-screen {
            margin: 20px 15px; padding: 25px 20px; background: white; border-radius: 16px;
            text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        #locked-screen { border: 2px solid #e11d48; background: #fff1f2; }
        
        .result-card {
            background: #f8fafc; border: 1px solid #cbd5e1; padding: 15px;
            border-radius: 12px; margin-top: 15px; text-align: left;
        }
        .result-table td { padding: 8px 0; font-size: 0.95rem; }
        .result-table td:first-child { width: 100px; color: #64748b; }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); display: none; justify-content: center;
            align-items: center; z-index: 10000; font-weight: bold; color: var(--primary);
            flex-direction: column;
            text-align: center;
            padding: 20px;
        }
        
        /* RULE OVERLAY STYLES */
        #rule-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 20000; display: flex; 
            justify-content: center; align-items: center; padding: 20px;
        }
        .rule-box {
            max-width: 500px; width: 100%;
            background: white;
            text-align: center;
        }
        .rule-list {
            text-align: left;
            margin: 20px 0;
            background: #fff1f2;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #fda4af;
        }
        .rule-list li { margin-bottom: 10px; color: #881337; font-weight: 500; }

        .spinner {
            width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #admin-panel { padding: 15px; background: white; margin-bottom: 50px; display: none; }
        .admin-controls button { display: block; width: 100%; margin-bottom: 10px; padding: 12px; }
        
        /* Empty State */
        .empty-state { text-align: center; color: #94a3b8; padding: 40px 20px; font-style: italic;}
        
        /* Admin Mapel List */
        .mapel-schedule-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-bottom: 1px solid #e2e8f0;
        }
        .mapel-schedule-item:last-child { border-bottom: none; }
        .mapel-name { font-weight: 600; font-size: 0.9rem; color: #334155; }
        
        /* Visibilitas Toggle Button */
        .btn-vis-toggle {
            background: transparent; border: 1px solid #cbd5e1; border-radius: 4px;
            cursor: pointer; font-size: 1rem; padding: 4px 8px; margin-right: 5px;
            transition: all 0.2s;
        }
        .btn-vis-toggle:hover { background: #f1f5f9; }
        .btn-vis-toggle.hidden-mapel { background: #fee2e2; border-color: #ef4444; opacity: 0.7; }
    </style>
</head>
<!-- FITUR TETAP AKTIF: Blokir Klik Kanan -->
<body oncontextmenu="return false;">

<!-- RULE OVERLAY (PERINGATAN AWAL) -->
<div id="rule-overlay">
    <div class="rule-box">
        <img src="https://cdn-icons-png.flaticon.com/512/1000/1000997.png" alt="Warning" style="width: 80px; margin-bottom: 15px;">
        <h2 style="color: #be123c; margin: 0 0 10px 0;">PERATURAN UJIAN</h2>
        <p style="color: #4b5563;">Harap baca aturan berikut sebelum memulai.</p>
        
        <ul class="rule-list">
            <!-- FITUR DIMATIKAN: Larangan Tab Lain dihapus dari list -->
            <li>üìç <b>Wajib berada di lingkungan sekolah</b>. GPS akan dicek.</li>
            <li>üëÄ <b>Perhatian:</b> Membuka tab lain diperbolehkan.</li>
            <li>üíæ Jawaban tersimpan saat <b>Refresh</b>, tapi <b>HILANG</b> jika tab/browser <b>DITUTUP</b>.</li>
        </ul>

        <button onclick="acceptRules()" class="btn-submit" style="background: #059669; margin-top: 0;">
            SAYA MENGERTI & MULAI
        </button>
    </div>
</div>

<div id="loader" class="loading-overlay">
    <div class="spinner"></div>
    <div id="loader-text">Sedang memproses...</div>
</div>

<div class="container">
    <div class="header">
        <div class="header-left">
            <img src="https://raw.githubusercontent.com/atha-cyber/logo-/5eeaaecc00cf02080842f1cd6f4fc7bf13fe7f18/images.jfif" alt="Logo" class="school-logo">
            <div class="header-text">
                <h1>SMP NEGERI 4 PANDAK</h1>
                <p>Remedial & Asesmen Sumatif</p>
            </div>
        </div>
    </div>

    <!-- IDENTITAS -->
    <div class="identity-box">
        <h3>üìã Data Diri Siswa</h3>
        
        <div class="form-group" style="background: #e0f2fe; padding: 10px; border-radius: 8px; border: 1px solid #bae6fd;">
            <label style="color: #0284c7;">Pilih Mata Pelajaran (Sesuai Jadwal)</label>
            <!-- ID mapel-select-container digunakan untuk manipulasi DOM -->
            <select id="examLevel" onchange="changeExamLevel(this.value)" style="border-color: #0284c7; font-weight: bold; color: #0369a1;">
                <option value="">-- Pilih Paket Soal --</option>
                
                <!-- SELASA 9 DESEMBER -->
                <optgroup label="SELASA - Pend. Agama & Budi Pekerti (PABP)" data-mapel="PABP">
                    <option value="7-PABP">Kelas 7 - PABP</option>
                    <option value="8-PABP">Kelas 8 - PABP</option>
                    <option value="9-PABP">Kelas 9 - PABP</option>
                </optgroup>
                <optgroup label="SELASA - Informatika" data-mapel="INFO">
                    <option value="7-INFO">Kelas 7 - Informatika</option>
                    <option value="8-INFO">Kelas 8 - Informatika</option>
                    <option value="9-INFO">Kelas 9 - Informatika</option>
                </optgroup>
                <optgroup label="SELASA - Bahasa Indonesia" data-mapel="INDO">
                    <option value="7-INDO">Kelas 7 - Bahasa Indonesia</option>
                    <option value="8-INDO">Kelas 8 - Bahasa Indonesia</option>
                    <option value="9-INDO">Kelas 9 - Bahasa Indonesia</option>
                </optgroup>
                <optgroup label="SELASA - Pend. Pancasila (PKN)" data-mapel="PKN">
                    <option value="7-PKN">Kelas 7 - PKN</option>
                    <option value="8-PKN">Kelas 8 - PKN</option>
                    <option value="9-PKN">Kelas 9 - PKN</option>
                </optgroup>

                <!-- RABU 10 DESEMBER -->
                <optgroup label="RABU - Matematika" data-mapel="MTK">
                    <option value="7-MTK">Kelas 7 - Matematika</option>
                    <option value="8-MTK">Kelas 8 - Matematika</option>
                    <option value="9-MTK">Kelas 9 - Matematika</option>
                </optgroup>
                <optgroup label="RABU - PJOK" data-mapel="PJOK">
                    <option value="7-PJOK">Kelas 7 - PJOK</option>
                    <option value="8-PJOK">Kelas 8 - PJOK</option>
                    <option value="9-PJOK">Kelas 9 - PJOK</option>
                </optgroup>
                <optgroup label="RABU - Bahasa Inggris" data-mapel="ING">
                    <option value="7-ING">Kelas 7 - Bahasa Inggris</option>
                    <option value="8-ING">Kelas 8 - Bahasa Inggris</option>
                    <option value="9-ING">Kelas 9 - Bahasa Inggris</option>
                </optgroup>
                <optgroup label="RABU - Bahasa Jawa" data-mapel="BJAWA">
                    <option value="7-BJAWA">Kelas 7 - Bahasa Jawa</option>
                    <option value="8-BJAWA">Kelas 8 - Bahasa Jawa</option>
                    <option value="9-BJAWA">Kelas 9 - Bahasa Jawa</option>
                </optgroup>

                <!-- KAMIS 11 DESEMBER -->
                <optgroup label="KAMIS - IPA" data-mapel="IPA">
                    <option value="7-IPA">Kelas 7 - IPA</option>
                    <option value="8-IPA">Kelas 8 - IPA</option>
                    <option value="9-IPA">Kelas 9 - IPA</option>
                </optgroup>
                <optgroup label="KAMIS - IPS" data-mapel="IPS">
                    <option value="7-IPS">Kelas 7 - IPS</option>
                    <option value="8-IPS">Kelas 8 - IPS</option>
                    <option value="9-IPS">Kelas 9 - IPS</option>
                </optgroup>
                <optgroup label="KAMIS - Seni Budaya" data-mapel="SENBUD">
                    <option value="7-SENBUD">Kelas 7 - Seni Budaya</option>
                    <option value="8-SENBUD">Kelas 8 - Seni Budaya</option>
                    <option value="9-SENBUD">Kelas 9 - Seni Budaya</option>
                </optgroup>

            </select>
        </div>

        <div class="form-group">
            <label>Nama Lengkap</label>
            <input type="text" id="studentName" placeholder="Nama Lengkap..." autocomplete="off" required>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Kelas Rinci</label>
                <input type="text" id="studentClass" placeholder="Contoh: 7A / 8B" autocomplete="off" required>
            </div>
            <div class="form-group">
                <label>Absen</label>
                <input type="number" id="studentAbsen" placeholder="No." autocomplete="off" required>
            </div>
        </div>
    </div>

    <form id="examForm" onsubmit="event.preventDefault(); gradeExam();" autocomplete="off">
        <div id="questions-container">
            <div class="empty-state">
                üëÜ Silakan pilih <b>Paket Soal</b> pada kolom di atas untuk memunculkan soal.
            </div>
        </div>
        
        <button type="button" id="btn-done" class="btn-submit" onclick="gradeExam()" style="display:none;">Selesai & Kumpulkan Jawaban</button>
    </form>

    <!-- LAYAR TERKUNCI (HASIL) -->
    <div id="locked-screen" style="display:none;">
        <div style="font-size: 3rem; margin-bottom: 10px;">üîí</div>
        <h2 style="color:#be123c; margin-top:0;">Ujian Selesai!</h2>
        <p style="font-size:1rem; margin-bottom:20px; color: #4b5563;">
            Jawaban Anda telah tersimpan di server.
        </p>
        
        <button onclick="resetSession()" style="background:#059669; color:white; border:none; padding:12px 25px; font-size:1rem; font-weight:bold; border-radius:8px; cursor:pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%;">
            üîÑ Selesai & Reset (Siswa Baru)
        </button>
    </div>

    <!-- HASIL (HIDDEN) -->
    <div id="result-area" style="display:none;">
        <h2 style="color:var(--primary);">Hasil Ujian</h2>
        <div class="result-card">
            <table class="result-table" style="width:100%;">
                <tr><td>Nama Siswa</td><td>: <span id="res-nama" style="font-weight:600;"></span></td></tr>
                <tr><td>Paket/Kelas</td><td>: <span id="res-kelas"></span></td></tr>
                <tr><td>No. Absen</td><td>: <span id="res-absen"></span></td></tr>
                <tr><td>Nilai Akhir</td><td>: <span id="res-nilai" style="font-weight:bold; color:#059669; font-size:1.4rem;"></span></td></tr>
            </table>
            <div style="margin-top: 15px; border-top: 1px dashed #cbd5e1; padding-top: 10px; font-size: 0.8rem; text-align: center; color: #94a3b8;">
                Validasi: <span id="res-kode" style="font-family: monospace;"></span>
            </div>
        </div>
        <p id="feedback-text" style="font-weight:bold; margin-top:20px;">Nilai Anda belum mencukupi.</p>
        
        <button onclick="resetSession()" style="background:#6b7280; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; margin-top:20px;">
            Keluar & Reset
        </button>
    </div>

    <!-- ADMIN -->
    <div id="admin-panel">
        <div class="admin-controls">
            <h3 style="color:#b91c1c; margin-top:0;">üîê Database Guru</h3>
            
            <!-- SECTION GLOBAL MODE TRYOUT -->
            <div style="background: #ecfdf5; border: 1px solid #6ee7b7; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h4 style="margin:0; color: #047857;">üöÄ Mode Tryout (Global)</h4>
                        <small style="color:#065f46;">Abaikan jadwal & radius, buka semua.</small>
                    </div>
                    <button id="btn-tryout-toggle" onclick="toggleTryoutMode()" style="padding:10px 20px; border-radius:20px; font-weight:bold; border:none; cursor:pointer; background:#e5e7eb; color:#374151;">Memuat...</button>
                </div>
            </div>

            <!-- SECTION RADIUS CHECK -->
            <div style="background: #fff7ed; border: 1px solid #fdba74; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h4 style="margin:0; color: #c2410c;">üì° Cek Lokasi (Anti-Joki)</h4>
                        <small style="color:#9a3412;">Wajib radius 400m dari sekolah.</small>
                    </div>
                    <button id="btn-radius-toggle" onclick="toggleRadiusMode()" style="padding:10px 20px; border-radius:20px; font-weight:bold; border:none; cursor:pointer; background:#e5e7eb; color:#374151;">Memuat...</button>
                </div>
                <div style="font-size:0.75rem; color:#c2410c; margin-top:5px;">
                    Matikan fitur ini jika GPS error atau cuaca buruk.
                </div>
            </div>

            <!-- SECTION AUTO JADWAL -->
            <div style="background: #fdf2f8; border: 1px solid #fbcfe8; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="margin:0 0 5px 0; color: #db2777;">ü§ñ Auto-Jadwal PDF</h4>
                <p style="font-size:0.8rem; color:#9d174d; margin-bottom:10px;">
                    Klik tombol ini untuk mengatur <b>Semua Jadwal</b> sesuai PDF Remedial (9-11 Des 2025).
                </p>
                <button onclick="setJadwalSesuaiPDF()" style="background:#be185d; color:white; border:none; padding:10px; width:100%; border-radius:6px; font-weight:bold; cursor:pointer;">
                    üìÖ Set Jadwal Default Sesuai PDF
                </button>
            </div>

            <!-- SECTION BANK SOAL -->
            <div style="background: #fdf4ff; border: 1px solid #f0abfc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="margin:0 0 10px 0; color: #a21caf;">üìö Manajemen Bank Soal</h4>
                <p style="font-size:0.8rem; color:#86198f; margin-bottom:10px;">
                    Upload soal custom untuk menggantikan soal bawaan. Soal tersimpan permanen di server.
                </p>
                
                <select id="admin-soal-mapel" onchange="cekStatusSoalCustom(this.value)" style="width:100%; padding:8px; margin-bottom:10px; border:1px solid #d8b4fe; border-radius:6px;">
                    <option value="">-- Pilih Mapel untuk Diatur --</option>
                    <!-- Options populated by JS -->
                </select>

                <div id="status-soal-custom" style="font-size:0.8rem; margin-bottom:5px; font-weight:bold; color: #6b7280;">Silakan pilih mapel terlebih dahulu.</div>

                <!-- NEW: TEXT TO JSON CONVERTER -->
                <details style="margin-bottom:15px; background:white; padding:10px; border-radius:6px; border:1px dashed #a21caf;">
                    <summary style="cursor:pointer; color:#a21caf; font-weight:bold;">üõ†Ô∏è Konverter Teks ke JSON (Mudah)</summary>
                    <p style="font-size:0.75rem; color:#64748b; margin:5px 0;">
                        <b>Format Teks:</b><br>
                        1. Pertanyaan...<br>
                        Gambar: https://link-gambar.com/foto.jpg<br>
                        A. Pilihan A...<br>
                        B. Pilihan B...<br>
                        Kunci: A
                    </p>
                    <textarea id="raw-soal-text" rows="6" placeholder="Paste soal dari Word/WA di sini..." style="width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:6px; font-size:0.8rem;"></textarea>
                    <button onclick="convertTextToJSON()" style="background:#8b5cf6; color:white; border:none; padding:8px; border-radius:6px; width:100%; margin-top:5px; cursor:pointer;">‚ö° Konversi ke JSON (Otomatis)</button>
                </details>

                <textarea id="admin-soal-text" rows="8" placeholder="Kode JSON akan muncul di sini setelah konversi..." style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; font-family:monospace; font-size:0.8rem; white-space: pre; overflow-x: auto;"></textarea>
                
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <button onclick="copyTemplateSoal()" style="background:#64748b; color:white; border:none; padding:8px; border-radius:6px; flex:1; font-size:0.8rem;">üìã Template JSON Manual</button>
                    <button onclick="hapusSoalCustom()" style="background:#ef4444; color:white; border:none; padding:8px; border-radius:6px; flex:1; font-size:0.8rem;">üóëÔ∏è Hapus Soal</button>
                    <button onclick="simpanSoalCustom()" style="background:#059669; color:white; border:none; padding:8px; border-radius:6px; flex:1; font-size:0.8rem;">üíæ Simpan Permanen</button>
                </div>
            </div>

            <!-- SECTION JADWAL & VISIBILITY -->
            <div style="background: #f0f9ff; border: 1px solid #bae6fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="margin:0 0 10px 0; color: #0369a1;">üìÖ Atur Jadwal & Visibilitas</h4>
                <p style="font-size: 0.8rem; color: #64748b; margin-bottom: 10px;">Gunakan icon mata (üëÅÔ∏è) untuk menyembunyikan mapel.</p>
                
                <div id="admin-schedule-list" style="background: white; border: 1px solid #cbd5e1; border-radius: 6px; margin-bottom: 10px;">
                    <div style="padding:10px; text-align:center;">Memuat mapel...</div>
                </div>
            </div>

            <button onclick="downloadCSV()" style="background:#059669; color:white; border:none; border-radius:8px;">üì• Download Excel (Otomatis Urut)</button>
            <button onclick="hapusData()" style="background:#dc2626; color:white; border:none; border-radius:8px;">üóëÔ∏è Hapus Semua Data Nilai</button>
            <button onclick="tutupAdmin()" style="background:#6b7280; color:white; border:none; border-radius:8px;">Tutup Panel</button>
        </div>
        <div style="overflow-x:auto; margin-top:15px;">
            <table border="1" style="width:100%; border-collapse:collapse; border-color:#e2e8f0; font-size:0.85rem;">
                <thead><tr style="background:#f1f5f9;"><th style="padding:8px;">Nama</th><th style="padding:8px;">Kls</th><th style="padding:8px;">Nilai</th></tr></thead>
                <tbody id="tabel-nilai"><tr><td colspan='3' style='text-align:center; padding:10px;'>Memuat data...</td></tr></tbody>
            </table>
        </div>
    </div>
    <button onclick="bukaAdmin()" style="position:fixed; bottom:20px; right:20px; background:rgba(255,255,255,0.8); border:1px solid #cbd5e1; font-size:1.5rem; cursor:pointer; border-radius:50%; width:45px; height:45px; z-index:9999; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">üîí</button>
</div>

<!-- LOGIKA APLIKASI -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // --- CONFIG FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyDy6E0FpxFAV8Fq2ayO1UWd2UMC19xLHgM", 
      authDomain: "vooting-guru.firebaseapp.com",
      projectId: "vooting-guru",
      storageBucket: "vooting-guru.firebasestorage.app",
      messagingSenderId: "643701954972",
      appId: "1:643701954972:web:5db3499faeb8ca91919059",
      measurementId: "G-MZV18MY9VM"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // --- KONFIGURASI KOLEKSI ---
    const COLLECTION_NAME = 'exam_results_all_subjects_v2';
    const CONFIG_COLLECTION = 'exam_config';
    const QUESTIONS_COLLECTION = 'exam_question_banks'; // Koleksi baru untuk bank soal custom
    const SCHEDULE_DOC = 'schedule'; 
    const passwordGuru = "!@#$%^&*()"; 

    // --- KONFIGURASI LOKASI SEKOLAH ---
    // 7¬∞55'37.2"S 110¬∞17'52.1"E => Decimal: -7.927000, 110.297806
    const SCHOOL_LAT = -7.927000;
    const SCHOOL_LNG = 110.297806;
    const MAX_DISTANCE_METERS = 400;

    // --- BANK SOAL DEFAULT (DIKOSONGKAN) ---
    // Soal sekarang sepenuhnya bergantung pada upload dari Admin Panel (Firestore)
    const DATA_BANK_SOAL = {};
    
    // --- LIST MAPEL UNTUK ADMIN (Code Suffix -> Nama Tampilan) ---
    // Update untuk Admin Panel
    const DATA_MAPEL = {
        "PABP": "Pend. Agama (PABP)",
        "INFO": "Informatika",
        "INDO": "Bahasa Indonesia",
        "PKN": "Pend. Pancasila (PKN)",
        "MTK": "Matematika",
        "PJOK": "PJOK (Penjasorkes)",
        "ING": "Bahasa Inggris",
        "BJAWA": "Bahasa Jawa",
        "IPA": "Ilmu Pengetahuan Alam (IPA)",
        "IPS": "Ilmu Pengetahuan Sosial (IPS)",
        "SENBUD": "Seni Budaya"
    };

    // --- VARIABEL STATE ---
    let currentLevel = ""; 
    let activeQuestions = []; 
    let isExamFinished = false; 
    let violationCount = 0;
    let isRuleAccepted = false;
    const MAX_VIOLATIONS = 3;
    const storage = sessionStorage; 

    // Kunci Storage
    let STORAGE_KEY = 'exam_data_v2'; 
    let ORDER_KEY = 'exam_order_v2';
    const VIOLATION_KEY = 'exam_violations_v2'; 
    const STATUS_KEY = 'exam_status_v2'; 
    const RULE_ACCEPTED_KEY = 'exam_rule_accepted_v2';
    const LEVEL_KEY = 'exam_selected_level_v2'; 

    // INIT
    async function initAuth() {
        try { await signInAnonymously(auth); } 
        catch (error) { console.error("Login gagal", error); }
    }
    initAuth();

    let currentUser = null;
    onAuthStateChanged(auth, (user) => { if(user) currentUser = user; });

    // --- FUNGSI GLOBAL UTAMA ---
    window.acceptRules = function() {
        isRuleAccepted = true;
        document.getElementById('rule-overlay').style.display = 'none';
        storage.setItem(RULE_ACCEPTED_KEY, 'true');
    }

    // --- FUNGSI GEOLOCATION UTILS ---
    
    // Rumus Haversine untuk hitung jarak dalam Meter
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // Radius bumi dalam meter
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c; // Jarak dalam meter
    }

    // Fungsi utama cek lokasi
    function checkLocationAccess() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                alert("Browser Anda tidak mendukung Geolocation.");
                resolve(false);
                return;
            }

            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loader-text');
            loader.style.display = 'flex';
            loaderText.innerText = "Memeriksa Lokasi GPS...";

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    const distance = calculateDistance(userLat, userLng, SCHOOL_LAT, SCHOOL_LNG);
                    
                    loader.style.display = 'none';
                    loaderText.innerText = "Sedang memproses...";

                    console.log(`Posisi User: ${userLat}, ${userLng} | Jarak: ${distance.toFixed(2)}m`);

                    if (distance <= MAX_DISTANCE_METERS) {
                        resolve(true);
                    } else {
                        alert(`üö´ AKSES DITOLAK!\n\nAnda berada di luar lingkungan sekolah.\nJarak Anda: ${distance.toFixed(0)} meter.\nBatas Maksimal: ${MAX_DISTANCE_METERS} meter.\n\nSilakan mendekat ke area sekolah.`);
                        resolve(false);
                    }
                },
                (error) => {
                    loader.style.display = 'none';
                    loaderText.innerText = "Sedang memproses...";
                    let msg = "Gagal mengambil lokasi.";
                    switch(error.code) {
                        case error.PERMISSION_DENIED: msg = "Izin lokasi ditolak. Wajib aktifkan GPS untuk ujian."; break;
                        case error.POSITION_UNAVAILABLE: msg = "Informasi lokasi tidak tersedia."; break;
                        case error.TIMEOUT: msg = "Waktu permintaan lokasi habis."; break;
                    }
                    alert(`‚ö†Ô∏è ${msg}\nPastikan GPS aktif dan izinkan browser mengakses lokasi.`);
                    resolve(false);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        });
    }

    // --- FUNGSI ADMIN: RENDER LIST JADWAL & STATUS ---
    window.renderAdminScheduleList = async function() {
        const container = document.getElementById('admin-schedule-list');
        const btnTryout = document.getElementById('btn-tryout-toggle');
        const btnRadius = document.getElementById('btn-radius-toggle');
        
        // Populasikan Dropdown Mapel di Bagian Upload Soal
        const selectMapelSoal = document.getElementById('admin-soal-mapel');
        if(selectMapelSoal.children.length <= 1) { // Hanya isi jika belum ada opsi selain default
             // Mendapatkan semua value mapel dari optgroup di dropdown siswa
             const mapelGroups = document.querySelectorAll('#examLevel optgroup');
             mapelGroups.forEach(group => {
                 const label = group.label;
                 const options = group.querySelectorAll('option');
                 options.forEach(opt => {
                     const option = document.createElement('option');
                     option.value = opt.value;
                     option.text = opt.text;
                     selectMapelSoal.appendChild(option);
                 });
             });
        }

        container.innerHTML = "<div style='padding:10px;text-align:center;'>Memuat...</div>";
        
        try {
            // Ambil data jadwal + tryout status + hidden mapel
            const docRef = doc(db, CONFIG_COLLECTION, SCHEDULE_DOC);
            const docSnap = await getDoc(docRef);
            const data = docSnap.exists() ? docSnap.data() : {};
            const hiddenList = data.hiddenMapels || [];

            // 1. UPDATE TOMBOL TRYOUT
            const isTryoutOpen = data.isTryoutOpen === true;
            if(isTryoutOpen) {
                btnTryout.innerText = "SEDANG AKTIF (MATIKAN)";
                btnTryout.style.backgroundColor = "#059669"; 
                btnTryout.style.color = "white";
            } else {
                btnTryout.innerText = "MATI (AKTIFKAN)";
                btnTryout.style.backgroundColor = "#d1d5db"; 
                btnTryout.style.color = "#374151";
            }

            // 2. UPDATE TOMBOL RADIUS
            const isRadiusActive = data.isRadiusActive !== false; 
            if(isRadiusActive) {
                btnRadius.innerText = "ON (AKTIF)";
                btnRadius.style.backgroundColor = "#059669";
                btnRadius.style.color = "white";
            } else {
                btnRadius.innerText = "OFF (MATI)";
                btnRadius.style.backgroundColor = "#ef4444";
                btnRadius.style.color = "white";
            }

            // 3. RENDER JADWAL MAPEL
            container.innerHTML = "";
            for (const [code, name] of Object.entries(DATA_MAPEL)) {
                let val = "";
                if(data[code]) {
                    const d = new Date(data[code]);
                    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                    val = d.toISOString().slice(0, 16);
                }

                const isHidden = hiddenList.includes(code);
                const eyeIcon = isHidden ? "üôà" : "üëÅÔ∏è";
                const hiddenClass = isHidden ? "hidden-mapel" : "";

                container.innerHTML += `
                    <div class="mapel-schedule-item">
                        <div>
                            <div class="mapel-name">${name}</div>
                            <div style="font-size:0.75rem; color:#64748b;">Kode: ${code}</div>
                        </div>
                        <div style="display:flex; gap:5px; align-items:center;">
                            <button onclick="toggleMapelVisibility('${code}')" class="btn-vis-toggle ${hiddenClass}" title="${isHidden ? 'Tampilkan' : 'Sembunyikan'}">
                                ${eyeIcon}
                            </button>
                            <input type="datetime-local" id="time-${code}" value="${val}" style="padding:5px; border:1px solid #cbd5e1; border-radius:4px; font-size:0.8rem;">
                            <button onclick="simpanJadwalMapel('${code}')" style="background:#0284c7; color:white; border:none; padding:5px 10px; border-radius:4px; font-size:0.8rem; cursor:pointer;">Set</button>
                        </div>
                    </div>
                `;
            }
        } catch(e) {
            container.innerHTML = `<div style="color:red; padding:10px;">Gagal memuat: ${e.message}</div>`;
        }
    }

    // --- FUNGSI ADMIN: MANAJEMEN BANK SOAL ---
    
    // Cek Status Soal (Apakah pakai custom atau default/kosong)
    window.cekStatusSoalCustom = async function(mapelCode) {
        const statusDiv = document.getElementById('status-soal-custom');
        const textArea = document.getElementById('admin-soal-text');
        
        if(!mapelCode) {
            statusDiv.innerHTML = "Silakan pilih mapel terlebih dahulu.";
            statusDiv.style.color = "#6b7280";
            textArea.value = "";
            return;
        }

        statusDiv.innerHTML = "Memeriksa...";
        
        try {
            const docRef = doc(db, QUESTIONS_COLLECTION, mapelCode);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                statusDiv.innerHTML = "‚úÖ Menggunakan Soal Custom (Permanen)";
                statusDiv.style.color = "#059669";
                // Tampilkan isi soal di textarea untuk diedit
                const data = docSnap.data();
                if(data.questions) {
                    textArea.value = JSON.stringify(data.questions, null, 2);
                }
            } else {
                statusDiv.innerHTML = "‚ö†Ô∏è Belum ada soal (Kosong). Silakan upload JSON.";
                statusDiv.style.color = "#ef4444";
                textArea.value = ""; 
            }
        } catch (e) {
            statusDiv.innerHTML = "Gagal cek status: " + e.message;
            statusDiv.style.color = "red";
        }
    }

    // Template Soal
    window.copyTemplateSoal = function() {
        const template = [
            {
                "id": 101,
                "tanya": "Tulis pertanyaan di sini...",
                "opsi": {
                    "A": "Pilihan A",
                    "B": "Pilihan B",
                    "C": "Pilihan C",
                    "D": "Pilihan D"
                },
                "kunci": "A",
                "bacaan": "Teks bacaan opsional (kosongkan jika tidak ada)",
                "gambar": "URL gambar opsional"
            },
            {
                "id": 102,
                "tanya": "Pertanyaan kedua...",
                "opsi": {"A": "1", "B": "2", "C": "3", "D": "4"},
                "kunci": "B"
            }
        ];
        document.getElementById('admin-soal-text').value = JSON.stringify(template, null, 2);
    }

    // New Function: Convert Raw Text to JSON
    window.convertTextToJSON = function() {
        const rawText = document.getElementById('raw-soal-text').value;
        if(!rawText.trim()) return alert("Tempelkan teks soal dulu!");

        const result = [];
        let idCounter = 101;
        
        // Split by lines
        const lines = rawText.split('\n');
        let currentQ = null;

        lines.forEach(line => {
            line = line.trim();
            if(!line) return;

            // 1. Detect Question Start (starts with digit and dot or paren)
            if (/^\d+[\.|)]/.test(line)) {
                if(currentQ) result.push(currentQ); // Push prev question if exists
                currentQ = {
                    id: idCounter++,
                    tanya: line.replace(/^\d+[\.|)]\s*/, ''), // Remove numbering
                    opsi: {},
                    kunci: 'A', // Default key
                    gambar: '' // Default no image
                };
            } 
            // 2. Detect Image (starts with Gambar: or Img:)
            else if (/^(?:Gambar|Img|Image)\s*:/i.test(line)) {
                if(currentQ) {
                    const url = line.replace(/^(?:Gambar|Img|Image)\s*:\s*/i, '').trim();
                    if(url) currentQ.gambar = url;
                }
            }
            // 3. Detect Option (starts with A-E and dot or paren)
            else if (/^[A-E][\.|)]/.test(line.toUpperCase())) {
                if(currentQ) {
                    const parts = line.match(/^([A-E])[\.|)]\s*(.+)/i);
                    if(parts) {
                        const label = parts[1].toUpperCase();
                        const val = parts[2];
                        currentQ.opsi[label] = val;
                    }
                }
            }
            // 4. Detect Key (starts with Kunci/Jawab/Answer/Key)
            else if (/^(?:Kunci|Key|Jawab|Ans)/i.test(line)) {
                if(currentQ) {
                    const parts = line.match(/([A-E])/i); 
                    if(parts) currentQ.kunci = parts[1].toUpperCase();
                }
            }
            // 5. Append multiline question text (if strictly not option/key/image pattern and question exists)
            else if (currentQ && Object.keys(currentQ.opsi).length === 0) {
                 // Check if it looks like an option to avoid false positives? 
                 // The regex in #3 handles A-E options. If it doesn't match that, it's text.
                 currentQ.tanya += " " + line;
            }
        });
        
        // Push the last question
        if(currentQ) result.push(currentQ);

        if(result.length === 0) return alert("Gagal mendeteksi format. Pastikan format: No. Pertanyaan, lalu A. Opsi...");

        // Output to main JSON textarea
        document.getElementById('admin-soal-text').value = JSON.stringify(result, null, 2);
        alert(`Berhasil mengonversi ${result.length} soal! Silakan cek di kotak bawah dan Simpan Permanen.`);
    }

    // Simpan Soal Custom
    window.simpanSoalCustom = async function() {
        const mapelCode = document.getElementById('admin-soal-mapel').value;
        const jsonText = document.getElementById('admin-soal-text').value;

        if(!mapelCode) return alert("Pilih Mapel dulu!");
        if(!jsonText.trim()) return alert("Isi JSON soal dulu!");

        try {
            const questions = JSON.parse(jsonText);
            if(!Array.isArray(questions)) throw new Error("Format harus berupa Array [...]");
            
            // Validasi sederhana
            if(questions.length > 0 && (!questions[0].id || !questions[0].tanya || !questions[0].opsi || !questions[0].kunci)) {
                if(!confirm("Format soal sepertinya tidak lengkap. Tetap simpan?")) return;
            }

            await setDoc(doc(db, QUESTIONS_COLLECTION, mapelCode), { questions: questions });
            alert("‚úÖ Soal berhasil disimpan permanen!");
            cekStatusSoalCustom(mapelCode); // Refresh status
        } catch(e) {
            alert("‚ùå Gagal Simpan: JSON tidak valid!\n" + e.message);
        }
    }

    // Hapus Soal Custom (Reset ke Kosong)
    window.hapusSoalCustom = async function() {
        const mapelCode = document.getElementById('admin-soal-mapel').value;
        if(!mapelCode) return alert("Pilih Mapel dulu!");

        if(confirm("Hapus soal dari server? Mapel ini akan menjadi KOSONG.")) {
            try {
                await deleteDoc(doc(db, QUESTIONS_COLLECTION, mapelCode));
                alert("Soal dihapus. Sekarang kosong.");
                cekStatusSoalCustom(mapelCode);
            } catch(e) {
                alert("Gagal hapus: " + e.message);
            }
        }
    }

    // --- FUNGSI ADMIN: TOGGLE VISIBILITY MAPEL ---
    window.toggleMapelVisibility = async function(mapelCode) {
        try {
            const docRef = doc(db, CONFIG_COLLECTION, SCHEDULE_DOC);
            const docSnap = await getDoc(docRef);
            let hiddenList = [];
            if(docSnap.exists() && docSnap.data().hiddenMapels) {
                hiddenList = docSnap.data().hiddenMapels;
            }

            if(hiddenList.includes(mapelCode)) {
                // Remove from hidden list (Show)
                hiddenList = hiddenList.filter(c => c !== mapelCode);
            } else {
                // Add to hidden list (Hide)
                hiddenList.push(mapelCode);
            }

            await setDoc(docRef, { hiddenMapels: hiddenList }, { merge: true });
            renderAdminScheduleList(); // Refresh admin view
        } catch(e) {
            alert("Gagal update visibilitas: " + e.message);
        }
    }

    // --- FUNGSI ADMIN: TOGGLE TRYOUT MODE ---
    window.toggleTryoutMode = async function() {
        const btn = document.getElementById('btn-tryout-toggle');
        const isCurrentlyActive = btn.innerText.includes("SEDANG AKTIF");
        const newState = !isCurrentlyActive;

        btn.innerText = "Menyimpan...";
        try {
            await setDoc(doc(db, CONFIG_COLLECTION, SCHEDULE_DOC), { isTryoutOpen: newState }, { merge: true });
            renderAdminScheduleList();
            alert(newState ? "MODE TRYOUT AKTIF! Semua soal terbuka & Radius Bypass." : "MODE TRYOUT MATI. Jadwal & Radius berlaku kembali.");
        } catch(e) {
            alert("Gagal update: " + e.message);
            renderAdminScheduleList();
        }
    }

    // --- FUNGSI ADMIN: TOGGLE RADIUS MODE ---
    window.toggleRadiusMode = async function() {
        const btn = document.getElementById('btn-radius-toggle');
        const isCurrentlyActive = btn.innerText.includes("ON");
        const newState = !isCurrentlyActive; 

        btn.innerText = "Menyimpan...";
        try {
            await setDoc(doc(db, CONFIG_COLLECTION, SCHEDULE_DOC), { isRadiusActive: newState }, { merge: true });
            renderAdminScheduleList();
            alert(newState ? "RADIUS CHECK AKTIF. Siswa wajib di sekolah." : "RADIUS CHECK MATI. Siswa bebas akses dari mana saja.");
        } catch(e) {
            alert("Gagal update: " + e.message);
            renderAdminScheduleList();
        }
    }
    
    // --- FUNGSI ADMIN: SET JADWAL SESUAI PDF ---
    window.setJadwalSesuaiPDF = async function() {
        if(!confirm("Yakin ingin mereset SEMUA jadwal mapel sesuai PDF Remedial?")) return;
        
        const S_PABP = "2025-12-09T07:30:00+07:00";
        const S_INFO = "2025-12-09T08:30:00+07:00";
        const S_INDO = "2025-12-09T10:00:00+07:00";
        const S_PKN  = "2025-12-09T11:00:00+07:00";
        const R_MTK   = "2025-12-10T07:30:00+07:00";
        const R_PJOK  = "2025-12-10T08:30:00+07:00";
        const R_ING   = "2025-12-10T10:00:00+07:00";
        const R_BJAWA = "2025-12-10T11:00:00+07:00";
        const K_IPA    = "2025-12-11T07:30:00+07:00";
        const K_IPS    = "2025-12-11T08:30:00+07:00";
        const K_SENBUD = "2025-12-11T10:00:00+07:00";

        const updateData = {
            "PABP": S_PABP, "INFO": S_INFO, "INDO": S_INDO, "PKN": S_PKN,
            "MTK": R_MTK, "PJOK": R_PJOK, "ING": R_ING, "BJAWA": R_BJAWA,
            "IPA": K_IPA, "IPS": K_IPS, "SENBUD": K_SENBUD
        };

        try {
            await setDoc(doc(db, CONFIG_COLLECTION, SCHEDULE_DOC), updateData, { merge: true });
            renderAdminScheduleList();
            alert("‚úÖ Jadwal Berhasil Diatur Sesuai PDF (9-11 Des 2025)!");
        } catch(e) {
            alert("Gagal setting jadwal: " + e.message);
        }
    }

    // Simpan jadwal per mapel
    window.simpanJadwalMapel = async function(mapelCode) {
        const timeVal = document.getElementById(`time-${mapelCode}`).value;
        const updateData = {};
        if(timeVal) updateData[mapelCode] = new Date(timeVal).toISOString();
        else updateData[mapelCode] = null; 

        try {
            await setDoc(doc(db, CONFIG_COLLECTION, SCHEDULE_DOC), updateData, { merge: true });
            alert(`Jadwal ${DATA_MAPEL[mapelCode]} Berhasil Disimpan!`);
        } catch(e) {
            alert("Gagal menyimpan jadwal: " + e.message);
        }
    }

    // --- FUNGSI CEK JADWAL & LOKASI & VISIBILITAS ---
    async function checkExamRequirements(levelVal) {
        if(!levelVal) return true;

        const mapelCode = levelVal.split('-')[1]; 
        
        try {
            const snap = await getDoc(doc(db, CONFIG_COLLECTION, SCHEDULE_DOC));
            if(snap.exists()) {
                const data = snap.data();

                // 0. CEK VISIBILITAS MAPEL (Jika di-hide admin, tolak akses)
                const hiddenList = data.hiddenMapels || [];
                if(hiddenList.includes(mapelCode)) {
                    // Force reset selection
                    document.getElementById('examLevel').value = "";
                    document.getElementById('questions-container').innerHTML = 
                        '<div class="empty-state" style="color:#ef4444;">üö´ Soal ini sedang disembunyikan oleh Guru.</div>';
                    document.getElementById('btn-done').style.display = 'none';
                    return false;
                }

                // 1. CEK GLOBAL TRYOUT MODE (BYPASS SEMUA)
                if(data.isTryoutOpen === true) {
                    return true; 
                }

                // 2. CEK RADIUS / LOKASI (BARU)
                const isRadiusCheckActive = data.isRadiusActive !== false;
                if (isRadiusCheckActive) {
                    const allowed = await checkLocationAccess();
                    if (!allowed) {
                        document.getElementById('examLevel').value = "";
                        document.getElementById('questions-container').innerHTML = 
                            '<div class="empty-state" style="color:#ef4444;">üö´ Akses Ditolak: Ujian harus Dilingkungan Sekolah.</div>';
                        document.getElementById('btn-done').style.display = 'none';
                        return false;
                    }
                }

                // 3. CEK JADWAL WAKTU
                const startTimeStr = data[mapelCode];
                if(startTimeStr) {
                    const start = new Date(startTimeStr);
                    const now = new Date();
                    
                    if(now < start) {
                        const options = { 
                            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', 
                            hour: '2-digit', minute: '2-digit', 
                            timeZone: 'Asia/Jakarta', timeZoneName: 'short' 
                        };
                        const dateString = start.toLocaleString('id-ID', options);
                        const mapelName = DATA_MAPEL[mapelCode] || mapelCode;

                        document.getElementById('questions-container').innerHTML = `
                            <div style="text-align:center; padding:40px; background:#fff7ed; border-radius:12px; border:1px solid #fdba74;">
                                <h2 style="color:#c2410c; margin-top:0;">‚è≥ Ujian Belum Dimulai</h2>
                                <p style="color:#9a3412;">Mata Pelajaran: <b>${mapelName}</b></p>
                                <p style="color:#9a3412;">Silakan kembali pada:</p>
                                <h3 style="color:#ea580c; margin:10px 0; font-size:1.2rem;">${dateString}</h3>
                                <p style="font-size:0.8rem; color:#7c2d12;">Sistem akan membuka soal secara otomatis.</p>
                            </div>
                        `;
                        document.getElementById('btn-done').style.display = 'none';
                        return false; 
                    }
                }
            }
        } catch(e) { console.error("Error checking requirements", e); }
        return true; 
    }

    // --- FUNGSI SYNC PILIHAN MAPEL (STUDENT SIDE) ---
    async function syncMapelOptions() {
        try {
            const snap = await getDoc(doc(db, CONFIG_COLLECTION, SCHEDULE_DOC));
            if(snap.exists()) {
                const data = snap.data();
                const hiddenList = data.hiddenMapels || [];
                
                // Cari semua optgroup
                const groups = document.querySelectorAll('#examLevel optgroup');
                groups.forEach(group => {
                    const mapelCode = group.getAttribute('data-mapel');
                    if (mapelCode && hiddenList.includes(mapelCode)) {
                        group.style.display = 'none'; // Sembunyikan jika ada di list hidden
                    } else {
                        group.style.display = ''; // Tampilkan default
                    }
                });
            }
        } catch(e) {
            console.log("Gagal sync mapel options", e);
        }
    }

    // --- FUNGSI GANTI PAKET SOAL ---
    window.changeExamLevel = async function(levelVal) {
        if(!levelVal) {
            document.getElementById('questions-container').innerHTML = 
                '<div class="empty-state">üëÜ Silakan pilih <b>Paket Soal</b> pada kolom di atas.</div>';
            document.getElementById('btn-done').style.display = 'none';
            currentLevel = "";
            return;
        }

        // 1. CEK SYARAT (LOKASI & WAKTU & VISIBILITAS)
        document.getElementById('questions-container').innerHTML = '<div class="empty-state">‚è≥ Memeriksa lokasi & jadwal...</div>';
        
        const isAllowed = await checkExamRequirements(levelVal);
        
        if(!isAllowed) {
             currentLevel = ""; 
             return;
        }

        if(currentLevel !== "" && currentLevel !== levelVal) {
            const confirmChange = confirm("Mengganti paket soal akan mereset jawaban yang sudah diisi. Lanjutkan?");
            if(!confirmChange) {
                document.getElementById('examLevel').value = currentLevel;
                return;
            }
            storage.removeItem(STORAGE_KEY);
            storage.removeItem(ORDER_KEY);
        }

        currentLevel = levelVal;
        storage.setItem(LEVEL_KEY, currentLevel);
        
        // --- LOGIKA LOAD SOAL (DEFAULT VS CUSTOM) ---
        // Karena DATA_BANK_SOAL sudah dikosongkan, defaultnya adalah Array Kosong
        let bankSoal = DATA_BANK_SOAL[currentLevel] || [];

        // Cek ke Firestore jika ada soal custom untuk level ini
        try {
            // Gunakan levelVal (contoh: "7-IPA") sebagai ID dokumen
            const docRef = doc(db, QUESTIONS_COLLECTION, levelVal);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists() && docSnap.data().questions) {
                console.log("Menggunakan soal custom dari server.");
                bankSoal = docSnap.data().questions;
            }
        } catch(e) {
            console.error("Gagal load soal custom, menggunakan default.", e);
        }

        activeQuestions = bankSoal;
        
        if(activeQuestions.length > 0) {
            renderQuestions();
            document.getElementById('btn-done').style.display = 'block';
            loadProgress();
        } else {
            document.getElementById('questions-container').innerHTML = 
                '<div class="empty-state">‚ö†Ô∏è Soal untuk paket ini belum tersedia. <br>Guru belum mengupload soal.</div>';
            document.getElementById('btn-done').style.display = 'none';
        }
    }

    // --- START APP ---
    function startApp() {
        // Sync options visibility on load
        syncMapelOptions();

        if(storage.getItem(RULE_ACCEPTED_KEY) === 'true') {
             document.getElementById('rule-overlay').style.display = 'none';
             isRuleAccepted = true;
        }

        const savedViolations = storage.getItem(VIOLATION_KEY);
        if (savedViolations) violationCount = parseInt(savedViolations, 10);

        const savedStatus = storage.getItem(STATUS_KEY);
        if (savedStatus === 'finished') {
            isExamFinished = true;
            document.getElementById('rule-overlay').style.display = 'none'; 
            showLockedScreen();
            return; 
        }

        const savedLevel = storage.getItem(LEVEL_KEY);
        if(savedLevel) {
            document.getElementById('examLevel').value = ""; 
        }
        
        attachSaveListeners();
    }

    // --- UTILS ---
    function shuffleArray(array) {
        let arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    // --- ORDERING LOGIC ---
    function getFixedOrder() {
        const savedOrder = storage.getItem(ORDER_KEY);
        if (savedOrder) {
            try {
                const parsed = JSON.parse(savedOrder);
                if(parsed.level === currentLevel) return parsed;
            } catch(e) { }
        }

        const questionOrder = shuffleArray(activeQuestions.map(s => s.id));
        const optionOrders = {};
        activeQuestions.forEach(s => {
            optionOrders[s.id] = shuffleArray(Object.keys(s.opsi));
        });
        
        const newOrder = { questionOrder, optionOrders, level: currentLevel };
        storage.setItem(ORDER_KEY, JSON.stringify(newOrder));
        return newOrder;
    }

    // --- RENDER SOAL ---
    function renderQuestions() {
        if (isExamFinished) return; 
        
        const container = document.getElementById('questions-container');
        container.innerHTML = ""; 

        const order = getFixedOrder();

        order.questionOrder.forEach((qId, index) => {
            const soal = activeQuestions.find(s => s.id === qId);
            if(!soal) return;

            let html = `<div class="question-card" id="card-q${soal.id}">`;
            if(soal.bacaan) html += `<div class="reading-text">${soal.bacaan}</div>`;
            html += `<div class="question-text">${index + 1}. ${soal.tanya}</div>`;
            if(soal.gambar) html += `<img src="${soal.gambar}" class="question-img" onerror="this.style.display='none'">`;
            html += `<div class="options">`;
            
            // Handle opsi yang tidak standar (misal soal custom opsi-nya cuma A,B,C)
            const availableKeys = Object.keys(soal.opsi);
            // Gunakan order yang tersimpan jika valid, jika tidak reset ke keys asli
            let opsiKeys = order.optionOrders[soal.id];
            if (!opsiKeys || !opsiKeys.every(k => availableKeys.includes(k))) {
                opsiKeys = availableKeys; // Fallback jika struktur opsi berubah
            }
            
            const labels = ['A', 'B', 'C', 'D', 'E'];

            opsiKeys.forEach((key, idx) => {
                const textValue = soal.opsi[key];
                const visualLabel = labels[idx] || key; // Fallback label
                html += `
                    <label>
                        <input type="radio" name="q${soal.id}" value="${key}">
                        <span class="opt-label">${visualLabel}.</span>
                        <span>${textValue}</span>
                    </label>
                `;
            });
            
            html += `</div></div>`;
            container.innerHTML += html;
        });
    }

    // --- SAVE & LOAD ---
    window.saveProgress = function() {
        if (isExamFinished) return;
        const formData = {
            nama: document.getElementById('studentName').value,
            kelas: document.getElementById('studentClass').value,
            absen: document.getElementById('studentAbsen').value,
            answers: {}
        };
        document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
            formData.answers[radio.name] = radio.value;
        });
        storage.setItem(STORAGE_KEY, JSON.stringify(formData));
    }

    function loadProgress() {
        if (isExamFinished) return;
        const savedData = storage.getItem(STORAGE_KEY);
        if (savedData) {
            try {
                const data = JSON.parse(savedData);
                if(data.nama) document.getElementById('studentName').value = data.nama;
                if(data.kelas) document.getElementById('studentClass').value = data.kelas;
                if(data.absen) document.getElementById('studentAbsen').value = data.absen;
                if(data.answers) {
                    for (const [key, value] of Object.entries(data.answers)) {
                        const radio = document.querySelector(`input[name="${key}"][value="${value}"]`);
                        if (radio) radio.checked = true;
                    }
                }
            } catch (e) { }
        }
    }

    function attachSaveListeners() {
        const textInputs = document.querySelectorAll('input[type="text"], input[type="number"]');
        textInputs.forEach(input => input.addEventListener('input', window.saveProgress));
        const container = document.getElementById('questions-container');
        container.addEventListener('change', (e) => {
            if (e.target.type === 'radio') {
                window.saveProgress();
                const card = e.target.closest('.question-card');
                if(card) card.classList.remove('unanswered');
            }
        });
    }

    // --- RESET ---
    window.resetSession = function() {
        if(confirm("Yakin ingin mereset untuk siswa baru? Data sesi ini akan hilang.")) {
            storage.clear();
            window.location.reload();
        }
    }

    function showLockedScreen() {
        document.querySelector('.header').style.display = 'none';
        document.querySelector('.identity-box').style.display = 'none';
        document.getElementById('examForm').style.display = 'none';
        document.getElementById('locked-screen').style.display = 'block';
    }

    // --- GRADING & SUBMIT ---
    window.gradeExam = async function() {
        if (!auth.currentUser) { alert("Menghubungkan server..."); return; }
        
        if (!currentLevel) { alert("Pilih paket soal terlebih dahulu!"); return; }

        const nama = document.getElementById('studentName').value.trim().toUpperCase();
        const kelasInput = document.getElementById('studentClass').value.trim().toUpperCase();
        const absen = document.getElementById('studentAbsen').value.trim();

        if ((nama === "" || kelasInput === "" || absen === "") && violationCount < MAX_VIOLATIONS) {
            alert("Lengkapi data diri dulu!"); return;
        }

        if (violationCount < MAX_VIOLATIONS) {
            let missed = [];
            document.querySelectorAll('.question-card').forEach(c => c.classList.remove('unanswered'));
            activeQuestions.forEach(soal => {
                if(!document.querySelector(`input[name="q${soal.id}"]:checked`)) {
                    missed.push(soal.id);
                    const el = document.getElementById(`card-q${soal.id}`);
                    if(el) el.classList.add('unanswered');
                }
            });
            if (missed.length > 0) {
                alert(`Masih ada soal yang belum dijawab.`);
                if(missed[0]) document.getElementById(`card-q${missed[0]}`).scrollIntoView({behavior:"smooth", block:"center"});
                return;
            }
        }

        document.getElementById('loader').style.display = 'flex';

        const finalKelas = `${currentLevel} - ${kelasInput}`;
        const finalNama = nama || "PELANGGARAN_NO_NAME";
        const finalAbsen = absen || "0";

        const docId = `${finalNama.replace(/\s+/g, '_')}_${finalKelas.replace(/\s+/g, '')}_${finalAbsen}`;
        const docRef = doc(db, COLLECTION_NAME, docId);

        try {
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) { endProcess("Maaf, siswa ini SUDAH mengerjakan ujian ini."); return; }
            
            const q = query(collection(db, COLLECTION_NAME), where('nama', '==', finalNama));
            const querySnapshot = await getDocs(q);
            let dup = false;
            querySnapshot.forEach(d => { if(d.data().kelas === finalKelas) dup = true; });
            if(dup) { endProcess(`Siswa ${finalNama} untuk mapel/kelas ${finalKelas} SUDAH ujian.`); return; }

        } catch (e) {
            alert("Gagal koneksi. Coba lagi.");
            document.getElementById('loader').style.display = 'none';
            return;
        }

        isExamFinished = true;
        storage.setItem(STATUS_KEY, 'finished'); 

        let score = 0;
        activeQuestions.forEach(soal => {
            const el = document.querySelector(`input[name="q${soal.id}"]:checked`);
            if (el && el.value === soal.kunci) score++;
        });
        
        let finalScore = Math.round((score / activeQuestions.length) * 100);
        const r1 = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(Math.random()*26)];
        const r2 = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(Math.random()*26)];
        const kode = `#SEC-${r1}${100-finalScore}${r2}`;

        // FORCE WIB FOR SAVED TIME
        const wibTime = new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta', dateStyle: 'medium', timeStyle: 'medium' }) + " WIB";

        const dataSiswa = {
            waktu: wibTime,
            nama: finalNama, 
            kelas: finalKelas, 
            absen: finalAbsen,
            nilai: finalScore, 
            kode: kode,
            level_soal: currentLevel 
        };

        try {
            await setDoc(docRef, dataSiswa);
            storage.removeItem(STORAGE_KEY);
            storage.removeItem(ORDER_KEY);
            storage.removeItem(VIOLATION_KEY);
            storage.removeItem(LEVEL_KEY);
            document.getElementById('examForm').reset();
        } catch(e) {
            alert("Gagal simpan data. Coba lagi."); 
            document.getElementById('loader').style.display = 'none'; 
            isExamFinished = false; 
            return; 
        }

        document.getElementById('loader').style.display = 'none';
        showLockedScreen();

        document.getElementById('res-nama').innerText = finalNama;
        document.getElementById('res-kelas').innerText = finalKelas;
        document.getElementById('res-absen').innerText = finalAbsen;
        document.getElementById('res-nilai').innerText = finalScore;
        document.getElementById('res-kode').innerText = kode;
        
        const fb = document.getElementById('feedback-text');
        if(finalScore >= 70) { fb.innerText = "LULUS"; fb.style.color="green"; }
        else { fb.innerText = "BELUM LULUS"; fb.style.color="red"; }
        window.scrollTo(0,0);
    }

    function endProcess(msg) {
        document.getElementById('loader').style.display = 'none';
        alert(msg);
    }

    // --- ADMIN PANEL ---
    window.bukaAdmin = function() {
        if(!auth.currentUser) return alert("Tunggu sebentar...");
        if(prompt("Password Guru:") === passwordGuru) {
            document.getElementById('admin-panel').style.display = 'block';
            renderTabelNilai();
            renderAdminScheduleList(); 
            document.getElementById('admin-panel').scrollIntoView({behavior:"smooth"});
        }
    }
    window.tutupAdmin = () => document.getElementById('admin-panel').style.display = 'none';

    window.renderTabelNilai = async function() {
        if(!auth.currentUser) return;
        const tbody = document.getElementById('tabel-nilai');
        tbody.innerHTML = "<tr><td colspan='3' style='text-align:center;'>Loading...</td></tr>";
        
        try {
            const snap = await getDocs(collection(db, COLLECTION_NAME));
            let data = [];
            snap.forEach(d => data.push(d.data()));
            if(data.length === 0) { tbody.innerHTML = "<tr><td colspan='3' style='text-align:center;'>Kosong</td></tr>"; return; }
            
            // LOGIC SORTING UNTUK TABEL
            data.sort((a,b) => {
                const levelA = a.level_soal || "0";
                const levelB = b.level_soal || "0";
                if(levelA !== levelB) return levelA.localeCompare(levelB);
                const kelasCompare = a.kelas.localeCompare(b.kelas, undefined, { numeric: true, sensitivity: 'base' });
                if(kelasCompare !== 0) return kelasCompare;
                return parseInt(a.absen) - parseInt(b.absen);
            });

            tbody.innerHTML = "";
            data.forEach(d => {
                let mapelCode = d.level_soal || '?';
                let colorBadge = '#64748b'; 

                if(mapelCode.includes('ING')) colorBadge = '#3b82f6'; 
                else if(mapelCode.includes('PJOK')) colorBadge = '#f97316'; 
                else if(mapelCode.includes('IPA')) colorBadge = '#10b981'; 
                else if(mapelCode.includes('IPS')) colorBadge = '#eab308'; 
                else if(mapelCode.includes('PKN')) colorBadge = '#ef4444'; 
                else if(mapelCode.includes('INDO')) colorBadge = '#06b6d4'; 
                else if(mapelCode.includes('MTK')) colorBadge = '#8b5cf6'; 
                else if(mapelCode.includes('INFO')) colorBadge = '#ec4899'; 
                else if(mapelCode.includes('PABP')) colorBadge = '#14b8a6'; 
                else if(mapelCode.includes('BJAWA')) colorBadge = '#a855f7'; 
                else if(mapelCode.includes('SENBUD')) colorBadge = '#f43f5e'; 

                tbody.innerHTML += `<tr>
                    <td style="padding:8px; border:1px solid #ddd;">
                        <b>${d.nama}</b><br>
                        <span style="color:white; background:${colorBadge}; font-weight:bold; font-size:0.7rem; padding:2px 6px; border-radius:4px;">${mapelCode}</span> 
                        <small style="color:gray">${d.waktu || ''}</small>
                    </td>
                    <td style="padding:8px; border:1px solid #ddd;">${d.kelas}</td>
                    <td style="padding:8px; border:1px solid #ddd; text-align:center;"><b>${d.nilai}</b></td>
                </tr>`;
            });
        } catch(e) { console.error(e); tbody.innerHTML = "<tr><td colspan='3'>Error</td></tr>"; }
    }

    window.hapusData = async function() {
        if(!auth.currentUser) return;
        if(confirm("HAPUS SEMUA DATA PERMANEN?")) {
            document.getElementById('loader').style.display = 'flex';
            const snap = await getDocs(collection(db, COLLECTION_NAME));
            await Promise.all(snap.docs.map(d => deleteDoc(d.ref)));
            renderTabelNilai();
            document.getElementById('loader').style.display = 'none';
            alert("Data terhapus.");
        }
    }

    // --- REVISI: LOGIC DOWNLOAD LEBIH RAPI & FORCE WIB FILENAME ---
    window.downloadCSV = async function() {
        if(!auth.currentUser) return;
        const snap = await getDocs(collection(db, COLLECTION_NAME));
        let data = [];
        snap.forEach(d => data.push(d.data()));
        if(data.length === 0) return alert("Data kosong");
        
        // SORTING (Mapel -> Kelas -> Absen)
        data.sort((a,b) => {
            const levelA = a.level_soal || "0";
            const levelB = b.level_soal || "0";
            if(levelA !== levelB) return levelA.localeCompare(levelB);
            const kelasCompare = a.kelas.localeCompare(b.kelas, undefined, { numeric: true, sensitivity: 'base' });
            if(kelasCompare !== 0) return kelasCompare;
            return parseInt(a.absen) - parseInt(b.absen);
        });
        
        let csv = "Mapel,Waktu,Nama,Kelas,Absen,Nilai,Kode\n";
        data.forEach(r => csv += `"${r.level_soal||''}","${r.waktu}","${r.nama}","${r.kelas}","${r.absen}",${r.nilai},"${r.kode}"\n`);
        
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob(["\uFEFF"+csv], {type: 'text/csv;charset=utf-8;'}));
        
        const nowWIB = new Date().toLocaleString('en-GB', { timeZone: 'Asia/Jakarta' }).split(',')[0].split('/').reverse().join('-');
        a.download = `Nilai_Lengkap_${nowWIB}.csv`;
        a.click();
    }

    startApp();
    
    setInterval(() => {
        if(document.documentElement.classList.contains('translated-ltr') || document.documentElement.classList.contains('translated-rtl')) {
            alert("Matikan Auto Translate!"); location.reload();
        }
    }, 1000);
</script>
</body>
</html>
