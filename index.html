<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CBT Online Multi-Mapel (10 Slot)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .option-radio:checked + div {
            background-color: #2563eb; 
            color: white;
            border-color: #2563eb;
            box-shadow: 0 0 10px rgba(37, 99, 235, 0.3);
            transform: scale(1.05);
        }

        body { overscroll-behavior: none; }
        .split-container { height: calc(100dvh - 50px); } 
        
        .tab-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; }

        /* Loading Spinner Overlay */
        #firebase-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #e2e8f0; 
            border-top: 4px solid #2563eb; border-radius: 50%; 
            animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden font-sans text-gray-800">

    <!-- FIREBASE LOADER -->
    <div id="firebase-loader">
        <div class="spinner"></div>
        <p class="text-blue-600 font-bold text-sm animate-pulse">Menghubungkan Server...</p>
    </div>

    <!-- 1. HALAMAN LOGIN PESERTA (DATA DIRI) -->
    <div id="loginOverlay" class="fixed inset-0 bg-slate-900 z-[150] hidden flex flex-col items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden relative">
            
            <!-- TOMBOL ADMIN (GEAR ICON) -->
            <button onclick="window.openAdminLogin()" class="absolute top-3 right-3 text-white/60 hover:text-white transition p-2 z-20" title="Masuk Panel Guru">
                <i class="fas fa-cog text-xl"></i>
            </button>

            <div class="bg-blue-600 p-6 text-center">
                <i class="fas fa-user-graduate text-4xl text-white mb-2"></i>
                <h2 class="text-xl font-bold text-white">Data Peserta Ujian</h2>
                <p class="text-blue-100 text-xs">Silakan isi identitas dengan benar</p>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama Lengkap</label>
                    <input type="text" id="loginName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-bold text-gray-800 placeholder-gray-300" placeholder="Contoh: Ahmad Budi">
                </div>
                <div class="flex gap-4">
                    <div class="w-1/2">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kelas</label>
                        <select id="loginClass" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-bold text-gray-800 bg-white text-center appearance-none cursor-pointer">
                            <option value="">Pilih</option>
                            <!-- Opsi akan diisi otomatis oleh Javascript -->
                        </select>
                    </div>
                    <div class="w-1/2">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">No. Absen</label>
                        <select id="loginNumber" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-bold text-gray-800 bg-white text-center appearance-none cursor-pointer">
                            <option value="">Pilih</option>
                            <!-- Opsi akan diisi otomatis oleh Javascript -->
                        </select>
                    </div>
                </div>
                
                <button onclick="window.processLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition transform active:scale-95 mt-4">
                    MASUK UJIAN <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 2. OVERLAY BLOCKER (Jadwal / Menunggu) -->
    <div id="blockerOverlay" class="fixed inset-0 bg-slate-900 z-[100] hidden flex flex-col items-center justify-center text-white text-center p-6">
        <i id="blockerIcon" class="fas fa-calendar-alt text-5xl mb-4 text-blue-400"></i>
        <h2 id="blockerTitle" class="text-2xl font-bold mb-2">Tidak Ada Ujian Aktif</h2>
        <div class="bg-slate-800 p-4 rounded-lg max-w-md w-full border border-slate-700 mt-4 shadow-xl">
            <h3 class="text-sm font-bold text-gray-400 mb-2 uppercase tracking-wider border-b border-gray-600 pb-1">Jadwal Ujian</h3>
            <ul id="scheduleList" class="text-left text-sm space-y-2 max-h-40 overflow-y-auto custom-scroll pr-2"></ul>
        </div>
        
        <button onclick="window.openAdminLogin()" class="mt-8 text-xs text-slate-500 hover:text-slate-300 flex items-center gap-1">
            <i class="fas fa-cog"></i> Panel Guru
        </button>
    </div>

    <!-- HEADER -->
    <header class="h-[50px] bg-slate-900 text-white flex justify-between items-center px-4 shadow-lg z-30 relative">
        <div class="flex items-center gap-2 overflow-hidden flex-1 mr-2">
            <div class="bg-yellow-500 text-black font-bold text-xs px-2 py-0.5 rounded shrink-0" id="headerSlot">PILIH MAPEL</div>
            <span id="headerMapel" class="font-bold text-sm tracking-wide truncate">Menunggu Jadwal...</span>
            <select id="mapelSelector" onchange="window.loadExam(this.value)" class="hidden bg-slate-700 text-white text-sm border-none rounded px-2 py-1 focus:ring-2 focus:ring-blue-500 w-full max-w-[200px] shadow-inner font-bold cursor-pointer hover:bg-slate-600"></select>
        </div>
        <button onclick="window.openAdminLogin()" class="text-slate-600 hover:text-white transition px-2">
            <i class="fas fa-cog"></i>
        </button>
    </header>

    <!-- MAIN LAYOUT -->
    <div class="split-container flex flex-col md:flex-row relative">
        <!-- KIRI / ATAS: Soal PDF (DOMINAN 65% di HP, 70% di PC) -->
        <div class="w-full h-[65%] md:h-full md:w-[70%] bg-slate-800 relative z-10 border-b-4 border-slate-900 md:border-b-0 md:border-r-4 group">
            <!-- Iframe PDF -->
            <iframe id="pdfFrame" src="" class="w-full h-full" frameborder="0"></iframe>
            <div id="pdfPlaceholder" class="absolute inset-0 flex items-center justify-center text-slate-500 hidden bg-slate-100">
                <div class="text-center p-4">
                    <i class="fas fa-file-pdf text-4xl text-gray-300 mb-2"></i>
                    <p class="text-gray-500 font-bold">Memuat Soal...</p>
                </div>
            </div>
            <button onclick="window.reloadPDF()" class="absolute top-2 right-2 bg-white/20 hover:bg-white/40 text-white p-2 rounded-full text-xs backdrop-blur-sm z-20">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>

        <!-- KANAN / BAWAH: LJK (KECIL 35% di HP, 30% di PC) -->
        <div class="w-full h-[35%] md:h-full md:w-[30%] bg-white flex flex-col z-20 shadow-2xl relative">
            <!-- AREA JAWABAN -->
            <div class="flex-1 overflow-y-auto custom-scroll p-2 bg-slate-50 relative">
                <form id="ljkForm" class="grid grid-cols-1 gap-2 pb-40"></form>
            </div>

            <!-- TOMBOL KIRIM -->
            <div class="p-3 bg-white border-t border-slate-200 shadow-[0_-5px_15px_rgba(0,0,0,0.1)] z-30">
                <button onclick="window.submitExam()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg active:scale-95 transition flex justify-center items-center gap-2">
                    <i class="fas fa-paper-plane"></i> SELESAI & KIRIM
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL LOGIN ADMIN -->
    <div id="adminLoginModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[160] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-xs shadow-2xl border border-gray-200">
            <h3 class="text-lg font-bold text-center mb-4 text-slate-800">Panel Guru</h3>
            <input type="password" id="adminPass" placeholder="Masukkan Password" class="w-full border p-2 rounded mb-4 text-center text-lg focus:ring-2 focus:ring-blue-500 outline-none">
            <div class="flex gap-2">
                <button onclick="window.closeModal('adminLoginModal')" class="flex-1 bg-gray-200 py-2 rounded font-semibold text-gray-700 hover:bg-gray-300">Batal</button>
                <button onclick="window.verifyAdmin()" class="flex-1 bg-blue-600 py-2 rounded font-semibold text-white hover:bg-blue-700">Masuk</button>
            </div>
        </div>
    </div>

    <!-- PANEL ADMIN -->
    <div id="adminPanel" class="fixed inset-0 bg-gray-100 z-[120] hidden flex flex-col">
        <div class="bg-slate-800 text-white p-4 flex justify-between items-center shadow-md shrink-0">
            <h2 class="font-bold text-lg"><i class="fas fa-cogs mr-2"></i>Pengaturan Ujian (10 Slot)</h2>
            <button onclick="window.closeModal('adminPanel'); window.checkAccess();" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm font-bold shadow">Tutup</button>
        </div>
        
        <div class="flex-1 overflow-hidden flex flex-col md:flex-row">
            <!-- Sidebar Tabs -->
            <div class="bg-white w-full md:w-56 flex md:flex-col overflow-x-auto md:overflow-y-auto custom-scroll shrink-0 border-b md:border-r border-gray-200">
                <button onclick="window.switchTab('general')" id="tabgeneral" class="tab-btn p-4 text-sm font-bold text-gray-600 border-b md:border-b-0 md:border-l-4 hover:bg-gray-50 text-left whitespace-nowrap shrink-0"><i class="fas fa-sliders-h mr-2"></i>Umum</button>
                
                <!-- CONTAINER TAB MAPEL (Diisi JS) -->
                <div id="mapelTabsContainer" class="flex md:flex-col"></div>
                
                <button onclick="window.switchTab('rekap')" id="tabrekap" class="tab-btn p-4 text-sm font-bold text-purple-600 border-b md:border-b-0 md:border-l-4 hover:bg-purple-50 text-left whitespace-nowrap shrink-0 mt-auto"><i class="fas fa-download mr-2"></i>Rekap Nilai</button>
            </div>

            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto p-4 md:p-6 bg-slate-50">
                
                <!-- SECTION: PENGATURAN UMUM -->
                <div id="generalSection" class="hidden space-y-6">
                    <!-- MODE MANUAL -->
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-bold text-gray-700">Mode Akses Manual (Buka Semua)</h4>
                                <p class="text-xs text-gray-500">Izinkan siswa mengakses mapel (yang aktif) tanpa jadwal.</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggleForceMode" class="sr-only peer" onchange="window.toggleForceMode()">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <div id="forceModeStatus" class="mt-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Status: Mengikuti Jadwal</div>
                    </div>

                    <!-- KELOLA TAMPILAN MAPEL (NEW FEATURE) -->
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                        <div class="border-b border-gray-100 pb-3 mb-3">
                            <h4 class="font-bold text-gray-700"><i class="fas fa-eye mr-2 text-blue-500"></i>Kelola Tampilan Mapel</h4>
                            <p class="text-xs text-gray-500">Centang mapel yang ingin ditampilkan di halaman siswa. (Mapel tidak dicentang akan disembunyikan)</p>
                        </div>
                        <div id="visibilityList" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-60 overflow-y-auto custom-scroll pr-2">
                            <!-- List Generated by JS -->
                        </div>
                    </div>

                    <!-- TAMPILKAN NILAI -->
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-bold text-gray-700">Tampilkan Nilai ke Siswa</h4>
                                <p class="text-xs text-gray-500">Jika mati, siswa hanya melihat konfirmasi "Terkirim" tanpa skor.</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggleShowScore" class="sr-only peer" onchange="window.toggleShowScore()">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                            </label>
                        </div>
                        <div id="showScoreStatus" class="mt-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Status: Nilai Disembunyikan</div>
                    </div>
                </div>

                <!-- Form Setting Mapel -->
                <div id="mapelConfigForm" class="hidden">
                    <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center">
                        <span class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center mr-2" id="formSlotNum">1</span>
                        Konfigurasi <span id="formSlotName" class="ml-1">Mapel 1</span>
                    </h3>
                    
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama Mata Pelajaran</label>
                            <input type="text" id="inputName" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 font-bold text-gray-800" placeholder="Contoh: Matematika">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Link Soal (PDF)</label>
                            <input type="text" id="inputUrl" class="w-full p-2 border rounded font-mono text-sm text-blue-600" placeholder="https://...">
                            <p class="text-[10px] text-gray-400 mt-1">Pastikan akses file di Google Drive diatur ke <b>"Anyone with the link" (Siapa saja yang memiliki link)</b>.</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mulai</label>
                                <input type="datetime-local" id="inputStart" class="w-full p-2 border rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Selesai</label>
                                <input type="datetime-local" id="inputEnd" class="w-full p-2 border rounded text-sm">
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 mt-4">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Kunci Jawaban (40 Soal)</label>
                        <textarea id="inputKey" rows="2" class="w-full p-3 border rounded font-mono text-lg tracking-widest uppercase focus:ring-2 focus:ring-green-500 mb-4" placeholder="ABCD..."></textarea>
                        
                        <!-- VISUAL KEY EDITOR -->
                        <div class="mb-4">
                            <p class="text-xs font-bold text-gray-400 mb-2 uppercase">Editor Visual (Klik untuk ubah)</p>
                            <div id="visualKeyContainer" class="grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 gap-2">
                                <!-- Grid generated by JS -->
                            </div>
                        </div>

                        <div class="flex justify-between mt-2 items-center">
                            <span id="keyCounter" class="text-xs font-bold text-gray-400">0/40</span>
                            <button onclick="window.saveCurrentTab()" class="bg-green-600 text-white px-6 py-2 rounded font-bold hover:bg-green-700 shadow transform active:scale-95 transition"><i class="fas fa-cloud-upload-alt mr-2"></i>Simpan</button>
                        </div>
                    </div>
                </div>

                <!-- Rekap Section -->
                <div id="rekapSection" class="hidden">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">Rekapitulasi Nilai</h3>
                    <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                        <div class="overflow-x-auto max-h-[60vh] custom-scroll">
                            <table class="w-full text-sm text-left"><thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0"><tr><th class="px-3 py-2">Waktu</th><th class="px-3 py-2">Mapel</th><th class="px-3 py-2">Nama</th><th class="px-3 py-2">Kls</th><th class="px-3 py-2">No</th><th class="px-3 py-2">B/S</th><th class="px-3 py-2">Nilai</th><th class="px-3 py-2 text-center">Aksi</th></tr></thead><tbody id="scoreTableBody"></tbody></table>
                        </div>
                        <div class="mt-4 flex gap-2 flex-wrap">
                            <button onclick="window.downloadXLS()" class="flex-1 bg-green-700 text-white py-2 rounded font-bold hover:bg-green-800"><i class="fas fa-file-excel mr-2"></i>Download Excel</button>
                            <button onclick="window.refreshRekap()" class="px-4 bg-blue-100 text-blue-600 rounded font-bold hover:bg-blue-200"><i class="fas fa-sync"></i></button>
                            <!-- TOMBOL HAPUS SEMUA DATA -->
                            <button id="btnDeleteAll" onclick="window.deleteAllData()" class="px-4 bg-red-600 text-white rounded font-bold hover:bg-red-700 border border-red-800" title="Hapus Semua Data"><i class="fas fa-trash-alt mr-2"></i>Hapus Semua</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">*Download Excel akan mencetak: Nama, Kelas, No Absen, Benar, Salah, dan Nilai Akhir.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL HASIL -->
    <div id="resultModal" class="fixed inset-0 bg-slate-900/90 backdrop-blur z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl relative animate-bounce-in text-center p-6">
            <h2 id="resTitle" class="text-2xl font-bold text-slate-800 mb-1">Hasil Ujian</h2>
            <p id="resMapelName" class="text-blue-600 font-bold text-sm mb-4">...</p>
            <div id="scoreContainer"><div class="text-6xl font-extrabold text-blue-600 mb-2" id="resScore">0</div><p class="text-gray-400 text-xs mb-6">Nilai Akhir</p><div class="grid grid-cols-2 gap-4 mb-6"><div class="bg-green-50 p-2 rounded"><span class="block text-xs text-green-600 font-bold">BENAR</span><span class="text-xl font-bold text-green-700" id="resCorrect">0</span></div><div class="bg-red-50 p-2 rounded"><span class="block text-xs text-red-600 font-bold">SALAH</span><span class="text-xl font-bold text-red-700" id="resWrong">0</span></div></div></div>
            <div id="hiddenScoreMsg" class="hidden py-6"><div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-check text-green-600 text-3xl"></i></div><p class="text-gray-600 font-bold">Jawaban Anda berhasil disimpan ke server.</p></div>
            <button onclick="window.closeModal('resultModal'); location.reload();" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold">Tutup & Keluar</button>
        </div>
    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, deleteDoc, getDocs, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyDy6E0FpxFAV8Fq2ayO1UWd2UMC19xLHgM", authDomain: "vooting-guru.firebaseapp.com", projectId: "vooting-guru", storageBucket: "vooting-guru.firebasestorage.app", messagingSenderId: "643701954972", appId: "1:643701954972:web:5db3499faeb8ca91919059", measurementId: "G-MZV18MY9VM" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const JUMLAH_SOAL = 40;
        const OPSI = ['A', 'B', 'C', 'D'];
        const CONFIG_DOC_PATH = 'cbt_apps/settings_v2'; 
        const RESULTS_COLLECTION = 'cbt_results';
        const TOTAL_MAPEL_SLOTS = 10; 

        // Initial with isActive true by default
        let subjects = Array(TOTAL_MAPEL_SLOTS).fill(null).map((_, i) => ({ 
            name: `Mapel ${i+1}`, 
            url: '', 
            start: '', 
            end: '', 
            key: '',
            isActive: true 
        }));

        let forcedMode = false;
        let showScore = false; 
        let examHistory = []; 
        let activeSubjectIndex = -1;
        let editingTabIndex = 0;
        let studentData = { name: '', class: '', number: '' };

        async function initApp() {
            renderAdminTabs();
            try {
                await signInAnonymously(auth);
                onSnapshot(doc(db, CONFIG_DOC_PATH), (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.subjects) {
                            subjects = subjects.map((def, i) => {
                                const dbSub = data.subjects[i] || {};
                                return { ...def, ...dbSub, isActive: dbSub.isActive !== false }; // Merge with safety
                            });
                        }
                        if (data.forcedMode !== undefined) forcedMode = data.forcedMode;
                        if (data.showScore !== undefined) showScore = data.showScore;
                        updateForceModeUI(); 
                        updateShowScoreUI();
                        updateTabNames();
                        renderVisibilityList(); // Update visibility toggles
                    } else { 
                        saveConfigToFirebase(); 
                    }
                    document.getElementById('firebase-loader').style.display = 'none';
                    if (studentData.name) window.checkAccess();
                });
                document.getElementById('loginOverlay').classList.remove('hidden');
            } catch (error) { console.error("Firebase Auth Error:", error); alert("Gagal terhubung server."); }
        }
        initApp();

        function renderAdminTabs() {
            const container = document.getElementById('mapelTabsContainer');
            container.innerHTML = '';
            for(let i=0; i<TOTAL_MAPEL_SLOTS; i++) {
                const btn = document.createElement('button');
                btn.onclick = () => window.switchTab(i);
                btn.id = `tab${i}`;
                btn.className = "tab-btn p-4 text-sm font-bold text-gray-600 border-b md:border-b-0 md:border-l-4 hover:bg-gray-50 text-left whitespace-nowrap shrink-0";
                btn.innerText = subjects[i].name;
                container.appendChild(btn);
            }
        }

        // NEW: RENDER VISIBILITY LIST IN GENERAL TAB
        function renderVisibilityList() {
            const container = document.getElementById('visibilityList');
            container.innerHTML = '';
            subjects.forEach((sub, idx) => {
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-2 rounded border ${sub.isActive ? 'bg-white border-gray-200' : 'bg-gray-50 border-gray-200 opacity-75'}`;
                div.innerHTML = `
                    <span class="text-xs font-bold text-gray-700 truncate w-2/3">${idx+1}. ${sub.name}</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" onchange="window.toggleSubjectVisibility(${idx})" class="sr-only peer" ${sub.isActive ? 'checked' : ''}>
                        <div class="w-9 h-5 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-500"></div>
                    </label>
                `;
                container.appendChild(div);
            });
        }

        window.toggleSubjectVisibility = async function(idx) {
            subjects[idx].isActive = !subjects[idx].isActive;
            renderVisibilityList(); // Optimistic update
            try {
                await setDoc(doc(db, CONFIG_DOC_PATH), { subjects: subjects }, { merge: true });
            } catch(e) {
                console.error(e);
                subjects[idx].isActive = !subjects[idx].isActive; // Revert on error
                renderVisibilityList();
                alert("Gagal update: " + e.message);
            }
        }

        function updateTabNames() {
            for(let i=0; i<TOTAL_MAPEL_SLOTS; i++) {
                const btn = document.getElementById(`tab${i}`);
                if(btn) {
                    btn.innerText = subjects[i].name;
                    // Optional: Visual cue for inactive tabs
                    if(!subjects[i].isActive) btn.classList.add('opacity-50', 'line-through');
                    else btn.classList.remove('opacity-50', 'line-through');
                }
            }
        }

        window.processLogin = function() {
            const name = document.getElementById('loginName').value.trim();
            const kelas = document.getElementById('loginClass').value.trim();
            const number = document.getElementById('loginNumber').value.trim();
            if (!name || !kelas || !number) { alert("Harap lengkapi data!"); return; }
            studentData = { name, class: kelas, number };
            window.closeModal('loginOverlay');
            window.checkAccess();
        }

        window.initLJK = function() {
            const form = document.getElementById('ljkForm');
            form.innerHTML = ''; 
            for(let i=1; i<=JUMLAH_SOAL; i++){
                const div = document.createElement('div');
                div.id = `row-q${i}`; 
                div.className = 'bg-white p-2.5 rounded-lg border border-slate-200 shadow-sm flex items-center justify-between hover:bg-blue-50 transition';
                div.innerHTML = `<div class="w-8 text-center font-bold text-slate-600 text-sm">${i}.</div><div class="flex-1 flex justify-around pl-4">${OPSI.map(o => `<label class="cursor-pointer relative group"><input type="radio" name="q${i}" value="${o}" class="sr-only option-radio"><div class="w-10 h-10 rounded-full border-2 border-slate-300 flex items-center justify-center font-bold text-slate-500 transition-all hover:border-blue-400">${o}</div></label>`).join('')}</div>`;
                form.appendChild(div);
            }
            const classSelect = document.getElementById('loginClass');
            const grades = [7, 8, 9]; const letters = ['A', 'B', 'C', 'D', 'E'];
            grades.forEach(grade => { const optgroup = document.createElement('optgroup'); optgroup.label = `Kelas ${grade}`; letters.forEach(letter => { const option = document.createElement('option'); option.value = `${grade}${letter}`; option.innerText = `${grade}${letter}`; optgroup.appendChild(option); }); classSelect.appendChild(optgroup); });
            const numberSelect = document.getElementById('loginNumber');
            for (let i = 1; i <= 35; i++) { const option = document.createElement('option'); option.value = i; option.innerText = i; numberSelect.appendChild(option); }
        }
        window.initLJK();

        document.getElementById('inputKey').addEventListener('input', function(e) {
            const clean = this.value.toUpperCase().replace(/[^A-D]/g, '');
            this.value = clean;
            updateKeyCounter(clean.length);
            syncVisualKeyFromText(clean);
        });

        function updateKeyCounter(len) {
            const label = document.getElementById('keyCounter');
            label.innerText = `${len}/${JUMLAH_SOAL}`;
            label.className = len === JUMLAH_SOAL ? "text-xs font-bold text-green-600" : "text-xs font-bold text-red-500";
        }

        function initVisualKeyEditor() {
            const container = document.getElementById('visualKeyContainer');
            container.innerHTML = '';
            for(let i=1; i<=JUMLAH_SOAL; i++) {
                const div = document.createElement('div');
                div.className = "flex flex-col items-center bg-slate-50 border border-slate-200 rounded p-1";
                div.innerHTML = `<span class="text-[9px] text-gray-400 font-bold mb-1">${i}</span><button type="button" onclick="window.rotateKey(${i})" id="vKeyBtn-${i}" class="w-full aspect-square bg-white border border-gray-300 rounded font-bold text-gray-400 hover:bg-blue-50 text-xs">?</button>`;
                container.appendChild(div);
            }
        }
        
        window.rotateKey = function(num) {
            const btn = document.getElementById(`vKeyBtn-${num}`);
            const current = btn.innerText;
            const options = ['?', 'A', 'B', 'C', 'D'];
            let nextIdx = options.indexOf(current) + 1;
            if (nextIdx >= options.length) nextIdx = 0; if (nextIdx === 0) nextIdx = 1; 
            const newVal = options[nextIdx];
            btn.innerText = newVal;
            btn.className = `w-full aspect-square border rounded font-bold text-xs transition ${newVal !== '?' ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-400 border-gray-300'}`;
            syncTextFromVisual();
        }

        function syncTextFromVisual() {
            let keyStr = "";
            for(let i=1; i<=JUMLAH_SOAL; i++) {
                const btn = document.getElementById(`vKeyBtn-${i}`);
                const val = btn.innerText;
                keyStr += (val === '?' ? 'X' : val);
            }
            const cleanStr = keyStr.replace(/\?/g, ''); 
            document.getElementById('inputKey').value = cleanStr;
            updateKeyCounter(cleanStr.length);
        }

        function syncVisualKeyFromText(text) {
            for(let i=1; i<=JUMLAH_SOAL; i++) {
                const char = text[i-1] || '?';
                const btn = document.getElementById(`vKeyBtn-${i}`);
                if(btn) {
                    btn.innerText = char;
                    btn.className = `w-full aspect-square border rounded font-bold text-xs transition ${['A','B','C','D'].includes(char) ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-400 border-gray-300'}`;
                }
            }
        }
        initVisualKeyEditor();

        window.toggleForceMode = async function() {
            const checkbox = document.getElementById('toggleForceMode');
            forcedMode = checkbox.checked;
            updateForceModeUI();
            try { await setDoc(doc(db, CONFIG_DOC_PATH), { forcedMode: forcedMode }, { merge: true }); } catch(e) { checkbox.checked = !checkbox.checked; }
        }
        window.toggleShowScore = async function() {
            const checkbox = document.getElementById('toggleShowScore');
            showScore = checkbox.checked;
            updateShowScoreUI();
            try { await setDoc(doc(db, CONFIG_DOC_PATH), { showScore: showScore }, { merge: true }); } catch(e) { checkbox.checked = !checkbox.checked; }
        }
        function updateForceModeUI() {
            const checkbox = document.getElementById('toggleForceMode'); if(checkbox) checkbox.checked = forcedMode;
            document.getElementById('forceModeStatus').innerText = forcedMode ? "Status: MODE MANUAL AKTIF (Buka Semua)" : "Status: Mengikuti Jadwal Otomatis";
        }
        function updateShowScoreUI() {
            const checkbox = document.getElementById('toggleShowScore'); if(checkbox) checkbox.checked = showScore;
            document.getElementById('showScoreStatus').innerText = showScore ? "Status: NILAI DITAMPILKAN" : "Status: Nilai Disembunyikan";
        }

        window.saveCurrentTab = async function() {
            const idx = editingTabIndex;
            const rawUrl = document.getElementById('inputUrl').value;
            const cleanUrl = rawUrl ? rawUrl.trim() : '';
            const rawKey = document.getElementById('inputKey').value.toUpperCase().replace(/[^A-D]/g, '');
            if (rawKey.length !== JUMLAH_SOAL && rawKey.length > 0) { if(!confirm(`⚠️ PERINGATAN: Jumlah kunci (${rawKey.length}) tidak 40.\nTetap simpan?`)) return; }
            
            // Preserve existing isActive state
            const currentActive = subjects[idx].isActive;
            
            subjects[idx] = { 
                name: document.getElementById('inputName').value || `Mapel ${idx+1}`, 
                url: cleanUrl, 
                start: document.getElementById('inputStart').value, 
                end: document.getElementById('inputEnd').value, 
                key: rawKey,
                isActive: currentActive 
            };
            
            try {
                await setDoc(doc(db, CONFIG_DOC_PATH), { subjects: subjects }, { merge: true });
                document.getElementById('formSlotName').innerText = subjects[idx].name;
                updateTabNames();
                renderVisibilityList(); // Update General tab list
                const sel = document.getElementById('mapelSelector'); if(sel && sel.options[idx]) sel.options[idx].text = subjects[idx].name;
                alert(`Pengaturan ${subjects[idx].name} TERSIMPAN!`);
            } catch(e) { alert("Gagal simpan: " + e.message); }
        }
        async function saveConfigToFirebase() { await setDoc(doc(db, CONFIG_DOC_PATH), { subjects: subjects, forcedMode: forcedMode, showScore: showScore }, { merge: true }); }

        window.checkAccess = function() {
            const blocker = document.getElementById('blockerOverlay'); const selector = document.getElementById('mapelSelector'); const labelMapel = document.getElementById('headerMapel');
            let activeIndices = [];
            
            // Logic with isActive check
            if (forcedMode) { 
                // In Manual Mode, show ALL that are marked Active
                activeIndices = subjects.map((s, i) => (s.isActive !== false) ? i : -1).filter(i => i !== -1);
            } else {
                const now = new Date();
                subjects.forEach((sub, idx) => { 
                    if (sub.isActive !== false && sub.start && sub.end) { // Check active AND schedule
                        const start = new Date(sub.start); 
                        const end = new Date(sub.end); 
                        if (now >= start && now <= end) activeIndices.push(idx); 
                    } 
                });
            }

            if (activeIndices.length === 0) { blocker.classList.remove('hidden'); renderScheduleList(); selector.classList.add('hidden'); labelMapel.classList.remove('hidden'); labelMapel.innerText = "Menunggu Jadwal..."; }
            else { 
                blocker.classList.add('hidden'); 
                if (activeIndices.length === 1) { 
                    labelMapel.classList.remove('hidden'); selector.classList.add('hidden'); 
                    if(activeSubjectIndex !== activeIndices[0]) window.loadExam(activeIndices[0]); 
                } else { 
                    labelMapel.classList.add('hidden'); selector.classList.remove('hidden'); 
                    const currentOptions = Array.from(selector.options).map(o => o.value).join(','); const newOptions = activeIndices.join(','); 
                    if (currentOptions !== newOptions) { 
                        selector.innerHTML = ''; 
                        activeIndices.forEach(idx => { const opt = document.createElement('option'); opt.value = idx; opt.text = subjects[idx].name; selector.add(opt); }); 
                        let targetIndex = activeSubjectIndex; 
                        if (!activeIndices.includes(parseInt(activeSubjectIndex))) { 
                            // Default to first available
                            targetIndex = activeIndices[0];
                            window.loadExam(targetIndex); 
                        } 
                        selector.value = targetIndex; 
                    } 
                    if (selector.options[selector.selectedIndex]) { selector.options[selector.selectedIndex].text = subjects[activeSubjectIndex].name; } 
                } 
            }
        }

        function renderScheduleList() { 
            const list = document.getElementById('scheduleList'); 
            list.innerHTML = ''; 
            subjects.forEach((sub, idx) => { 
                if(sub.isActive !== false && sub.start && sub.end) { // Only list active subjects
                    const sTime = new Date(sub.start).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}); 
                    const eTime = new Date(sub.end).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}); 
                    list.innerHTML += `<li class="border-b border-slate-700 pb-1 last:border-0"><span class="text-yellow-400 font-bold block text-xs">Mapel ${idx+1}: ${sub.name}</span><span class="text-slate-400 text-xs">${sTime} - ${eTime}</span></li>`; 
                } 
            }); 
            if(list.innerHTML === '') list.innerHTML = '<li class="text-xs text-gray-500 italic">Tidak ada jadwal aktif.</li>';
        }

        window.loadExam = function(index) {
            index = parseInt(index); activeSubjectIndex = index; const sub = subjects[index];
            document.getElementById('headerSlot').innerText = "UJIAN"; document.getElementById('headerMapel').innerText = sub.name;
            const frame = document.getElementById('pdfFrame'); const ph = document.getElementById('pdfPlaceholder');
            const sel = document.getElementById('mapelSelector'); if(sel && !sel.classList.contains('hidden')) sel.value = index;
            
            const cleanUrl = sub.url ? sub.url.trim() : '';
            if (cleanUrl) { 
                let finalSrc = cleanUrl;
                
                // LOGIKA KHUSUS GOOGLE DRIVE
                if (cleanUrl.includes('drive.google.com')) {
                    // Konversi link 'view' atau 'share' menjadi 'preview' agar bisa di-embed
                    // Contoh: https://drive.google.com/file/d/XYZ/view?usp=sharing -> https://drive.google.com/file/d/XYZ/preview
                    finalSrc = cleanUrl.replace(/\/view.*/, '/preview').replace(/\/sharing.*/, '/preview');
                } else {
                    // Jika BUKAN Google Drive (misal hosting sekolah/Github), gunakan Google Docs Viewer
                    finalSrc = `https://docs.google.com/viewer?url=${cleanUrl}&embedded=true`;
                }

                if(frame.src !== finalSrc) frame.src = finalSrc; 
                ph.classList.add('hidden'); 
            } else { 
                frame.src = ''; ph.classList.remove('hidden'); 
                ph.innerHTML = `<div class="text-center p-6"><i class="fas fa-exclamation-circle text-4xl text-red-300 mb-2"></i><p class="text-red-500 font-bold">Link soal untuk <br>"${sub.name}"<br> belum diatur.</p></div>`; 
            }
        }
        window.reloadPDF = function() { document.getElementById('pdfFrame').src = document.getElementById('pdfFrame').src; }

        window.submitExam = async function() {
            if (activeSubjectIndex === -1) return; if(!studentData.name) return alert('Data tidak valid.');
            
            // --- VALIDASI JAWABAN KOSONG ---
            let unanswered = [];
            for(let i=1; i<=JUMLAH_SOAL; i++){
                const row = document.getElementById(`row-q${i}`);
                if(row) { row.classList.remove('bg-red-50', 'border-red-500', 'ring-1', 'ring-red-500'); row.classList.add('bg-white', 'border-slate-200'); }
            }
            for(let i=1; i<=JUMLAH_SOAL; i++){
                const el = document.querySelector(`input[name="q${i}"]:checked`);
                if (!el) {
                    unanswered.push(i);
                    const row = document.getElementById(`row-q${i}`);
                    if(row) { row.classList.remove('bg-white', 'border-slate-200'); row.classList.add('bg-red-50', 'border-red-500', 'ring-1', 'ring-red-500'); }
                }
            }
            if (unanswered.length > 0) {
                const firstMiss = document.getElementById(`row-q${unanswered[0]}`);
                if(firstMiss) firstMiss.scrollIntoView({behavior: 'smooth', block: 'center'});
                let listStr = unanswered.join(', ');
                if (unanswered.length > 15) listStr = unanswered.slice(0, 15).join(', ') + '...';
                if(!confirm(`⚠️ PERINGATAN!\n\nAnda belum menjawab soal nomor:\n${listStr}\n\nApakah Anda yakin ingin tetap mengirim? (Nilai mungkin tidak maksimal)`)) return;
            } else {
                if(!confirm(`Halo ${studentData.name}, jawaban sudah lengkap.\nYakin ingin mengirim jawaban ke server?`)) return;
            }

            const sub = subjects[activeSubjectIndex]; const key = sub.key || ''; 
            let correct = 0; for(let i=1; i<=JUMLAH_SOAL; i++){ const el = document.querySelector(`input[name="q${i}"]:checked`); const val = el ? el.value : 'X'; const keyChar = key[i-1] || '?'; if(val === keyChar) correct++; }
            const scoreRaw = (correct / JUMLAH_SOAL) * 100;
            const score = Number.isInteger(scoreRaw) ? scoreRaw : parseFloat(scoreRaw.toFixed(2));

            const wibTime = new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' });
            const resultData = { time: wibTime, mapel: sub.name, name: studentData.name, class: studentData.class, number: studentData.number, score: score, correct: correct, detail: `${correct} Benar, ${JUMLAH_SOAL-correct} Salah`, timestamp: Date.now() };
            const uniqueDocId = `${sub.name}_${studentData.class}_${studentData.number}_${studentData.name}`.replace(/[^a-zA-Z0-9]/g, '_').toUpperCase();
            const docRef = doc(db, RESULTS_COLLECTION, uniqueDocId);
            try {
                const docSnap = await getDoc(docRef); if (docSnap.exists()) { return alert("⛔ AKSES DITOLAK! Data sudah ada."); }
                await setDoc(docRef, resultData);
                document.getElementById('resMapelName').innerText = sub.name;
                if (showScore) { document.getElementById('resScore').innerText = score; document.getElementById('resCorrect').innerText = correct; document.getElementById('resWrong').innerText = JUMLAH_SOAL - correct; document.getElementById('scoreContainer').classList.remove('hidden'); document.getElementById('hiddenScoreMsg').classList.add('hidden'); document.getElementById('resTitle').innerText = "Hasil Ujian"; } 
                else { document.getElementById('scoreContainer').classList.add('hidden'); document.getElementById('hiddenScoreMsg').classList.remove('hidden'); document.getElementById('resTitle').innerText = "Terkirim!"; }
                document.getElementById('resultModal').classList.remove('hidden');
            } catch(e) { alert("Gagal kirim: " + e.message); }
        }

        window.openAdminLogin = function() { document.getElementById('adminLoginModal').classList.remove('hidden'); document.getElementById('adminLoginModal').style.zIndex = "160"; }
        window.closeModal = function(id) { document.getElementById(id).classList.add('hidden'); }
        window.verifyAdmin = function() { if(document.getElementById('adminPass').value === '!@#$%^&*()'){ window.closeModal('adminLoginModal'); window.closeModal('loginOverlay'); window.closeModal('blockerOverlay'); document.getElementById('adminPanel').classList.remove('hidden'); window.switchTab('general'); } else { alert('Salah password'); } }

        window.switchTab = function(idx) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'border-blue-500', 'bg-blue-50'));
            document.getElementById('rekapSection').classList.add('hidden'); document.getElementById('mapelConfigForm').classList.add('hidden'); document.getElementById('generalSection').classList.add('hidden');
            if (idx === 'rekap') { document.getElementById('tabrekap').classList.add('active', 'bg-purple-50'); document.getElementById('rekapSection').classList.remove('hidden'); window.refreshRekap(); }
            else if (idx === 'general') { document.getElementById('tabgeneral').classList.add('active', 'bg-blue-50'); document.getElementById('generalSection').classList.remove('hidden'); renderVisibilityList(); }
            else { editingTabIndex = idx; const btn = document.getElementById(`tab${idx}`); if(btn) btn.classList.add('active'); document.getElementById('mapelConfigForm').classList.remove('hidden'); const data = subjects[idx]; document.getElementById('formSlotNum').innerText = idx + 1; document.getElementById('formSlotName').innerText = data.name; document.getElementById('inputName').value = data.name; document.getElementById('inputUrl').value = data.url; document.getElementById('inputStart').value = data.start; document.getElementById('inputEnd').value = data.end; document.getElementById('inputKey').value = data.key || ''; document.getElementById('inputKey').dispatchEvent(new Event('input')); syncVisualKeyFromText(data.key || ''); }
        }

        window.refreshRekap = async function() {
            const tbody = document.getElementById('scoreTableBody'); tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4">Loading...</td></tr>';
            try {
                const q = query(collection(db, RESULTS_COLLECTION), orderBy('timestamp', 'desc')); const snap = await getDocs(q);
                tbody.innerHTML = ''; examHistory = [];
                if(snap.empty) { tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4">Kosong.</td></tr>'; return; }
                snap.forEach((d) => { const r = d.data(); examHistory.push(r); const wrong = JUMLAH_SOAL - (r.correct || 0); tbody.innerHTML += `<tr class="bg-white border-b text-xs"><td class="px-3 py-2 text-slate-400">${r.time}</td><td class="px-3 py-2 font-bold text-slate-500">${r.mapel}</td><td class="px-3 py-2 font-bold">${r.name}</td><td class="px-3 py-2">${r.class}</td><td class="px-3 py-2">${r.number}</td><td class="px-3 py-2 text-gray-500">${r.correct}/${wrong}</td><td class="px-3 py-2 font-bold text-blue-600">${r.score}</td><td class="px-3 py-2 text-center"><button onclick="window.deleteStudentData('${d.id}', '${r.name}')" class="bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200 text-[10px] font-bold"><i class="fas fa-trash-alt"></i></button></td></tr>`; });
            } catch(e) { tbody.innerHTML = '<tr><td colspan="8" class="text-center text-red-500">Error.</td></tr>'; }
        }

        window.deleteStudentData = async function(docId, name) { if(!confirm(`Hapus data ${name}?`)) return; try { await deleteDoc(doc(db, RESULTS_COLLECTION, docId)); alert("Reset berhasil."); window.refreshRekap(); } catch(e) { alert("Gagal: " + e.message); } }
        
        window.deleteAllData = async function() {
            if(!confirm("⚠️ PERINGATAN KERAS!\n\nApakah Anda yakin ingin MENGHAPUS SEMUA DATA HASIL UJIAN?\n\nTindakan ini tidak dapat dibatalkan!")) return;
            if(!confirm("Konfirmasi Terakhir:\nHapus semua data sekarang?")) return;

            const btn = document.getElementById('btnDeleteAll');
            const oldText = btn.innerHTML;
            btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Menghapus...";
            btn.disabled = true;

            try {
                const q = query(collection(db, RESULTS_COLLECTION));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    alert("Data sudah kosong.");
                    return;
                }
                const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);
                alert("✅ Semua data berhasil dihapus bersih.");
                window.refreshRekap();
            } catch (error) {
                console.error(error);
                alert("Gagal menghapus sebagian data: " + error.message);
            } finally {
                btn.innerHTML = oldText;
                btn.disabled = false;
            }
        }

        window.downloadXLS = function() {
            if(examHistory.length === 0) return alert("Data kosong.");
            let html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>Rekap Nilai</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--><meta charset="utf-8"></head><body>';
            html += '<table border="1" style="font-family: Arial, sans-serif; border-collapse: collapse;">';
            html += '<thead><tr style="background-color: #f0f0f0;"><th>Waktu</th><th>Mata Pelajaran</th><th>Nama Siswa</th><th>Kelas</th><th>No Absen</th><th>Benar</th><th>Salah</th><th>Nilai Akhir</th></tr></thead>';
            html += '<tbody>';
            examHistory.forEach(r => { 
                const correct = r.correct || 0;
                const wrong = JUMLAH_SOAL - correct;
                const score = r.score !== undefined ? r.score : 0;
                html += `<tr><td>${r.time}</td><td>${r.mapel}</td><td>${r.name}</td><td style="text-align:center">${r.class}</td><td style="text-align:center">${r.number}</td><td style="text-align:center">${correct}</td><td style="text-align:center">${wrong}</td><td style="text-align:center; font-weight:bold;">${score}</td></tr>`; 
            });
            html += '</tbody></table></body></html>';
            const blob = new Blob([html], {type: 'application/vnd.ms-excel'}); 
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Rekap_Nilai_CBT_${new Date().toISOString().slice(0,10)}.xls`; a.click();
        }
    </script>
</body>
</html>
