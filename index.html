<!DOCTYPE html>
<html lang="id" translate="no" class="notranslate">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="google" content="notranslate">
    <title>Ujian Sekolah (Remedial & Sumatif) - SMP Negeri 4 Pandak</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PDF.js (Pustaka Wajib untuk Render PDF Mandiri) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        // Set worker untuk PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>
    <style>
        /* --- INTEGRASI STYLE DARI E LOGO.HTML --- */
        :root {
            --primary: #4f46e5;
            --primary-dark: #3730a3;
            --bg: #f8fafc;
            --text: #1f2937;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg); 
            color: var(--text); 
            overflow: hidden; 
            user-select: none; -webkit-user-select: none;
        }

        /* Scrollbar Halus */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Header Style Integrasi */
        .header-custom {
            background: white; padding: 12px 15px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            display: flex; align-items: center; justify-content: space-between;
            z-index: 40; border-bottom: 1px solid var(--border);
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .school-logo { width: 45px; height: 45px; object-fit: cover; border-radius: 50%; border: 2px solid var(--border); }
        .header-text h1 { margin: 0; font-size: 1rem; font-weight: 700; line-height: 1.2; color: var(--primary-dark); }
        .header-text p { margin: 0; font-size: 0.75rem; color: #64748b; }

        /* Login Box Style Integrasi */
        .identity-box {
            background: white; padding: 25px; border-radius: 16px;
            border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            max-width: 500px; width: 100%;
        }
        .identity-box h3 { 
            margin-top: 0; font-size: 1.1rem; color: var(--primary); 
            margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; 
        }
        .form-group label { display: block; margin-bottom: 6px; font-size: 0.9rem; font-weight: 600; color: #475569; }
        .form-input {
            width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px;
            font-size: 1rem; background: #f8fafc; transition: all 0.2s;
        }
        .form-input:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        
        .btn-main {
            background: var(--primary); color: white; border: none; padding: 14px; 
            font-size: 1.1rem; font-weight: bold; border-radius: 12px; cursor: pointer; 
            width: 100%; transition: transform 0.1s, background 0.2s;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3);
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-main:hover { background: var(--primary-dark); }
        .btn-main:active { transform: scale(0.97); }
        
        /* State Tombol Disabled */
        .btn-main:disabled {
            background: #94a3b8; cursor: not-allowed; opacity: 0.7;
        }

        /* Admin Panel Style Integrasi */
        .admin-section {
            background: #fff; border: 1px solid #e2e8f0; padding: 15px; 
            border-radius: 8px; margin-bottom: 15px;
        }
        .admin-title { font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: uppercase; }
        
        /* Animasi */
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Loader */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); display: none; justify-content: center;
            align-items: center; z-index: 10000; font-weight: bold; color: var(--primary);
            flex-direction: column; text-align: center; padding: 20px;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* PDF Viewer Custom Styles */
        #pdf-render-container {
            width: 100%; height: 100%; overflow: auto; background: #525659;
            display: flex; flex-direction: column; align-items: center; padding: 20px 0;
        }
        .pdf-page-canvas {
            margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            max-width: 95%; background: white;
        }
        #pdf-controls {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); padding: 8px 16px; border-radius: 20px;
            display: flex; gap: 15px; color: white; z-index: 30; font-size: 0.9rem;
            align-items: center;
        }
        #pdf-controls button {
            background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem;
        }
        #pdf-controls button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Image Mode Styles */
        #image-render-container {
            width: 100%; height: 100%; overflow: auto; background: #525659;
            display: none; flex-direction: column; align-items: center; padding: 20px 0;
        }
        .exam-image {
            max-width: 95%; height: auto; margin-bottom: 15px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); background: white;
        }
    </style>
</head>
<body class="h-screen flex flex-col" oncontextmenu="return false;">

    <!-- LOADER -->
    <div id="loader" class="loading-overlay">
        <div class="spinner"></div>
        <div id="loader-text">Sedang memproses...</div>
    </div>

    <!-- ================= HALAMAN LOGIN ================= -->
    <div id="login-page" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-50 p-4">
        <button id="btn-admin-login" class="absolute top-4 right-4 text-gray-400 hover:text-indigo-600 transition">
            <i class="fas fa-cog fa-lg"></i>
        </button>

        <div class="identity-box animate-fade-in border-t-4 border-indigo-600">
            <!-- Header Login -->
            <div class="flex items-center gap-4 mb-6 pb-4 border-b border-slate-100">
                <img src="https://raw.githubusercontent.com/atha-cyber/logo-/5eeaaecc00cf02080842f1cd6f4fc7bf13fe7f18/images.jfif" alt="Logo" class="school-logo w-16 h-16">
                <div>
                    <h1 class="text-xl font-bold text-slate-800">SMP NEGERI 4 PANDAK</h1>
                    <p class="text-sm text-slate-500">Remedial & Asesmen Sumatif</p>
                </div>
            </div>

            <!-- FORM LOGIN - Hapus semua event onsubmit di HTML -->
            <form id="login-form" class="space-y-4" onsubmit="return false;">
                
                <!-- INPUT MAPEL -->
                <div class="form-group" style="background: #e0f2fe; padding: 10px; border-radius: 8px; border: 1px solid #bae6fd;">
                    <label style="color: #0284c7;">Pilih Mata Pelajaran (Sesuai Jadwal)</label>
                    <select id="mapel-select" class="form-input" style="border-color: #0284c7; font-weight: bold; color: #0369a1;" required>
                        <option value="">-- Pilih Paket Soal --</option>
                        <!-- Diisi via JS -->
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label>Nama Lengkap</label>
                        <input type="text" id="nama" class="form-input" placeholder="Nama..." required autocomplete="off">
                    </div>
                    <!-- NOMOR ABSEN -->
                    <div class="form-group">
                        <label>Nomor Absen</label>
                        <input type="number" id="absen" class="form-input" placeholder="Contoh: 15" required autocomplete="off" min="1">
                    </div>
                </div>

                <div class="form-group">
                    <label>Kelas</label>
                    <select id="kelas-select" class="form-input" required>
                        <option value="">-- Pilih Kelas --</option>
                        <!-- Diisi via JS -->
                    </select>
                </div>

                <!-- 
                    TOMBOL MULAI:
                    - Default disabled agar user tahu sistem sedang loading
                    - Tidak ada onclick di HTML, 100% JS listener
                -->
                <button type="button" id="btn-start-exam" class="btn-main mt-6" disabled>
                    <i class="fas fa-spinner fa-spin"></i> SEDANG MEMUAT SISTEM...
                </button>
            </form>
            
            <div id="login-alert" class="hidden mt-3 p-3 bg-red-50 text-red-600 text-xs rounded border border-red-200 text-center font-bold"></div>
            
            <div class="mt-4 pt-3 border-t border-slate-100 text-center">
                <p class="text-xs text-slate-400">Pastikan GPS aktif jika diminta.</p>
                <div id="js-status" class="text-[10px] text-gray-300 mt-1">Menunggu inisialisasi...</div>
            </div>
        </div>
    </div>

    <!-- ================= HEADER UJIAN ================= -->
    <header id="exam-header" class="hidden header-custom shrink-0">
        <div class="header-left">
            <img src="https://raw.githubusercontent.com/atha-cyber/logo-/5eeaaecc00cf02080842f1cd6f4fc7bf13fe7f18/images.jfif" alt="Logo" class="school-logo">
            <div class="header-text">
                <h1>SMP NEGERI 4 PANDAK</h1>
                <p id="user-display">Peserta Ujian</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div class="hidden md:block text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded" id="mapel-display">Mapel</div>
            <!-- Timer -->
            <div id="timer-box" class="bg-indigo-50 text-indigo-700 border border-indigo-200 px-4 py-1 rounded-full font-mono font-bold flex gap-2 items-center text-sm shadow-sm">
                <i class="far fa-clock"></i> <span id="time-display">00:00:00</span>
            </div>
            <!-- Tombol Admin -->
            <button onclick="toggleAdmin(true)" class="p-2 rounded-full text-slate-400 hover:text-indigo-600 hover:bg-slate-100 transition">
                <i class="fas fa-lock" id="lock-icon"></i>
            </button>
        </div>
    </header>

    <!-- ================= BODY SPLIT SCREEN ================= -->
    <div id="exam-body" class="hidden flex-1 flex flex-col md:flex-row overflow-hidden relative bg-gray-200">
        <!-- PANEL KIRI: SOAL -->
        <div id="left-panel" class="flex-1 bg-gray-200 relative border-b-4 md:border-b-0 md:border-r-4 border-gray-300 flex flex-col transition-all duration-300">
            <!-- NEW: Tombol Mode Ringan (HP) -->
            <div class="absolute top-4 left-4 z-20 flex gap-2">
                 <button onclick="switchViewerMode()" id="btn-switch-mode" class="bg-white shadow-md hover:bg-orange-500 hover:text-white text-orange-600 px-3 py-2 rounded-lg transition transform hover:scale-105 border border-orange-200 text-xs font-bold flex items-center gap-2">
                    <i class="fas fa-mobile-alt"></i> Mode Ringan (HP)
                </button>
            </div>

            <button onclick="toggleFullPDF()" id="btn-toggle-pdf" class="absolute top-4 right-4 z-20 bg-white shadow-lg hover:bg-indigo-600 hover:text-white text-indigo-600 p-2 rounded-lg transition transform hover:scale-105 border border-indigo-100" title="Mode Layar Penuh">
                <i class="fas fa-expand fa-lg"></i>
            </button>
            
            <!-- DOCUMENT WRAPPER -->
            <div id="pdf-wrapper" class="w-full h-full relative">
                <!-- Viewer PDF.js -->
                <div id="pdf-render-container" class="hidden"></div>

                <!-- Viewer Gambar (Alternative) -->
                <div id="image-render-container" class="hidden">
                    <!-- Gambar akan dimasukkan di sini via JS -->
                </div>
                
                <!-- Fallback: Object / Embed Native -->
                <object id="pdf-object" data="" type="application/pdf" class="w-full h-full hidden"></object>
                
                <!-- Fallback Iframe (Google Viewer - Opsi Terakhir) -->
                <iframe id="soal-frame" src="" class="w-full h-full border-none hidden" title="Soal"></iframe>
                
                <!-- Placeholder / Loading / Error Message -->
                <div id="iframe-loader" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-100 z-10">
                    <div class="text-center p-4">
                        <i id="loader-icon" class="fas fa-spinner fa-spin fa-2x text-indigo-400 mb-2"></i>
                        <p id="loader-msg" class="text-gray-500 text-sm font-bold">Menyiapkan Dokumen Soal...</p>
                        
                        <!-- Tombol Darurat -->
                        <div id="fallback-actions" class="mt-4 hidden space-y-2">
                             <p class="text-red-500 text-xs mb-2">Gagal menampilkan di halaman ini.</p>
                             <!-- NEW: Fallback Button -->
                             <button onclick="switchViewerMode()" class="block w-full px-4 py-2 bg-orange-500 text-white rounded text-sm font-bold hover:bg-orange-600 shadow mb-2">
                                <i class="fas fa-bolt"></i> Gunakan Mode Ringan (Google)
                             </button>
                             
                             <a id="btn-open-newtab" href="#" target="_blank" class="block px-4 py-2 bg-indigo-600 text-white rounded text-sm font-bold hover:bg-indigo-700 shadow">
                                 <i class="fas fa-external-link-alt"></i> Buka Soal di Tab Baru
                             </a>
                             <button onclick="location.reload()" class="block w-full px-4 py-2 bg-gray-200 text-gray-700 rounded text-sm font-bold hover:bg-gray-300">
                                 Refresh Halaman
                             </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Kontrol Halaman PDF -->
            <div id="pdf-controls" class="hidden">
                <button id="prev-page" title="Previous Page"><i class="fas fa-chevron-left"></i></button>
                <span>Page <span id="page-num">1</span> / <span id="page-count">--</span></span>
                <button id="next-page" title="Next Page"><i class="fas fa-chevron-right"></i></button>
                <button onclick="zoomPDF(0.1)" title="Zoom In"><i class="fas fa-search-plus"></i></button>
                <button onclick="zoomPDF(-0.1)" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
            </div>
        </div>

        <!-- PANEL KANAN: LJK -->
        <div id="right-panel" class="w-full md:w-[380px] bg-white flex flex-col z-10 shadow-2xl h-[50vh] md:h-auto transition-all duration-300 border-l border-gray-200">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-slate-50">
                <span class="font-bold text-gray-700 text-lg" id="soal-no-display">No. 1</span>
                <div class="flex gap-2">
                     <span class="text-xs bg-emerald-100 text-emerald-800 px-2 py-1 rounded font-bold">Isi: <span id="count-filled">0</span></span>
                     <span class="text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded font-bold">Sisa: <span id="count-remaining">0</span></span>
                </div>
            </div>
            <div class="flex-1 p-5 overflow-y-auto bg-white relative">
                <!-- Layar Selesai (Konfirmasi) -->
                <div id="finish-screen" class="hidden absolute inset-0 bg-white z-20 flex flex-col items-center justify-center text-center p-6 animate-fade-in">
                    <div class="mb-4 inline-block rounded-full bg-blue-100 p-4 text-blue-600 animate-pulse">
                        <i class="fas fa-paper-plane fa-4x"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">Konfirmasi Selesai</h2>
                    <p class="text-gray-500 mb-6">Pastikan semua soal sudah terjawab. Klik tombol di bawah untuk mengirim jawaban.</p>
                    
                    <button onclick="calculateScore()" class="w-full max-w-xs bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 shadow-md flex justify-center items-center gap-2 mb-4">
                        <i class="fas fa-upload"></i> KIRIM & SIMPAN JAWABAN
                    </button>
                    
                    <button onclick="cancelFinish()" class="w-full max-w-xs bg-gray-200 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-300">
                        Batal, Cek Lagi
                    </button>
                </div>

                <!-- Layar Hasil Akhir (Setelah Submit) -->
                <div id="result-screen" class="hidden absolute inset-0 bg-white z-30 flex flex-col items-center justify-center text-center p-6 animate-fade-in">
                    <div class="mb-4 inline-block rounded-full bg-green-100 p-4 text-green-600">
                        <i class="fas fa-check-circle fa-4x"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">Jawaban Terkirim!</h2>
                    <p class="text-gray-500 mb-6 text-sm">Terima kasih telah mengerjakan ujian.</p>
                    
                    <div class="w-full max-w-xs bg-indigo-50 border border-indigo-100 rounded-xl p-6 shadow-sm mb-6">
                        <p class="text-xs font-bold text-indigo-500 uppercase tracking-widest mb-2">Nilai Akhir Anda</p>
                        <p class="text-6xl font-extrabold text-indigo-600" id="final-score">0</p>
                        <div class="flex justify-between mt-6 pt-4 border-t border-indigo-200 text-sm font-bold">
                            <span class="text-green-600">Benar: <span id="final-correct">0</span></span>
                            <span class="text-red-500">Salah: <span id="final-wrong">0</span></span>
                        </div>
                    </div>
                    
                    <button onclick="logoutExam()" class="w-full max-w-xs bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 shadow-md flex justify-center items-center gap-2">
                        <i class="fas fa-sign-out-alt"></i> KELUAR (LOGOUT)
                    </button>
                </div>

                <div id="options-container" class="space-y-3"></div>
            </div>
            <div id="footer-nav" class="p-4 bg-white border-t border-gray-100 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20">
                <label class="flex items-center gap-2 cursor-pointer w-fit select-none mb-3">
                    <input type="checkbox" id="ragu-check" class="w-4 h-4 text-amber-500 rounded focus:ring-amber-500 cursor-pointer" onchange="toggleRagu()">
                    <span class="text-sm font-bold text-amber-600 flex items-center gap-1"><i class="fas fa-flag"></i> Ragu-ragu</span>
                </label>
                <div class="flex gap-2 mb-4">
                    <button onclick="changeQuestion(-1)" class="px-4 py-2 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 text-gray-700 transition"><i class="fas fa-chevron-left"></i></button>
                    <button id="btn-next" onclick="changeQuestion(1)" class="flex-1 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition flex items-center justify-center gap-2 py-2 shadow-md shadow-indigo-200">Selanjutnya <i class="fas fa-chevron-right"></i></button>
                    <button id="btn-finish" onclick="finishExam()" class="hidden flex-1 bg-emerald-600 text-white rounded-lg font-bold hover:bg-emerald-700 transition flex items-center justify-center gap-2 py-2 shadow-md shadow-emerald-200"><i class="fas fa-check"></i> Selesai</button>
                </div>
                <div class="pt-3 border-t border-gray-100">
                    <p class="text-[10px] text-gray-400 mb-2 uppercase tracking-wider font-bold">Navigasi Soal</p>
                    <div id="question-grid" class="grid grid-cols-5 gap-2 max-h-32 overflow-y-auto pr-1"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= MODAL ADMIN ================= -->
    <div id="admin-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/60 p-4 backdrop-blur-sm">
        <div class="w-full max-w-2xl overflow-hidden rounded-xl bg-white shadow-2xl animate-fade-in flex flex-col max-h-[90vh]">
            <div class="flex items-center justify-between bg-slate-800 p-4 text-white shrink-0">
                <h3 class="flex items-center gap-2 font-bold text-lg"><i class="fas fa-user-shield"></i> Panel Admin & Manajemen</h3>
                <button onclick="toggleAdmin(false)" class="hover:text-red-400 transition"><i class="fas fa-times fa-lg"></i></button>
            </div>

            <div class="p-6 overflow-y-auto bg-slate-50 h-full">
                <!-- Login Admin -->
                <div id="admin-login-view">
                    <div class="text-center mb-6">
                        <div class="bg-slate-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-lock fa-2x text-slate-400"></i>
                        </div>
                        <p class="text-slate-600">Masukkan Password Guru (123)</p>
                    </div>
                    <input type="password" id="admin-pass" class="w-full form-input text-center text-lg mb-4" placeholder="***" autofocus>
                    <button onclick="loginAdmin()" class="btn-main bg-slate-800 hover:bg-slate-900">Masuk Panel</button>
                </div>

                <!-- Control View -->
                <div id="admin-control-view" class="hidden space-y-6">
                    
                    <!-- 1. MANAJEMEN JADWAL & MAPEL -->
                    <div class="admin-section">
                        <div class="admin-title text-indigo-700"><i class="fas fa-calendar-alt"></i> Manajemen Paket Soal & Jadwal</div>
                        
                        <!-- Form Tambah Mapel -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4 p-3 bg-indigo-50 rounded border border-indigo-100">
                            <div class="col-span-1 md:col-span-2">
                                <label class="text-xs font-bold text-indigo-600">Nama Paket Soal (Mapel)</label>
                                <input id="new-mapel-name" class="form-input text-sm" placeholder="Contoh: Matematika Paket A">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-indigo-600">Waktu Mulai</label>
                                <input type="datetime-local" id="new-mapel-start" class="form-input text-sm">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-indigo-600">Waktu Selesai</label>
                                <input type="datetime-local" id="new-mapel-end" class="form-input text-sm">
                            </div>
                            
                            <!-- TARGET KELAS -->
                            <div class="col-span-1 md:col-span-2">
                                <label class="text-xs font-bold text-indigo-600 mb-1 block">Target Kelas (Opsional):</label>
                                <div class="flex gap-2 mb-2 flex-wrap">
                                    <button onclick="selectGradeClasses('7')" class="bg-white border border-indigo-200 text-indigo-600 px-2 py-1 rounded text-xs hover:bg-indigo-50">Semua Kls 7</button>
                                    <button onclick="selectGradeClasses('8')" class="bg-white border border-indigo-200 text-indigo-600 px-2 py-1 rounded text-xs hover:bg-indigo-50">Semua Kls 8</button>
                                    <button onclick="selectGradeClasses('9')" class="bg-white border border-indigo-200 text-indigo-600 px-2 py-1 rounded text-xs hover:bg-indigo-50">Semua Kls 9</button>
                                    <button onclick="clearClassSelection()" class="bg-slate-200 text-slate-600 px-2 py-1 rounded text-xs hover:bg-slate-300">Reset</button>
                                </div>
                                <div id="class-checkboxes" class="grid grid-cols-5 gap-2 bg-white p-2 rounded border border-indigo-200 max-h-32 overflow-y-auto"></div>
                            </div>

                            <button onclick="addMapel()" class="col-span-1 md:col-span-2 bg-indigo-600 text-white py-2 rounded font-bold text-sm hover:bg-indigo-700 shadow-sm"><i class="fas fa-plus"></i> Tambah Paket Soal</button>
                        </div>

                        <!-- List Mapel -->
                        <div class="overflow-x-auto max-h-60 border border-slate-200 rounded">
                            <table class="w-full text-sm text-left text-slate-600 border border-slate-200">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                    <tr>
                                        <th class="px-3 py-2">Paket Soal</th>
                                        <th class="px-3 py-2">Kelas</th>
                                        <th class="px-3 py-2">Waktu</th>
                                        <th class="px-3 py-2 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="mapel-list-body">
                                    <!-- Diisi JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 2. MANAJEMEN KELAS -->
                    <div class="admin-section">
                        <div class="admin-title text-emerald-700"><i class="fas fa-users"></i> Manajemen Kelas</div>
                        <div class="flex gap-2 mb-3">
                            <input id="new-kelas-name" class="form-input text-sm" placeholder="Nama Kelas (misal: 9Z)">
                            <button onclick="addClass()" class="bg-emerald-600 text-white px-4 rounded font-bold text-sm hover:bg-emerald-700">Tambah</button>
                        </div>
                        <div id="kelas-list-container" class="flex flex-wrap gap-2">
                            <!-- Diisi JS -->
                        </div>
                    </div>

                    <!-- 3. KONFIGURASI SOAL PER MAPEL -->
                    <div class="admin-section">
                        <div class="admin-title text-fuchsia-700"><i class="fas fa-book"></i> Konfigurasi Soal & Kunci</div>
                        <p class="text-xs text-slate-500 mb-2 italic">Pilih Paket Soal di bawah ini untuk mengatur PDF dan Kunci Jawaban spesifik.</p>
                        
                        <div class="mb-4">
                            <label class="block text-xs font-bold text-fuchsia-700 mb-1">Pilih Paket Soal yg akan diedit:</label>
                            <select id="admin-mapel-select" class="form-input text-sm border-fuchsia-300 bg-fuchsia-50" onchange="loadPackageData()">
                                <option value="">-- Pilih Paket Soal --</option>
                                <!-- Diisi JS -->
                            </select>
                        </div>

                        <div id="package-config-area" class="opacity-50 pointer-events-none transition-all">
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-slate-500 mb-1">Link/File PDF atau Gambar</label>
                                <div class="flex gap-2 flex-col md:flex-row">
                                    <input type="file" id="input-file" accept="application/pdf,image/*" class="w-full md:w-1/2 text-xs" onchange="handleFileUpload(this)">
                                    <!-- UPDATED INPUT PLACEHOLDER -->
                                    <input id="input-url" class="w-full md:w-1/2 form-input text-xs" placeholder="Paste Link GitHub / Google Drive / Gambar di sini...">
                                </div>
                                <p class="text-[10px] text-green-600 mt-1 font-bold"><i class="fas fa-check-circle"></i> Tips: Jika PDF gagal dimuat, KONVERSI SOAL KE GAMBAR (.JPG) dan upload di sini. Gambar pasti aman.</p>
                            </div>
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-slate-500 mb-1">Kunci Jawaban (A-E)</label>
                                <textarea id="input-key" class="w-full h-16 form-input font-mono text-sm tracking-widest uppercase" placeholder="CONTOH: AABCC..."></textarea>
                                
                                <!-- INPUT JUMLAH SOAL -->
                                <div class="flex items-center gap-2 mt-2">
                                    <input type="number" id="gen-count" class="form-input text-xs w-20" placeholder="Jml Soal" min="1" max="100" value="50">
                                    <button onclick="generateRandomKeys()" class="bg-slate-200 text-slate-700 px-3 py-2 rounded text-xs hover:bg-slate-300 flex-1">
                                        <i class="fas fa-random"></i> Generate Kunci Random
                                    </button>
                                </div>
                                <p class="text-[10px] text-slate-400 mt-1">*Jumlah soal otomatis mengikuti panjang kunci jawaban di atas.</p>
                            </div>
                            <button onclick="savePackageConfig()" class="w-full bg-fuchsia-600 text-white py-2 rounded text-xs font-bold hover:bg-fuchsia-700 shadow-md">
                                <i class="fas fa-save"></i> Simpan Konfigurasi Paket Ini
                            </button>
                        </div>
                    </div>

                    <!-- 1. KONTROL GLOBAL (TRYOUT & RADIUS) - DARI E LOGO -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <!-- Tryout Mode -->
                        <div class="bg-emerald-50 border border-emerald-200 p-3 rounded-lg flex flex-col justify-between">
                            <div>
                                <h4 class="font-bold text-emerald-700 text-sm mb-1">ðŸš€ Mode Tryout (Global)</h4>
                                <p class="text-xs text-emerald-600 mb-2">Abaikan jadwal & lokasi. Buka semua.</p>
                            </div>
                            <button id="btn-tryout-toggle" onclick="toggleTryoutMode()" class="bg-white border border-emerald-300 text-emerald-700 py-1 px-3 rounded text-xs font-bold hover:bg-emerald-100 transition">OFF</button>
                        </div>
                        <!-- Radius Check -->
                        <div class="bg-orange-50 border border-orange-200 p-3 rounded-lg flex flex-col justify-between">
                            <div>
                                <h4 class="font-bold text-orange-700 text-sm mb-1">ðŸ“¡ Cek Lokasi (Anti-Joki)</h4>
                                <p class="text-xs text-orange-600 mb-2">Wajib radius 400m dari sekolah.</p>
                            </div>
                            <button id="btn-radius-toggle" onclick="toggleRadiusMode()" class="bg-white border border-orange-300 text-orange-700 py-1 px-3 rounded text-xs font-bold hover:bg-orange-100 transition">OFF</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mt-4">
                        <button onclick="downloadExcel()" class="bg-blue-600 text-white py-2 rounded font-bold text-xs"><i class="fas fa-download"></i> Rekap Excel</button>
                        <button onclick="resetData()" class="bg-red-600 text-white py-2 rounded font-bold text-xs"><i class="fas fa-trash"></i> Reset Data Nilai</button>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- ================= JAVASCRIPT ================= -->
    <script type="module">
        // Import Firebase dengan TRY-CATCH untuk antisipasi blokir
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // Variabel Global DB
        let db = null;
        let auth = null;
        let isFirebaseActive = false;

        // --- CONFIG FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyDy6E0FpxFAV8Fq2ayO1UWd2UMC19xLHgM", 
          authDomain: "vooting-guru.firebaseapp.com",
          projectId: "vooting-guru",
          storageBucket: "vooting-guru.firebasestorage.app",
          messagingSenderId: "643701954972",
          appId: "1:643701954972:web:5db3499faeb8ca91919059",
          measurementId: "G-MZV18MY9VM"
        };

        // --- INISIALISASI FIREBASE AMAN ---
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            isFirebaseActive = true;
            
            signInAnonymously(auth).catch((error) => {
                console.warn("Auth Error (Mungkin Domain Block):", error);
            });
        } catch (e) {
            console.error("Firebase Gagal Dimuat (Mode Offline):", e);
            document.getElementById('js-status').innerText = "Mode Offline (DB Error)";
            document.getElementById('js-status').style.color = "orange";
        }
        
        // --- KONFIGURASI KOLEKSI ---
        const COLLECTION_NAME = 'exam_results_all_subjects_v2';
        
        // --- KONFIGURASI UMUM ---
        let TOTAL_SOAL = 50; 
        
        const DEFAULT_PDF = "data:application/pdf;base64,JVBERi0xLjcKCjEgMCBvYmogICUgZW50cnkgcG9pbnQKPDwKICAvVHlwZSAvQ2F0YWxvZwogIC9QYWdlcyAyIDAgUgo+PgplbmRvYmoKCjIgMCBvYmoKPDwKICAvVHlwZSAvUGFnZXwKICAvTWVkaWFCb3ggWyAwIDAgMjAwIDIwMCBdCiAgL0NvdW50IDEKICAvS2lkcyBbIDMgMCBSIF0KPj4KZW5kb2JqCgozIDAgb2JqCjw8CiAgL1R5cGUgL1BhZ2UKICAvUGFyZW50IDIgMCBSCiAgL1Jlc291cmNlcyA8PAogICAgL0ZvbnQgPDwKICAgICAgL0YxIDQgMCBSCisgICAgPj4KICA+PgogIC9Db250ZW50cyA1IDAgUgo+PgplbmRvYmoKCjQgMCBvYmoKPDwKICAvVHlwZSAvRm9udAogIC9TdWJ0eXBlIC9UeXBlMQogIC9CYXNlRm9udCAvSGVsdmV0aWNhCj4+CmVuZG9iagoKNSAwIG9iago8PAogIC9MZW5ndGggNDQKPj4Kc3RyZWFtCkJUCjcwIDUwIFRECi9GMSAxMiBUZgooSGVsbG8sIHdvcmxkISkgVGoKRVQKZW5kc3RyZWFtCmVuZG9iagoKeHJlZgowIDYKMDAwMDAwMDAwMCA2NTUzNSBmIAowMDAwMDAwMDEwIDAwMDAwIG4gCjAwMDAwMDAwNjAgMDAwMDAgbiAKMDAwMDAwMDE1NyAwMDAwMCBuIAowMDAwMDAwMjY5IDAwMDAwIG4gCjAwMDAwMDAzNTcgMDAwMDAgbiAKdHJhaWxlcgo8PAogIC9TaXplIDYKICAvUm9vdCAxIDAgUgo+PgpzdGFydHhyZWYKNDUxCiUlRU9GCg==";
        
        const KEYS = {
            MAPEL: 'cbt_config_mapel_v4', 
            KELAS: 'cbt_config_kelas',
            GLOBAL: 'cbt_config_global' 
        };

        const SCHOOL_LAT = -7.927000;
        const SCHOOL_LNG = 110.297806;
        const MAX_DISTANCE = 400; 

        // --- STATE ---
        let currentNo = 1;
        let answers = {};
        let marked = {};
        let intervalTimer;
        let isFinished = false;
        let isFullPDF = false; 
        let isAdminLoggedIn = false;
        let activeSoalUrl = DEFAULT_PDF;
        let activeAnswerKey = {};
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 1.0;
        let canvas = null;
        let ctx = null;
        
        // Load Config Local
        let mapelList = JSON.parse(localStorage.getItem(KEYS.MAPEL) || '[]');
        let kelasList = JSON.parse(localStorage.getItem(KEYS.KELAS) || '["7A","7B","7C","7D","7E","8A","8B","8C","8D","8E","9A","9B","9C","9D","9E"]');
        let globalConfig = JSON.parse(localStorage.getItem(KEYS.GLOBAL) || '{"isTryout":false, "isRadius":false}');

        // --- INIT UTAMA (Dijalankan Saat Script Loaded) ---
        // Kita tidak pakai window.onload karena di module kadang telat
        // Kita jalan langsung
        
        // 1. Setup Data Default
        if(mapelList.length === 0) {
            const subjects = ['Pend. Agama', 'Informatika', 'Bahasa Indonesia', 'Pend. Pancasila', 'Matematika', 'PJOK', 'Bahasa Inggris', 'Bahasa Jawa', 'IPA', 'IPS', 'Seni Budaya'];
            let idCounter = 1;
            subjects.forEach(subj => {
                mapelList.push({ id: idCounter++, name: `${subj} (Kls 7)`, start: '', end: '', url: DEFAULT_PDF, key: {}, allowedClasses: ["7A","7B","7C","7D","7E"] });
                mapelList.push({ id: idCounter++, name: `${subj} (Kls 8)`, start: '', end: '', url: DEFAULT_PDF, key: {}, allowedClasses: ["8A","8B","8C","8D","8E"] });
                mapelList.push({ id: idCounter++, name: `${subj} (Kls 9)`, start: '', end: '', url: DEFAULT_PDF, key: {}, allowedClasses: ["9A","9B","9C","9D","9E"] });
            });
            localStorage.setItem(KEYS.MAPEL, JSON.stringify(mapelList));
        }

        // 2. Render UI Awal
        renderGrid(); 
        renderOptions();
        renderLoginDropdowns();
        updateGlobalButtons();
        
        // 3. EXPOSE GLOBAL FUNCTIONS (PENTING AGAR HTML BISA AKSES)
        window.toggleAdmin = toggleAdmin;
        window.loginAdmin = loginAdmin;
        window.addMapel = addMapel;
        window.deleteMapel = deleteMapel;
        window.loadPackageData = loadPackageData;
        window.savePackageConfig = savePackageConfig;
        window.handleFileUpload = handleFileUpload;
        window.generateRandomKeys = generateRandomKeys;
        window.downloadExcel = downloadExcel;
        window.resetData = resetData;
        window.addClass = addClass;
        window.deleteKelas = deleteKelas;
        window.selectGradeClasses = selectGradeClasses;
        window.clearClassSelection = clearClassSelection;
        window.toggleTryoutMode = toggleTryoutMode;
        window.toggleRadiusMode = toggleRadiusMode;
        window.updateSoal = updateSoal; 
        window.changeQuestion = changeQuestion;
        window.toggleFullPDF = toggleFullPDF;
        window.toggleRagu = toggleRagu;
        window.finishExam = finishExam;
        window.calculateScore = calculateScore;
        window.cancelFinish = cancelFinish;
        window.logoutExam = logoutExam;
        window.jumpTo = jumpTo;
        window.selectAnswer = selectAnswer;
        window.retryLoadPDF = retryLoadPDF;
        window.zoomPDF = zoomPDF;
        window.switchViewerMode = switchViewerMode; // NEW

        // 4. AKTIFKAN TOMBOL MULAI (CRITICAL FIX)
        // Kita gunakan ID untuk bind event listener, JANGAN onclick HTML
        const btnStart = document.getElementById('btn-start-exam');
        if(btnStart) {
            btnStart.disabled = false; // Aktifkan tombol
            btnStart.innerHTML = '<i class="fas fa-sign-in-alt"></i> MULAI MENGERJAKAN'; // Ubah teks
            btnStart.addEventListener('click', handleLoginManual); // Pasang fungsi
            
            // Debugging Visual
            document.getElementById('js-status').innerText = "Sistem Siap (Versi Stabil)";
            document.getElementById('js-status').style.color = "#4ade80"; // Green
        }
        
        // Bind tombol admin
        const btnAdminLogin = document.getElementById('btn-admin-login');
        if(btnAdminLogin) btnAdminLogin.onclick = () => toggleAdmin(true);

        // --- MANAJEMEN DATA LOCAL ---
        function saveMapelLocal() { 
            try {
                localStorage.setItem(KEYS.MAPEL, JSON.stringify(mapelList)); 
                renderLoginDropdowns(); 
                renderAdminLists(); 
                renderAdminPackageOptions(); 
            } catch (e) {
                alert("GAGAL MENYIMPAN! File terlalu besar untuk browser (Max 5MB). Gunakan Link External atau kompres file/gambar dulu.");
                console.error(e);
            }
        }
        function saveKelasLocal() { localStorage.setItem(KEYS.KELAS, JSON.stringify(kelasList)); renderLoginDropdowns(); renderAdminLists(); renderClassCheckboxes(); }
        function saveGlobal() { localStorage.setItem(KEYS.GLOBAL, JSON.stringify(globalConfig)); updateGlobalButtons(); }

        // --- UI RENDERING ---
        function renderLoginDropdowns() {
            const mapelSelect = document.getElementById('mapel-select');
            if(mapelSelect) {
                mapelSelect.innerHTML = '<option value="">-- Pilih Paket Soal --</option>';
                mapelList.forEach(m => { mapelSelect.innerHTML += `<option value="${m.id}">${m.name}</option>`; });
            }

            const kelasSelect = document.getElementById('kelas-select');
            if(kelasSelect) {
                kelasSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>';
                kelasList.forEach(k => { kelasSelect.innerHTML += `<option value="${k}">${k}</option>`; });
            }
        }

        function renderClassCheckboxes() {
            const container = document.getElementById('class-checkboxes');
            if(container) {
                container.innerHTML = '';
                kelasList.sort();
                kelasList.forEach(k => {
                    container.innerHTML += `<label class="flex items-center space-x-1 text-xs cursor-pointer p-1 border rounded hover:bg-slate-50"><input type="checkbox" value="${k}" class="class-target-cb rounded text-indigo-600 focus:ring-indigo-500"><span class="font-bold text-slate-700">${k}</span></label>`;
                });
            }
        }

        function renderAdminLists() {
            const tbody = document.getElementById('mapel-list-body');
            if(tbody) {
                tbody.innerHTML = '';
                mapelList.forEach((m, index) => {
                    let kelasInfo = "Semua";
                    if(m.allowedClasses && m.allowedClasses.length > 0) {
                        if(m.allowedClasses.length > 15) kelasInfo = m.allowedClasses.join(', ').substring(0, 20) + '...';
                        else kelasInfo = m.allowedClasses.join(', ');
                    }
                    tbody.innerHTML += `<tr class="bg-white border-b hover:bg-slate-50"><td class="px-3 py-2 font-medium text-slate-900">${m.name}</td><td class="px-3 py-2 text-xs font-bold text-indigo-600">${kelasInfo}</td><td class="px-3 py-2 text-xs text-slate-500">${formatDateTime(m.start)}</td><td class="px-3 py-2 text-center"><button onclick="deleteMapel(${index})" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button></td></tr>`;
                });
            }
            
            const kelasContainer = document.getElementById('kelas-list-container');
            if(kelasContainer) {
                kelasContainer.innerHTML = '';
                kelasList.forEach((k, index) => {
                    kelasContainer.innerHTML += `<div class="bg-emerald-100 text-emerald-800 text-xs font-bold px-2 py-1 rounded flex items-center gap-2">${k} <button onclick="deleteKelas(${index})" class="text-red-500 hover:text-red-700">Ã—</button></div>`;
                });
            }
        }

        function renderAdminPackageOptions() {
            const select = document.getElementById('admin-mapel-select');
            if(select) {
                select.innerHTML = '<option value="">-- Pilih Paket Soal --</option>';
                mapelList.forEach(m => { select.innerHTML += `<option value="${m.id}">${m.name}</option>`; });
            }
        }

        // --- HELPER ---
        function selectGradeClasses(grade) { document.querySelectorAll('.class-target-cb').forEach(cb => cb.checked = cb.value.startsWith(grade)); }
        function clearClassSelection() { document.querySelectorAll('.class-target-cb').forEach(cb => cb.checked = false); }
        function formatDateTime(iso) { if(!iso) return '-'; const d = new Date(iso); return d.toLocaleString('id-ID', {day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'}); }

        // --- GLOBAL CONFIGS ---
        function toggleTryoutMode() { globalConfig.isTryout = !globalConfig.isTryout; saveGlobal(); }
        function toggleRadiusMode() { globalConfig.isRadius = !globalConfig.isRadius; saveGlobal(); }
        function updateGlobalButtons() {
            const btnTryout = document.getElementById('btn-tryout-toggle');
            const btnRadius = document.getElementById('btn-radius-toggle');
            if(btnTryout) {
                btnTryout.innerText = globalConfig.isTryout ? "ON (AKTIF)" : "OFF";
                btnTryout.className = globalConfig.isTryout ? "bg-emerald-600 text-white px-3 py-1 rounded text-xs font-bold" : "bg-white border border-emerald-300 text-emerald-700 px-3 py-1 rounded text-xs font-bold";
            }
            if(btnRadius) {
                btnRadius.innerText = globalConfig.isRadius ? "ON (AKTIF)" : "OFF";
                btnRadius.className = globalConfig.isRadius ? "bg-orange-600 text-white px-3 py-1 rounded text-xs font-bold" : "bg-white border border-orange-300 text-orange-700 px-3 py-1 rounded text-xs font-bold";
            }
        }

        // --- GPS ---
        function checkLocation() {
            return new Promise((resolve) => {
                if(!navigator.geolocation) { alert("GPS Tidak Support"); resolve(false); return; }
                document.getElementById('loader').style.display = 'flex';
                navigator.geolocation.getCurrentPosition((pos) => {
                    document.getElementById('loader').style.display = 'none';
                    const dist = calculateDistance(pos.coords.latitude, pos.coords.longitude, SCHOOL_LAT, SCHOOL_LNG);
                    if(dist <= MAX_DISTANCE) resolve(true);
                    else { alert(`Di luar area sekolah (${Math.round(dist)}m).`); resolve(false); }
                }, () => { document.getElementById('loader').style.display = 'none'; alert("Gagal GPS"); resolve(false); }, {enableHighAccuracy:true});
            });
        }
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)*Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        
        // --- NEW: Force Google Viewer Fallback ---
        function switchViewerMode() {
            if(activeSoalUrl) {
                forceGoogleViewer(activeSoalUrl);
            }
        }

        function forceGoogleViewer(url) {
            const container = document.getElementById('pdf-render-container');
            const imageContainer = document.getElementById('image-render-container');
            const fallbackFrame = document.getElementById('soal-frame');
            const loader = document.getElementById('iframe-loader');
            const pdfObject = document.getElementById('pdf-object');
            
            // Clean UI
            container.innerHTML = '';
            container.classList.add('hidden');
            imageContainer.classList.add('hidden');
            pdfObject.classList.add('hidden');
            document.getElementById('pdf-controls').classList.add('hidden');
            
            // Encode URL untuk Google Viewer agar spasi (%20) aman
            const encodedUrl = encodeURIComponent(url);
            const viewerUrl = `https://docs.google.com/viewer?url=${encodedUrl}&embedded=true`;
            
            fallbackFrame.src = viewerUrl;
            fallbackFrame.classList.remove('hidden');
            loader.style.display = 'none';
        }

        // --- PDF.JS RENDERER (Hybrid Solution) + IMAGE SUPPORT ---
        function renderPDF(url) {
            const container = document.getElementById('pdf-render-container');
            const imageContainer = document.getElementById('image-render-container');
            const controls = document.getElementById('pdf-controls');
            const loader = document.getElementById('iframe-loader');
            const fallbackFrame = document.getElementById('soal-frame');
            const nativeObject = document.getElementById('pdf-object');
            const fallbackLink = document.getElementById('btn-open-newtab');
            const loaderMsg = document.getElementById('loader-msg');
            const fallbackActions = document.getElementById('fallback-actions');

            // Reset States
            container.innerHTML = '';
            imageContainer.innerHTML = ''; // Reset images
            
            container.classList.add('hidden');
            imageContainer.classList.add('hidden');
            controls.classList.add('hidden');
            fallbackFrame.classList.add('hidden');
            nativeObject.classList.add('hidden');
            
            loader.style.display = 'flex';
            fallbackActions.classList.add('hidden');
            loaderMsg.textContent = "Menyiapkan Dokumen Soal...";

            // AUTO FIX: GITHUB BLOB -> RAW
            if (url.includes('github.com') && url.includes('/blob/')) {
                url = url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
            }

            // 1. CEK JIKA GAMBAR (JPG/PNG/WEBP/DATA:IMAGE)
            const isImage = url.match(/\.(jpeg|jpg|png|webp)$/i) || url.startsWith('data:image/');
            
            if (isImage) {
                const img = document.createElement('img');
                img.src = url;
                img.className = 'exam-image';
                img.onload = () => {
                    imageContainer.appendChild(img);
                    imageContainer.style.display = 'flex'; // Show Flex
                    imageContainer.classList.remove('hidden');
                    loader.style.display = 'none';
                };
                img.onerror = () => {
                    loader.style.display = 'none'; // Hide loader
                    loaderMsg.innerText = "Gagal memuat gambar. Pastikan Link Publik/Direct (bukan viewer).";
                    fallbackActions.classList.remove('hidden');
                };
                return;
            }

            // 2. STRATEGI BASE64 PDF (Aman di InfinityFree)
            if (url.startsWith('data:application/pdf')) {
                renderPdfJs(url);
                return;
            } 
            
            // 3. STRATEGI GOOGLE DRIVE LINK
            if (url.includes('drive.google.com') || url.includes('docs.google.com')) {
                let embedUrl = url;
                if(url.includes('/view')) embedUrl = url.replace('/view', '/preview');
                else if(url.includes('/edit')) embedUrl = url.replace('/edit', '/preview');
                
                fallbackFrame.src = embedUrl; 
                fallbackFrame.classList.remove('hidden');
                loader.style.display = 'none';
                return;
            }

            // 4. STRATEGI PDF BIASA (HOSTING LOKAL/EKSTERNAL)
            renderPdfJs(url);
            
            // Set link cadangan di tombol error
            fallbackLink.href = url;
        }

        function renderPdfJs(url) {
            const container = document.getElementById('pdf-render-container');
            const controls = document.getElementById('pdf-controls');
            const loader = document.getElementById('iframe-loader');
            const loaderMsg = document.getElementById('loader-msg');
            const fallbackActions = document.getElementById('fallback-actions');

            // FIX: Gunakan URL yang sudah di-encode jika ada spasi, tapi PDF.js biasanya butuh raw string.
            // Kita coba load standard dulu.
            const loadingTask = pdfjsLib.getDocument(url);
            
            loadingTask.promise.then(function(pdf) {
                console.log('PDF loaded via PDF.js');
                pdfDoc = pdf;
                document.getElementById('page-count').textContent = pdf.numPages;

                container.classList.remove('hidden');
                controls.classList.remove('hidden');
                loader.style.display = 'none';

                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                     renderPage(pageNum);
                }
                
                document.getElementById('prev-page').style.display = 'none';
                document.getElementById('next-page').style.display = 'none';
                document.querySelector('#pdf-controls span').style.display = 'none';

            }, function (reason) {
                console.error("PDF.js Error:", reason);
                loaderMsg.textContent = "Gagal memuat PDF.js. Klik tombol oranye di bawah.";
                fallbackActions.classList.remove('hidden'); // Tampilkan tombol fallback
            });
        }

        function renderPage(num) {
            pdfDoc.getPage(num).then(function(page) {
                const viewport = page.getViewport({scale: scale});
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.className = 'pdf-page-canvas';
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                document.getElementById('pdf-render-container').appendChild(canvas);

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                page.render(renderContext);
            });
        }
        
        function zoomPDF(delta) {
             scale += delta;
             if(scale < 0.5) scale = 0.5;
             if(scale > 3.0) scale = 3.0;
             if(pdfDoc) {
                 document.getElementById('pdf-render-container').innerHTML = '';
                 for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) renderPage(pageNum);
             }
        }
        
        function onPrevPage() {} 
        function onNextPage() {}
        function retryLoadPDF() { if(activeSoalUrl) renderPDF(activeSoalUrl); }


        // --- LOGIN & START (MANUAL TRIGGER) ---
        async function handleLoginManual() {
            // Function wrapper agar bisa dipanggil dari HTML onclick
            const nama = document.getElementById('nama').value;
            const absen = document.getElementById('absen').value;
            const mapelId = document.getElementById('mapel-select').value;
            const kelas = document.getElementById('kelas-select').value;
            const alertBox = document.getElementById('login-alert');

            alertBox.classList.add('hidden');

            if(!mapelId || !kelas) {
                alertBox.textContent = "Pilih Paket Soal dan Kelas!";
                alertBox.classList.remove('hidden');
                return;
            }

            const selectedMapel = mapelList.find(m => m.id == mapelId);
            if(!selectedMapel) return;

            // 1. CEK KELAS
            if(selectedMapel.allowedClasses && selectedMapel.allowedClasses.length > 0) {
                if(!selectedMapel.allowedClasses.includes(kelas)) {
                    alertBox.innerHTML = `Paket <b>${selectedMapel.name}</b> TIDAK UNTUK kelas <b>${kelas}</b>.`;
                    alertBox.classList.remove('hidden'); return;
                }
            }

            // 2. CEK GLOBAL TRYOUT (Jika ON, bypass waktu & lokasi)
            if(!globalConfig.isTryout) {
                // Cek Jadwal
                const now = new Date();
                if(selectedMapel.start && now < new Date(selectedMapel.start)) {
                    alertBox.innerHTML = `Belum mulai.<br>Mulai: ${formatDateTime(selectedMapel.start)}`;
                    alertBox.classList.remove('hidden'); return;
                }
                if(selectedMapel.end && now > new Date(selectedMapel.end)) {
                    alertBox.innerHTML = `Sudah ditutup.<br>Selesai: ${formatDateTime(selectedMapel.end)}`;
                    alertBox.classList.remove('hidden'); return;
                }

                // Cek Radius
                if(globalConfig.isRadius) {
                    const allowed = await checkLocation();
                    if(!allowed) return;
                }
            }

            if(nama && absen) {
                // LOAD SOAL
                activeSoalUrl = selectedMapel.url || DEFAULT_PDF;
                activeAnswerKey = selectedMapel.key || {};
                
                // RENDER (PDF atau IMAGE)
                renderPDF(activeSoalUrl);

                // --- DETEKSI JUMLAH SOAL ---
                const keyCount = Object.keys(activeAnswerKey).length;
                TOTAL_SOAL = keyCount > 0 ? keyCount : 50;
                
                renderGrid();
                updateStats();
                
                document.getElementById('user-display').innerHTML = `<b>${nama}</b> (${kelas}-${absen})`;
                document.getElementById('mapel-display').innerText = selectedMapel.name;
                
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('exam-header').classList.remove('hidden');
                document.getElementById('exam-header').classList.add('flex');
                document.getElementById('exam-body').classList.remove('hidden');
                document.getElementById('exam-body').classList.add('flex');
                startTimer();
            }
        }

        // --- ADMIN: DATA ---
        function addMapel() {
            const name = document.getElementById('new-mapel-name').value;
            const start = document.getElementById('new-mapel-start').value;
            const end = document.getElementById('new-mapel-end').value;
            const cbs = document.querySelectorAll('.class-target-cb:checked');
            const classes = Array.from(cbs).map(cb => cb.value);
            
            if(!name) return alert("Nama wajib!");
            mapelList.push({ id: Date.now(), name, start, end, url: DEFAULT_PDF, key: {}, allowedClasses: classes });
            saveMapelLocal();
            document.getElementById('new-mapel-name').value = '';
        }
        function deleteMapel(idx) { if(confirm("Hapus?")) { mapelList.splice(idx, 1); saveMapelLocal(); } }
        
        function addClass() {
            const val = document.getElementById('new-kelas-name').value.toUpperCase();
            if(val && !kelasList.includes(val)) { kelasList.push(val); saveKelasLocal(); }
        }
        function deleteKelas(idx) { if(confirm("Hapus?")) { kelasList.splice(idx, 1); saveKelasLocal(); } }

        function loadPackageData() {
            const id = document.getElementById('admin-mapel-select').value;
            const area = document.getElementById('package-config-area');
            if(!id) { area.classList.add('opacity-50','pointer-events-none'); return; }
            area.classList.remove('opacity-50','pointer-events-none');
            
            const m = mapelList.find(x => x.id == id);
            document.getElementById('input-url').value = m.url || '';
            let k = "";
            const max = Math.max(...Object.keys(m.key||{}).map(Number),0);
            for(let i=1; i<=max; i++) k += (m.key[i] || '');
            document.getElementById('input-key').value = k;
        }

        // --- MODIFIED SAVE FUNCTION FOR GITHUB AUTO-CONVERT ---
        function savePackageConfig() {
            const id = document.getElementById('admin-mapel-select').value;
            let url = document.getElementById('input-url').value.trim(); // Trim whitespace
            
            // --- AUTO CONVERT GITHUB BLOB TO RAW ---
            // Jika admin copas link browser (ada 'blob'), ubah jadi 'raw' otomatis
            if (url.includes('github.com') && url.includes('/blob/')) {
                url = url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
                // Update tampilan input agar admin tahu linknya berubah
                document.getElementById('input-url').value = url; 
                alert("Sistem mendeteksi link GitHub Browser.\nLink otomatis diubah ke format RAW agar soal terbaca.");
            }
            // ---------------------------------------------------

            const keyRaw = document.getElementById('input-key').value.toUpperCase().replace(/[^A-E]/g, '');
            
            const idx = mapelList.findIndex(x => x.id == id);
            if(idx > -1) {
                // ENCODE URI HERE TO FIX SPACED LINKS ON MOBILE
                // Jangan di-encode semua karakter, cukup pastikan aman
                mapelList[idx].url = url; 
                
                const keys = {};
                for(let i=0; i<keyRaw.length; i++) keys[i+1] = keyRaw[i];
                mapelList[idx].key = keys;
                saveMapelLocal();
                alert(`Konfigurasi Tersimpan!\n\nLink Soal: ${url.substring(0,30)}...\nJumlah Kunci: ${keyRaw.length}`);
            } else {
                alert("Pilih Paket Soal terlebih dahulu!");
            }
        }

        function updateSoal() { savePackageConfig(); } // Alias for button

        function handleFileUpload(input) {
            if(input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) { 
                    // Support PDF dan Image (Base64)
                    document.getElementById('input-url').value = e.target.result; 
                    alert("File Siap (Base64)! Klik Simpan Konfigurasi."); 
                };
                reader.readAsDataURL(file);
            }
        }

        function generateRandomKeys() {
            const count = parseInt(document.getElementById('gen-count').value);
            let s = ""; for(let i=0;i<count;i++) s += ['A','B','C','D','E'][Math.floor(Math.random()*5)];
            document.getElementById('input-key').value = s;
        }

        // --- UJIAN LOGIC ---
        let WAKTU_DETIK = 90 * 60; 
        function startTimer() {
            updateTimeDisplay();
            intervalTimer = setInterval(() => { WAKTU_DETIK--; updateTimeDisplay(); if(WAKTU_DETIK <= 0) finishExam(); }, 1000);
        }
        function updateTimeDisplay() {
            const h = Math.floor(WAKTU_DETIK / 3600); const m = Math.floor((WAKTU_DETIK % 3600) / 60); const s = WAKTU_DETIK % 60;
            document.getElementById('time-display').textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }
        function toggleFullPDF() {
            isFullPDF = !isFullPDF;
            const rp = document.getElementById('right-panel'); const hd = document.getElementById('exam-header');
            if(isFullPDF) { rp.classList.add('hidden'); rp.classList.remove('flex'); hd.classList.add('hidden'); hd.classList.remove('flex'); }
            else { rp.classList.remove('hidden'); rp.classList.add('flex'); hd.classList.remove('hidden'); hd.classList.add('flex'); }
        }
        function changeQuestion(d) { const n = currentNo + d; if(n >= 1 && n <= TOTAL_SOAL) { currentNo = n; updateUI(); } }
        function jumpTo(n) { currentNo = n; updateUI(); }
        function updateUI() {
            document.getElementById('soal-no-display').textContent = `No. ${currentNo}`;
            const btnNext = document.getElementById('btn-next'); const btnFinish = document.getElementById('btn-finish');
            if(currentNo === TOTAL_SOAL) { btnNext.classList.add('hidden'); btnFinish.classList.remove('hidden'); btnFinish.classList.add('flex'); } 
            else { btnNext.classList.remove('hidden'); btnFinish.classList.add('hidden'); btnFinish.classList.remove('flex'); }
            document.getElementById('ragu-check').checked = !!marked[currentNo];
            renderOptions(); renderGrid(); updateStats();
        }
        function renderOptions() {
            const c = document.getElementById('options-container'); c.innerHTML='';
            ['A','B','C','D','E'].forEach(o => {
                const sel = answers[currentNo] === o;
                const btn = document.createElement('button');
                btn.className = `w-full flex items-center p-3 border rounded-lg transition-all active:scale-[0.98] ${sel ? 'bg-indigo-600 text-white shadow-md' : 'bg-white hover:bg-slate-50'}`;
                btn.onclick = () => selectAnswer(o);
                btn.innerHTML = `<span class="w-8 h-8 flex justify-center items-center rounded-full mr-3 border font-bold ${sel?'bg-white text-indigo-600':'bg-slate-100'}">${o}</span><span>Pilihan ${o}</span>`;
                c.appendChild(btn);
            });
        }
        function selectAnswer(o) { if(!isFinished) { answers[currentNo] = o; updateUI(); } }
        function toggleRagu() { if(!isFinished) { marked[currentNo] = !marked[currentNo]; updateUI(); } }
        function updateStats() {
            document.getElementById('count-filled').innerText = Object.keys(answers).length;
            document.getElementById('count-remaining').innerText = TOTAL_SOAL - Object.keys(answers).length;
        }
        function renderGrid() {
            const g = document.getElementById('question-grid'); g.innerHTML='';
            for(let i=1; i<=TOTAL_SOAL; i++) {
                const b = document.createElement('button');
                let cls = "h-8 rounded text-xs font-bold border transition-all ";
                if(answers[i]) cls += "bg-emerald-500 text-white border-emerald-600 ";
                else if(marked[i]) cls += "bg-amber-400 text-white ";
                else cls += "bg-white hover:bg-slate-50 ";
                if(i===currentNo) cls += "ring-2 ring-indigo-500 z-10 ";
                b.className = cls; b.textContent = i; b.onclick = () => jumpTo(i); g.appendChild(b);
            }
        }
        function finishExam() { if(!isFinished) { document.getElementById('finish-screen').classList.remove('hidden'); document.getElementById('finish-screen').classList.add('flex'); if(isFullPDF) toggleFullPDF(); } }
        function cancelFinish() { document.getElementById('finish-screen').classList.add('hidden'); document.getElementById('finish-screen').classList.remove('flex'); }
        function calculateScore() {
            isFinished = true; clearInterval(intervalTimer);
            const totalKeys = Object.keys(activeAnswerKey).length || TOTAL_SOAL;
            let correct = 0;
            for(const [k, v] of Object.entries(activeAnswerKey)) { if(answers[k] === v) correct++; }
            const score = Math.round((correct / totalKeys) * 100);
            
            document.getElementById('final-score').innerText = score;
            document.getElementById('final-correct').innerText = correct;
            document.getElementById('final-wrong').innerText = totalKeys - correct;
            
            document.getElementById('finish-screen').classList.add('hidden');
            document.getElementById('finish-screen').classList.remove('flex');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('result-screen').classList.add('flex');

            // Save to Firebase
            if (isFirebaseActive && db) {
                try {
                    const resultData = {
                        waktu: new Date().toLocaleString(),
                        nama: document.getElementById('nama').value,
                        kelas: document.getElementById('kelas-select').value,
                        absen: document.getElementById('absen').value,
                        mapel: document.getElementById('mapel-display').innerText,
                        nilai: score,
                        kunci_total: totalKeys,
                        jawaban_benar: correct
                    };
                    const docId = `${resultData.nama}_${resultData.mapel}_${Date.now()}`;
                    setDoc(doc(db, COLLECTION_NAME, docId), resultData);
                } catch(e) { console.error("Save error", e); alert("Gagal simpan online, catat nilai anda!"); }
            } else {
                alert("Mode Offline: Nilai tidak tersimpan ke database. Silakan screenshot hasil ini.");
            }
        }
        function logoutExam() { location.reload(); }

        // --- ADMIN UI ---
        function toggleAdmin(s) { 
            const m = document.getElementById('admin-modal'); 
            if(s) { m.classList.remove('hidden'); m.classList.add('flex'); if(isAdminLoggedIn) showAdminControls(); else showAdminLogin(); }
            else { m.classList.add('hidden'); m.classList.remove('flex'); }
        }
        function showAdminLogin() { document.getElementById('admin-login-view').classList.remove('hidden'); document.getElementById('admin-control-view').classList.add('hidden'); }
        function showAdminControls() { 
            document.getElementById('admin-login-view').classList.add('hidden'); document.getElementById('admin-control-view').classList.remove('hidden'); 
            renderAdminLists(); renderAdminPackageOptions(); renderClassCheckboxes();
        }
        function loginAdmin() { if(document.getElementById('admin-pass').value === '123') { isAdminLoggedIn=true; showAdminControls(); } else alert("Salah"); }
        
        async function downloadExcel() {
            if(!isFirebaseActive) return alert("Fitur ini butuh koneksi database (online).");
            const btn = document.activeElement; const oldText = btn.innerText; btn.innerText = "â³ Downloading...";
            try {
                const snap = await getDocs(collection(db, COLLECTION_NAME));
                let rows = [];
                snap.forEach(d => rows.push(d.data()));
                
                // Sort: Mapel > Kelas > Absen
                rows.sort((a,b) => {
                    if(a.mapel !== b.mapel) return a.mapel.localeCompare(b.mapel);
                    const kA = a.kelas.match(/(\d+)([A-Z])/);
                    const kB = b.kelas.match(/(\d+)([A-Z])/);
                    if(kA && kB) {
                        if(kA[1] !== kB[1]) return kA[1] - kB[1];
                        if(kA[2] !== kB[2]) return kA[2].localeCompare(kB[2]);
                    }
                    return (parseInt(a.absen)||0) - (parseInt(b.absen)||0);
                });

                let table = `<table border="1"><thead><tr style="background:#4f46e5;color:white;"><th>Waktu</th><th>Nama</th><th>Absen</th><th>Kelas</th><th>Mapel</th><th>Nilai</th></tr></thead><tbody>`;
                rows.forEach(r => {
                    table += `<tr><td>${r.waktu}</td><td>${r.nama}</td><td>${r.absen}</td><td>${r.kelas}</td><td>${r.mapel}</td><td>${r.nilai}</td></tr>`;
                });
                table += `</tbody></table>`;
                
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob(['\ufeff', table], {type:'application/vnd.ms-excel'}));
                a.download = `Rekap_Nilai_CBT_${new Date().toLocaleDateString()}.xls`;
                a.click();
            } catch(e) { alert("Error: "+e.message); }
            btn.innerText = oldText;
        }
        function resetData() { 
            if(!isFirebaseActive) return alert("Fitur ini butuh koneksi database.");
            if(!confirm("Hapus DATA NILAI di Database?")) return;
            // Logic delete collection (client-side delete all docs)
            getDocs(collection(db, COLLECTION_NAME)).then(snap => {
                snap.forEach(d => deleteDoc(d.ref));
                alert("Data bersih.");
            });
        }
    </script>
</body>
</html>
