<!DOCTYPE html>
<html lang="id" translate="no" class="notranslate">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CBT Online Multi-Mapel (Secure Shield)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .option-radio:checked + div {
            background-color: #2563eb; 
            color: white;
            border-color: #2563eb;
            box-shadow: 0 0 10px rgba(37, 99, 235, 0.3);
            transform: scale(1.05);
        }

        /* PERISAI SCROLL & GESTURE */
        body { 
            overscroll-behavior: none; /* Mencegah pull-to-refresh */
            touch-action: pan-x pan-y; /* Mencegah gesture swipe back browser */
        }
        
        .split-container { height: calc(100dvh - 50px); } 
        
        .tab-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; }

        /* Loading Spinner Overlay */
        #firebase-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #location-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9999;
            display: none; flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #e2e8f0; 
            border-top: 4px solid #2563eb; border-radius: 50%; 
            animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* WARNING OVERLAY (ANTI-CHEAT) */
        #cheatOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(220, 38, 38, 0.95); /* RED BACKGROUND */
            z-index: 200; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center; padding: 20px;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden font-sans text-gray-800">

    <!-- FIREBASE LOADER -->
    <div id="firebase-loader">
        <div class="spinner"></div>
        <p class="text-blue-600 font-bold text-sm animate-pulse">Menghubungkan Server...</p>
    </div>

    <!-- LOCATION LOADER -->
    <div id="location-loader">
        <i class="fas fa-map-marker-alt text-4xl text-red-500 mb-4 animate-bounce"></i>
        <p class="font-bold text-lg">Memeriksa Lokasi Anda...</p>
        <p class="text-xs text-gray-400 mt-2">Pastikan GPS aktif & izinkan akses lokasi browser</p>
    </div>

    <!-- ANTI-CHEAT WARNING OVERLAY -->
    <div id="cheatOverlay">
        <i class="fas fa-exclamation-triangle text-6xl mb-4 text-yellow-300 animate-bounce"></i>
        <h2 class="text-3xl font-bold mb-2">PELANGGARAN TERDETEKSI!</h2>
        <p class="text-lg mb-6">Anda terdeteksi meninggalkan halaman ujian.</p>
        
        <div class="bg-white/20 p-4 rounded-lg border border-white/30 mb-6">
            <p class="text-sm font-bold uppercase tracking-widest">Sisa Nyawa</p>
            <div class="flex justify-center gap-2 mt-2 text-2xl" id="lifeIcons">
                <i class="fas fa-heart text-red-500"></i>
                <i class="fas fa-heart text-red-500"></i>
                <i class="fas fa-heart text-red-500"></i>
            </div>
        </div>

        <button onclick="window.resumeExam()" class="bg-white text-red-600 px-8 py-3 rounded-full font-bold shadow-lg hover:bg-gray-100 transition transform hover:scale-105">
            KEMBALI KE UJIAN
        </button>
        <p class="text-xs mt-4 opacity-70">Sistem mencatat setiap aktivitas mencurigakan.</p>
    </div>

    <!-- 1. HALAMAN LOGIN PESERTA (DATA DIRI) -->
    <div id="loginOverlay" class="fixed inset-0 bg-slate-900 z-[150] hidden flex flex-col items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden relative">
            
            <div class="bg-blue-600 p-6 text-center relative z-10">
                <!-- LOGO SEKOLAH DENGAN FUNGSI KLIK RAHASIA -->
                <img src="https://i.ibb.co.com/DfC8xNjL/LOGO-HD-SMP-4-removebg-preview.png"
                     alt="Logo Sekolah"
                     id="secretLogo"
                     onclick="window.handleSecretClick()"
                     title="Ketuk 4x untuk Admin"
                     class="h-24 mx-auto mb-3 object-contain drop-shadow-md hover:scale-105 transition-transform duration-300 select-none cursor-pointer"
                     onerror="this.onerror=null; this.parentElement.innerHTML='<i class=\'fas fa-user-graduate text-4xl text-white mb-2\'></i><p class=\'text-xs text-red-200 mt-1\'>Gagal memuat logo</p>';">
                
                <h2 class="text-xl font-bold text-white">Data Peserta Ujian</h2>
                <p class="text-blue-100 text-xs">Silakan isi identitas dengan benar</p>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama Lengkap</label>
                    <input type="text" id="loginName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-bold text-gray-800 placeholder-gray-300" placeholder="Contoh: Ahmad Budi">
                </div>
                <div class="flex gap-4">
                    <div class="w-1/2">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kelas</label>
                        <select id="loginClass" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-bold text-gray-800 bg-white text-center appearance-none cursor-pointer">
                            <option value="">Pilih</option>
                            <!-- Opsi akan diisi otomatis oleh Javascript -->
                        </select>
                    </div>
                    <div class="w-1/2">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">No. Absen</label>
                        <select id="loginNumber" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-bold text-gray-800 bg-white text-center appearance-none cursor-pointer">
                            <option value="">Pilih</option>
                            <!-- Opsi akan diisi otomatis oleh Javascript -->
                        </select>
                    </div>
                </div>
                
                <button onclick="window.processLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition transform active:scale-95 mt-4">
                    MASUK UJIAN <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 2. OVERLAY BLOCKER (Jadwal / Menunggu) -->
    <div id="blockerOverlay" class="fixed inset-0 bg-slate-900 z-[100] hidden flex flex-col items-center justify-center text-white text-center p-6">
        <i id="blockerIcon" class="fas fa-calendar-alt text-5xl mb-4 text-blue-400"></i>
        <h2 id="blockerTitle" class="text-2xl font-bold mb-2">Tidak Ada Ujian Aktif</h2>
        <div class="bg-slate-800 p-4 rounded-lg max-w-md w-full border border-slate-700 mt-4 shadow-xl">
            <h3 class="text-sm font-bold text-gray-400 mb-2 uppercase tracking-wider border-b border-gray-600 pb-1">Jadwal Ujian</h3>
            <ul id="scheduleList" class="text-left text-sm space-y-2 max-h-40 overflow-y-auto custom-scroll pr-2"></ul>
        </div>
        
        <button onclick="window.openAdminLogin()" class="mt-8 text-xs text-slate-500 hover:text-slate-300 flex items-center gap-1 opacity-50 hover:opacity-100 transition">
            <i class="fas fa-cog"></i> Panel Guru
        </button>
    </div>

    <!-- HEADER -->
    <header class="h-[50px] bg-slate-900 text-white flex items-center px-4 shadow-lg z-30 relative justify-between">
        
        <!-- KIRI: Nama Mapel (Fleksibel) -->
        <div class="flex items-center gap-2 overflow-hidden flex-1 min-w-0 mr-4">
            <!-- LABEL PILIH UJIAN -->
            <div class="bg-yellow-500 text-black font-bold text-xs px-2 py-0.5 rounded shrink-0 whitespace-nowrap" id="headerSlot">PILIH UJIAN</div>
            
            <!-- NAMA MAPEL (Truncate jika panjang) -->
            <span id="headerMapel" class="font-bold text-sm tracking-wide truncate block">Menunggu Jadwal...</span>
            
            <select id="mapelSelector" onchange="window.loadExam(this.value)" class="hidden bg-slate-700 text-white text-sm border-none rounded px-2 py-1 focus:ring-2 focus:ring-blue-500 w-full max-w-[200px] shadow-inner font-bold cursor-pointer hover:bg-slate-600 truncate"></select>
        </div>

        <!-- KANAN: Tombol Kontrol (Fixed, tidak menyusut) -->
        <div class="flex items-center gap-1 flex-shrink-0">
             <button onclick="window.changePdfZoom(-0.1)" class="bg-slate-700 hover:bg-slate-600 text-white w-8 h-8 rounded flex items-center justify-center transition active:scale-95" title="Perkecil Tampilan">
                <i class="fas fa-minus text-xs"></i>
            </button>
            <button onclick="window.changePdfZoom(0.1)" class="bg-slate-700 hover:bg-slate-600 text-white w-8 h-8 rounded flex items-center justify-center transition active:scale-95" title="Perbesar Tampilan">
                <i class="fas fa-plus text-xs"></i>
            </button>
            <button onclick="window.reloadPDF()" class="bg-blue-600 hover:bg-blue-500 text-white w-8 h-8 rounded flex items-center justify-center transition active:scale-95" title="Refresh Soal">
                <i class="fas fa-sync-alt text-xs"></i>
            </button>
            <span id="zoomLabel" class="hidden">100%</span>
        </div>
    </header>

    <!-- MAIN LAYOUT -->
    <div class="split-container flex flex-col md:flex-row relative">
        <!-- KIRI / ATAS: Soal PDF (DOMINAN 65% di HP, 70% di PC) -->
        <div class="w-full h-[65%] md:h-full md:w-[70%] bg-gray-200 relative z-10 group overflow-hidden">
            
            <!-- PERISAI TOOLBAR PDF (TRANSPARENT SHIELD) -->
            <!-- Div ini menutupi bagian atas iframe (toolbar Google) sehingga tidak bisa diklik -->
            <div class="absolute top-0 left-0 w-full h-14 bg-transparent z-50 cursor-default"></div>

            <!-- Iframe PDF -->
            <iframe id="pdfFrame" src="" class="w-full h-full origin-top-left transition-transform duration-200 block" frameborder="0"></iframe>
            
            <div id="pdfPlaceholder" class="absolute inset-0 flex items-center justify-center text-slate-500 hidden bg-slate-100">
                <div class="text-center p-4">
                    <i class="fas fa-file-pdf text-4xl text-gray-300 mb-2"></i>
                    <p class="text-gray-500 font-bold">Memuat Soal...</p>
                </div>
            </div>
        </div>

        <!-- KANAN / BAWAH: LJK (KECIL 35% di HP, 30% di PC) -->
        <div class="w-full h-[35%] md:h-full md:w-[30%] bg-white flex flex-col z-20 shadow-2xl relative border-t-4 md:border-t-0 md:border-l-4 border-slate-300">
            <!-- AREA JAWABAN -->
            <div class="flex-1 overflow-y-auto custom-scroll p-2 bg-slate-50 relative">
                <form id="ljkForm" class="grid grid-cols-1 gap-2 pb-40"></form>
            </div>

            <!-- TOMBOL KIRIM -->
            <div class="p-3 bg-white border-t border-slate-200 shadow-[0_-5px_15px_rgba(0,0,0,0.1)] z-30">
                <button onclick="window.submitExam()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg active:scale-95 transition flex justify-center items-center gap-2">
                    <i class="fas fa-paper-plane"></i> SELESAI & KIRIM
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL LOGIN ADMIN -->
    <div id="adminLoginModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[160] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-xs shadow-2xl border border-gray-200">
            <h3 class="text-lg font-bold text-center mb-4 text-slate-800">Panel Guru</h3>
            <input type="password" id="adminPass" placeholder="Masukkan Password" class="w-full border p-2 rounded mb-4 text-center text-lg focus:ring-2 focus:ring-blue-500 outline-none">
            <div class="flex gap-2">
                <button onclick="window.closeModal('adminLoginModal')" class="flex-1 bg-gray-200 py-2 rounded font-semibold text-gray-700 hover:bg-gray-300">Batal</button>
                <button onclick="window.verifyAdmin()" class="flex-1 bg-blue-600 py-2 rounded font-semibold text-white hover:bg-blue-700">Masuk</button>
            </div>
        </div>
    </div>

    <!-- PANEL ADMIN -->
    <div id="adminPanel" class="fixed inset-0 bg-gray-100 z-[120] hidden flex flex-col">
        <div class="bg-slate-800 text-white p-4 flex justify-between items-center shadow-md shrink-0">
            <h2 class="font-bold text-lg"><i class="fas fa-cogs mr-2"></i>Pengaturan Ujian (50 Slot)</h2>
            <button onclick="window.closeModal('adminPanel'); window.checkAccess();" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm font-bold shadow">Tutup</button>
        </div>
        
        <div class="flex-1 overflow-hidden flex flex-col md:flex-row">
            <!-- Sidebar Tabs -->
            <div class="bg-white w-full md:w-56 flex md:flex-col overflow-x-auto md:overflow-y-auto custom-scroll shrink-0 border-b md:border-r border-gray-200">
                <button onclick="window.switchTab('general')" id="tabgeneral" class="tab-btn p-4 text-sm font-bold text-gray-600 border-b md:border-b-0 md:border-l-4 hover:bg-gray-50 text-left whitespace-nowrap shrink-0"><i class="fas fa-sliders-h mr-2"></i>Umum</button>
                
                <!-- CONTAINER TAB MAPEL (Diisi JS) -->
                <div id="mapelTabsContainer" class="flex md:flex-col"></div>
                
                <button onclick="window.switchTab('rekap')" id="tabrekap" class="tab-btn p-4 text-sm font-bold text-purple-600 border-b md:border-b-0 md:border-l-4 hover:bg-purple-50 text-left whitespace-nowrap shrink-0 mt-auto"><i class="fas fa-download mr-2"></i>Rekap Nilai</button>
            </div>

            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto p-4 md:p-6 bg-slate-50">
                
                <!-- SECTION: PENGATURAN UMUM -->
                <div id="generalSection" class="hidden space-y-6">
                    <!-- MODE MANUAL -->
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-bold text-gray-700">Mode Akses Manual (Buka Semua)</h4>
                                <p class="text-xs text-gray-500">Jika AKTIF, semua mapel dicentang di bawah akan muncul tanpa jadwal.<br>Jika MATI, mapel hanya muncul saat jadwal berlangsung (Live).</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggleForceMode" class="sr-only peer" onchange="window.toggleForceMode()">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <div id="forceModeStatus" class="mt-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Status: Mengikuti Jadwal</div>
                    </div>

                    <!-- TOGGLE ANTI CHEAT (BARU) -->
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-bold text-gray-700">Fitur Anti-Curang (Proteksi)</h4>
                                <p class="text-xs text-gray-500">Jika AKTIF: Blokir copy-paste, klik kanan, dan deteksi pindah tab (nyawa 3).</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggleAntiCheat" class="sr-only peer" onchange="window.toggleAntiCheat()">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                            </label>
                        </div>
                        <div id="antiCheatStatus" class="mt-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Status: Proteksi Aktif</div>
                    </div>

                    <!-- SETTING GEOFENCING (BARU) -->
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h4 class="font-bold text-gray-700">Batasi Lokasi Ujian (Geofencing)</h4>
                                <p class="text-xs text-gray-500">Siswa hanya bisa login jika berada dalam radius tertentu dari sekolah.</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggleGeoCheck" class="sr-only peer" onchange="window.toggleGeoCheck()">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        
                        <div id="geoSettings" class="space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Latitude</label>
                                    <input type="text" id="inputLat" class="w-full p-2 border rounded text-sm bg-gray-50 font-mono" placeholder="-7.919827">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Longitude</label>
                                    <input type="text" id="inputLng" class="w-full p-2 border rounded text-sm bg-gray-50 font-mono" placeholder="110.298794">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Radius Maksimal (Meter)</label>
                                <input type="number" id="inputRadius" class="w-full p-2 border rounded text-sm bg-gray-50 font-mono" placeholder="300">
                            </div>
                            <button onclick="window.saveGeoSettings()" class="bg-blue-600 text-white px-4 py-2 rounded text-xs font-bold w-full hover:bg-blue-700 transition"><i class="fas fa-save mr-1"></i> Simpan Koordinat</button>
                        </div>
                        <div id="geoStatus" class="mt-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Status: Lokasi Bebas</div>
                    </div>

                    <!-- KELOLA TAMPILAN MAPEL (VISIBILITY) -->
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                        <div class="border-b border-gray-100 pb-3 mb-3">
                            <h4 class="font-bold text-gray-700"><i class="fas fa-eye mr-2 text-blue-500"></i>Kelola Tampilan Mapel</h4>
                            <p class="text-xs text-gray-500">Centang mapel yang ingin ditampilkan di daftar "Pilih Ujian".<br>Mapel yang tidak dicentang akan <b>DISEMBUNYIKAN</b> dari siswa.</p>
                        </div>
                        <div id="visibilityList" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-60 overflow-y-auto custom-scroll pr-2">
                            <!-- List Generated by JS -->
                        </div>
                    </div>

                    <!-- TAMPILKAN NILAI -->
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-bold text-gray-700">Tampilkan Nilai ke Siswa</h4>
                                <p class="text-xs text-gray-500">Jika mati, siswa hanya melihat konfirmasi "Terkirim" tanpa skor.</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggleShowScore" class="sr-only peer" onchange="window.toggleShowScore()">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                            </label>
                        </div>
                        <div id="showScoreStatus" class="mt-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Status: Nilai Disembunyikan</div>
                    </div>
                </div>

                <!-- Form Setting Mapel -->
                <div id="mapelConfigForm" class="hidden">
                    <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center">
                        <span class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center mr-2" id="formSlotNum">1</span>
                        Konfigurasi <span id="formSlotName" class="ml-1">Mapel 1</span>
                    </h3>
                    
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama Mata Pelajaran</label>
                            <input type="text" id="inputName" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 font-bold text-gray-800" placeholder="Contoh: Matematika">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Link Soal (PDF)</label>
                            <input type="text" id="inputUrl" class="w-full p-2 border rounded font-mono text-sm text-blue-600" placeholder="https://...">
                            <p class="text-[10px] text-gray-400 mt-1">Pastikan link bisa diakses publik (Google Drive / GitHub Raw)</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mulai</label>
                                <input type="datetime-local" id="inputStart" class="w-full p-2 border rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Selesai</label>
                                <input type="datetime-local" id="inputEnd" class="w-full p-2 border rounded text-sm">
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 mt-4">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Kunci Jawaban (40 Soal)</label>
                        <textarea id="inputKey" rows="2" class="w-full p-3 border rounded font-mono text-lg tracking-widest uppercase focus:ring-2 focus:ring-green-500 mb-4" placeholder="ABCD..."></textarea>
                        
                        <div class="flex justify-between mt-2 items-center">
                            <span id="keyCounter" class="text-xs font-bold text-gray-400">0/40</span>
                            <button onclick="window.saveCurrentTab()" class="bg-green-600 text-white px-6 py-2 rounded font-bold hover:bg-green-700 shadow transform active:scale-95 transition"><i class="fas fa-cloud-upload-alt mr-2"></i>Simpan</button>
                        </div>
                    </div>
                </div>

                <!-- Rekap Section -->
                <div id="rekapSection" class="hidden">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">Rekapitulasi Nilai</h3>
                    <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                        <div class="overflow-x-auto max-h-[60vh] custom-scroll">
                            <table class="w-full text-sm text-left"><thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0"><tr><th class="px-3 py-2">Waktu</th><th class="px-3 py-2">Mapel</th><th class="px-3 py-2">Nama</th><th class="px-3 py-2">Kls</th><th class="px-3 py-2">No</th><th class="px-3 py-2">B/S</th><th class="px-3 py-2">Nilai</th><th class="px-3 py-2 text-center">Aksi</th></tr></thead><tbody id="scoreTableBody"></tbody></table>
                        </div>
                        <div class="mt-4 flex gap-2 flex-wrap">
                            <button onclick="window.downloadXLS()" class="flex-1 bg-green-700 text-white py-2 rounded font-bold hover:bg-green-800"><i class="fas fa-file-excel mr-2"></i>Download Excel</button>
                            <button onclick="window.refreshRekap()" class="px-4 bg-blue-100 text-blue-600 rounded font-bold hover:bg-blue-200"><i class="fas fa-sync"></i></button>
                            <!-- TOMBOL HAPUS SEMUA DATA -->
                            <button id="btnDeleteAll" onclick="window.deleteAllData()" class="px-4 bg-red-600 text-white rounded font-bold hover:bg-red-700 border border-red-800" title="Hapus Semua Data"><i class="fas fa-trash-alt mr-2"></i>Hapus Semua</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">*Download Excel akan mencetak: Nama, Kelas, No Absen, Benar, Salah, dan Nilai Akhir.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL HASIL -->
    <div id="resultModal" class="fixed inset-0 bg-slate-900/90 backdrop-blur z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl relative animate-bounce-in text-center p-6">
            <h2 id="resTitle" class="text-2xl font-bold text-slate-800 mb-1">Hasil Ujian</h2>
            <p id="resMapelName" class="text-blue-600 font-bold text-sm mb-4">...</p>
            <div id="scoreContainer"><div class="text-6xl font-extrabold text-blue-600 mb-2" id="resScore">0</div><p class="text-gray-400 text-xs mb-6">Nilai Akhir</p><div class="grid grid-cols-2 gap-4 mb-6"><div class="bg-green-50 p-2 rounded"><span class="block text-xs text-green-600 font-bold">BENAR</span><span class="text-xl font-bold text-green-700" id="resCorrect">0</span></div><div class="bg-red-50 p-2 rounded"><span class="block text-xs text-red-600 font-bold">SALAH</span><span class="text-xl font-bold text-red-700" id="resWrong">0</span></div></div></div>
            <div id="hiddenScoreMsg" class="hidden py-6"><div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-check text-green-600 text-3xl"></i></div><p class="text-gray-600 font-bold">Jawaban Anda berhasil disimpan ke server.</p></div>
            <button onclick="window.closeModal('resultModal'); location.reload();" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold">Tutup & Keluar</button>
        </div>
    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, deleteDoc, getDocs, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyDy6E0FpxFAV8Fq2ayO1UWd2UMC19xLHgM", authDomain: "vooting-guru.firebaseapp.com", projectId: "vooting-guru", storageBucket: "vooting-guru.firebasestorage.app", messagingSenderId: "643701954972", appId: "1:643701954972:web:5db3499faeb8ca91919059", measurementId: "G-MZV18MY9VM" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const JUMLAH_SOAL = 40;
        const OPSI = ['A', 'B', 'C', 'D'];
        const CONFIG_DOC_PATH = 'cbt_apps/settings_v2'; 
        const RESULTS_COLLECTION = 'cbt_results';
        const TOTAL_MAPEL_SLOTS = 50; 

        // Initial with isActive true by default
        let subjects = Array(TOTAL_MAPEL_SLOTS).fill(null).map((_, i) => ({ 
            name: `Mapel ${i+1}`, 
            url: '', 
            start: '', 
            end: '', 
            key: '',
            isActive: true 
        }));

        let forcedMode = false;
        let showScore = false; 
        let antiCheatEnabled = true; 
        let geoCheckEnabled = false; // NEW STATE
        
        // GEO DEFAULTS
        let schoolLat = -7.919827;
        let schoolLng = 110.298794;
        let allowedRadius = 300;

        let examHistory = []; 
        let activeSubjectIndex = -1;
        let editingTabIndex = 0;
        let studentData = { name: '', class: '', number: '' };
        let currentPdfZoom = 1;

        // --- ANTI-CHEAT VARIABLES ---
        let violations = 0;
        const MAX_VIOLATIONS = 3;
        let examStarted = false;

        // --- LOGIC KLIK RAHASIA LOGO (KETUK 4 KALI) ---
        let logoClicks = 0;
        let logoTimer;

        window.handleSecretClick = function() {
            logoClicks++;
            clearTimeout(logoTimer);

            // Jika mencapai 4 klik
            if (logoClicks >= 4) {
                window.openAdminLogin();
                logoClicks = 0; // Reset
            } else {
                // Reset counter jika tidak diklik lagi dalam 800ms
                logoTimer = setTimeout(() => {
                    logoClicks = 0;
                }, 800);
            }
        }
        
        // --- ANTI-CHEAT LOGIC ---
        document.addEventListener('contextmenu', event => { 
            if(antiCheatEnabled) event.preventDefault(); 
        });

        document.addEventListener('keydown', function(e) {
            if (!antiCheatEnabled) return;
            // F12, Ctrl+U, Ctrl+S, Ctrl+P, Ctrl+Shift+I
            if (e.key === 'F12' || 
               (e.ctrlKey && (e.key === 'u' || e.key === 's' || e.key === 'p' || e.key === 'c' || e.key === 'v')) ||
               (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        });

        document.addEventListener('visibilitychange', function() {
            if (!antiCheatEnabled) return;
            if (examStarted && document.hidden) {
                recordViolation();
            }
        });

        function recordViolation() {
            if(!examStarted) return;
            violations++;
            updateLifeIcons();
            
            const overlay = document.getElementById('cheatOverlay');
            overlay.style.display = 'flex'; // Show Warning

            if (violations >= MAX_VIOLATIONS) {
                alert("PELANGGARAN MAKSIMAL TERCAPAI!\n\nAnda telah meninggalkan halaman ujian terlalu sering.\nJawaban Anda akan dikirim secara otomatis dan sesi diakhiri.");
                window.submitExam(true); // Force submit
            }
        }

        window.resumeExam = function() {
            const overlay = document.getElementById('cheatOverlay');
            overlay.style.display = 'none';
        }

        function updateLifeIcons() {
            const container = document.getElementById('lifeIcons');
            const livesLeft = MAX_VIOLATIONS - violations;
            let html = '';
            for(let i=0; i<MAX_VIOLATIONS; i++) {
                if (i < livesLeft) {
                    html += '<i class="fas fa-heart text-red-500"></i>'; 
                } else {
                    html += '<i class="far fa-heart text-gray-400"></i>'; 
                }
            }
            container.innerHTML = html;
        }
        // ----------------------------------------------

        // --- LOCATION LOGIC ---
        function getDistanceFromLatLonInMeters(lat1,lon1,lat2,lon2) {
            var R = 6371; // Radius of the earth in km
            var dLat = deg2rad(lat2-lat1);  
            var dLon = deg2rad(lon2-lon1); 
            var a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2)
                ; 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            var d = R * c; // Distance in km
            return d * 1000; // Meters
        }

        function deg2rad(deg) { return deg * (Math.PI/180) }

        async function verifyUserPosition() {
            if (!geoCheckEnabled) {
                // Skip if disabled
                completeLogin();
                return;
            }

            document.getElementById('location-loader').style.display = 'flex';

            if (!navigator.geolocation) {
                alert("Browser Anda tidak mendukung Geolocation.");
                document.getElementById('location-loader').style.display = 'none';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    const dist = getDistanceFromLatLonInMeters(userLat, userLng, schoolLat, schoolLng);
                    
                    document.getElementById('location-loader').style.display = 'none';

                    if (dist <= allowedRadius) {
                        completeLogin();
                    } else {
                        alert(`AKSES DITOLAK!\n\nPosisi Anda: ${Math.round(dist)} meter dari sekolah.\nBatas Maksimal: ${allowedRadius} meter.\n\nSilakan mendekat ke area sekolah.`);
                    }
                },
                (error) => {
                    document.getElementById('location-loader').style.display = 'none';
                    let msg = "Gagal mendeteksi lokasi.";
                    if(error.code == error.PERMISSION_DENIED) msg = "Izin lokasi ditolak! Harap izinkan akses lokasi untuk ujian.";
                    alert(msg);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function completeLogin() {
            window.closeModal('loginOverlay');
            window.checkAccess();
        }
        // ----------------------

        async function initApp() {
            renderAdminTabs();
            try {
                await signInAnonymously(auth);
                onSnapshot(doc(db, CONFIG_DOC_PATH), (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.subjects) {
                            subjects = subjects.map((def, i) => {
                                const dbSub = data.subjects[i] || {};
                                return { ...def, ...dbSub, isActive: dbSub.isActive !== false }; 
                            });
                        }
                        if (data.forcedMode !== undefined) forcedMode = data.forcedMode;
                        if (data.showScore !== undefined) showScore = data.showScore;
                        if (data.antiCheatEnabled !== undefined) antiCheatEnabled = data.antiCheatEnabled;
                        
                        // LOAD GEO SETTINGS
                        if (data.geoCheckEnabled !== undefined) geoCheckEnabled = data.geoCheckEnabled;
                        if (data.schoolLat !== undefined) schoolLat = data.schoolLat;
                        if (data.schoolLng !== undefined) schoolLng = data.schoolLng;
                        if (data.allowedRadius !== undefined) allowedRadius = data.allowedRadius;

                        updateForceModeUI(); 
                        updateShowScoreUI();
                        updateAntiCheatUI();
                        updateGeoUI(); // Update Admin inputs
                        updateTabNames();
                        renderVisibilityList(); 
                    } else { 
                        saveConfigToFirebase(); 
                    }
                    document.getElementById('firebase-loader').style.display = 'none';
                    if (studentData.name) window.checkAccess();
                });
                document.getElementById('loginOverlay').classList.remove('hidden');
            } catch (error) { console.error("Firebase Auth Error:", error); alert("Gagal terhubung server."); }
        }
        initApp();

        function renderAdminTabs() {
            const container = document.getElementById('mapelTabsContainer');
            container.innerHTML = '';
            for(let i=0; i<TOTAL_MAPEL_SLOTS; i++) {
                const btn = document.createElement('button');
                btn.onclick = () => window.switchTab(i);
                btn.id = `tab${i}`;
                btn.className = "tab-btn p-4 text-sm font-bold text-gray-600 border-b md:border-b-0 md:border-l-4 hover:bg-gray-50 text-left whitespace-nowrap shrink-0";
                btn.innerText = subjects[i].name;
                container.appendChild(btn);
            }
        }

        // NEW: RENDER VISIBILITY LIST IN GENERAL TAB
        function renderVisibilityList() {
            const container = document.getElementById('visibilityList');
            container.innerHTML = '';
            const now = new Date();
            
            subjects.forEach((sub, idx) => {
                let statusBadge = '';
                if(forcedMode) {
                    statusBadge = '<span class="text-[10px] bg-blue-100 text-blue-600 px-1 rounded ml-2">Manual ON</span>';
                } else {
                    if(!sub.start || !sub.end) {
                        statusBadge = '<span class="text-[10px] bg-gray-100 text-gray-400 px-1 rounded ml-2">No Jadwal</span>';
                    } else {
                        const start = new Date(sub.start);
                        const end = new Date(sub.end);
                        if(now >= start && now <= end) {
                            statusBadge = '<span class="text-[10px] bg-green-100 text-green-600 px-1 rounded ml-2 animate-pulse">LIVE</span>';
                        } else if (now < start) {
                            statusBadge = '<span class="text-[10px] bg-yellow-100 text-yellow-600 px-1 rounded ml-2">Belum</span>';
                        } else {
                            statusBadge = '<span class="text-[10px] bg-red-100 text-red-600 px-1 rounded ml-2">Selesai</span>';
                        }
                    }
                }

                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-2 rounded border ${sub.isActive ? 'bg-white border-gray-200' : 'bg-gray-50 border-gray-200 opacity-75'}`;
                div.innerHTML = `
                    <div class="flex items-center overflow-hidden w-2/3">
                        <span class="text-xs font-bold text-gray-700 truncate">${idx+1}. ${sub.name}</span>
                        ${statusBadge}
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" onchange="window.toggleSubjectVisibility(${idx})" class="sr-only peer" ${sub.isActive ? 'checked' : ''}>
                        <div class="w-9 h-5 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-500"></div>
                    </label>
                `;
                container.appendChild(div);
            });
        }

        window.toggleSubjectVisibility = async function(idx) {
            subjects[idx].isActive = !subjects[idx].isActive;
            renderVisibilityList(); // Optimistic update
            try {
                await setDoc(doc(db, CONFIG_DOC_PATH), { subjects: subjects }, { merge: true });
            } catch(e) {
                console.error(e);
                subjects[idx].isActive = !subjects[idx].isActive; // Revert on error
                renderVisibilityList();
                alert("Gagal update: " + e.message);
            }
        }

        function updateTabNames() {
            for(let i=0; i<TOTAL_MAPEL_SLOTS; i++) {
                const btn = document.getElementById(`tab${i}`);
                if(btn) {
                    btn.innerText = subjects[i].name;
                    // Optional: Visual cue for inactive tabs
                    if(!subjects[i].isActive) btn.classList.add('opacity-50', 'line-through');
                    else btn.classList.remove('opacity-50', 'line-through');
                }
            }
        }

        window.processLogin = function() {
            const name = document.getElementById('loginName').value.trim();
            const kelas = document.getElementById('loginClass').value.trim();
            const number = document.getElementById('loginNumber').value.trim();
            if (!name || !kelas || !number) { alert("Harap lengkapi data!"); return; }
            studentData = { name, class: kelas, number };
            
            // TRIGGER LOCATION CHECK
            verifyUserPosition();
        }

        window.initLJK = function() {
            const form = document.getElementById('ljkForm');
            form.innerHTML = ''; 
            for(let i=1; i<=JUMLAH_SOAL; i++){
                const div = document.createElement('div');
                div.id = `row-q${i}`; 
                div.className = 'bg-white p-2.5 rounded-lg border border-slate-200 shadow-sm flex items-center justify-between hover:bg-blue-50 transition';
                div.innerHTML = `<div class="w-8 text-center font-bold text-slate-600 text-sm">${i}.</div><div class="flex-1 flex justify-around pl-4">${OPSI.map(o => `<label class="cursor-pointer relative group"><input type="radio" name="q${i}" value="${o}" class="sr-only option-radio"><div class="w-10 h-10 rounded-full border-2 border-slate-300 flex items-center justify-center font-bold text-slate-500 transition-all hover:border-blue-400">${o}</div></label>`).join('')}</div>`;
                form.appendChild(div);
            }
            const classSelect = document.getElementById('loginClass');
            const grades = [7, 8, 9]; const letters = ['A', 'B', 'C', 'D', 'E'];
            grades.forEach(grade => { const optgroup = document.createElement('optgroup'); optgroup.label = `Kelas ${grade}`; letters.forEach(letter => { const option = document.createElement('option'); option.value = `${grade}${letter}`; option.innerText = `${grade}${letter}`; optgroup.appendChild(option); }); classSelect.appendChild(optgroup); });
            const numberSelect = document.getElementById('loginNumber');
            for (let i = 1; i <= 35; i++) { const option = document.createElement('option'); option.value = i; option.innerText = i; numberSelect.appendChild(option); }
        }
        window.initLJK();

        document.getElementById('inputKey').addEventListener('input', function(e) {
            const clean = this.value.toUpperCase().replace(/[^A-D]/g, '');
            this.value = clean;
            updateKeyCounter(clean.length);
        });

        function updateKeyCounter(len) {
            const label = document.getElementById('keyCounter');
            label.innerText = `${len}/${JUMLAH_SOAL}`;
            label.className = len === JUMLAH_SOAL ? "text-xs font-bold text-green-600" : "text-xs font-bold text-red-500";
        }

        window.toggleForceMode = async function() {
            const checkbox = document.getElementById('toggleForceMode');
            forcedMode = checkbox.checked;
            updateForceModeUI();
            renderVisibilityList(); // REFRESH BADGES
            try { await setDoc(doc(db, CONFIG_DOC_PATH), { forcedMode: forcedMode }, { merge: true }); } catch(e) { checkbox.checked = !checkbox.checked; }
        }
        window.toggleShowScore = async function() {
            const checkbox = document.getElementById('toggleShowScore');
            showScore = checkbox.checked;
            updateShowScoreUI();
            try { await setDoc(doc(db, CONFIG_DOC_PATH), { showScore: showScore }, { merge: true }); } catch(e) { checkbox.checked = !checkbox.checked; }
        }
        
        window.toggleAntiCheat = async function() {
            const checkbox = document.getElementById('toggleAntiCheat');
            antiCheatEnabled = checkbox.checked;
            updateAntiCheatUI();
            try { await setDoc(doc(db, CONFIG_DOC_PATH), { antiCheatEnabled: antiCheatEnabled }, { merge: true }); } 
            catch(e) { checkbox.checked = !checkbox.checked; }
        }

        // NEW: TOGGLE GEO CHECK
        window.toggleGeoCheck = async function() {
            const checkbox = document.getElementById('toggleGeoCheck');
            geoCheckEnabled = checkbox.checked;
            updateGeoUI();
            // We save everything together via saveGeoSettings, or separate? Let's save on toggle too for better UX
            try { await setDoc(doc(db, CONFIG_DOC_PATH), { geoCheckEnabled: geoCheckEnabled }, { merge: true }); }
            catch(e) { checkbox.checked = !checkbox.checked; }
        }

        window.saveGeoSettings = async function() {
            const lat = parseFloat(document.getElementById('inputLat').value);
            const lng = parseFloat(document.getElementById('inputLng').value);
            const rad = parseInt(document.getElementById('inputRadius').value);
            
            if (isNaN(lat) || isNaN(lng) || isNaN(rad)) {
                alert("Koordinat atau Radius tidak valid!");
                return;
            }

            schoolLat = lat; schoolLng = lng; allowedRadius = rad;
            
            try { 
                await setDoc(doc(db, CONFIG_DOC_PATH), { 
                    schoolLat: schoolLat, 
                    schoolLng: schoolLng, 
                    allowedRadius: allowedRadius 
                }, { merge: true }); 
                alert("Pengaturan Lokasi Tersimpan!");
            } catch(e) { alert("Gagal simpan: " + e.message); }
        }

        function updateForceModeUI() {
            const checkbox = document.getElementById('toggleForceMode'); if(checkbox) checkbox.checked = forcedMode;
            document.getElementById('forceModeStatus').innerText = forcedMode ? "Status: MODE MANUAL AKTIF (Buka Semua)" : "Status: Mengikuti Jadwal Otomatis";
        }
        function updateShowScoreUI() {
            const checkbox = document.getElementById('toggleShowScore'); if(checkbox) checkbox.checked = showScore;
            document.getElementById('showScoreStatus').innerText = showScore ? "Status: NILAI DITAMPILKAN" : "Status: Nilai Disembunyikan";
        }
        function updateAntiCheatUI() {
            const checkbox = document.getElementById('toggleAntiCheat'); if(checkbox) checkbox.checked = antiCheatEnabled;
            document.getElementById('antiCheatStatus').innerText = antiCheatEnabled ? "Status: PROTEKSI AKTIF (KETAT)" : "Status: Proteksi Nonaktif";
            document.body.oncontextmenu = antiCheatEnabled ? () => false : null;
        }
        
        function updateGeoUI() {
            const checkbox = document.getElementById('toggleGeoCheck'); if(checkbox) checkbox.checked = geoCheckEnabled;
            document.getElementById('geoStatus').innerText = geoCheckEnabled ? "Status: TERKUNCI LOKASI (GPS)" : "Status: Lokasi Bebas";
            
            document.getElementById('inputLat').value = schoolLat;
            document.getElementById('inputLng').value = schoolLng;
            document.getElementById('inputRadius').value = allowedRadius;
        }

        window.saveCurrentTab = async function() {
            const idx = editingTabIndex;
            const rawUrl = document.getElementById('inputUrl').value;
            const cleanUrl = rawUrl ? rawUrl.trim() : '';
            const rawKey = document.getElementById('inputKey').value.toUpperCase().replace(/[^A-D]/g, '');
            if (rawKey.length !== JUMLAH_SOAL && rawKey.length > 0) { if(!confirm(` PERINGATAN: Jumlah kunci (${rawKey.length}) tidak 40.\nTetap simpan?`)) return; }
            
            const currentActive = subjects[idx].isActive;
            
            subjects[idx] = { 
                name: document.getElementById('inputName').value || `Mapel ${idx+1}`, 
                url: cleanUrl, 
                start: document.getElementById('inputStart').value, 
                end: document.getElementById('inputEnd').value, 
                key: rawKey,
                isActive: currentActive 
            };
            
            try {
                await setDoc(doc(db, CONFIG_DOC_PATH), { subjects: subjects }, { merge: true });
                document.getElementById('formSlotName').innerText = subjects[idx].name;
                updateTabNames();
                renderVisibilityList(); 
                const sel = document.getElementById('mapelSelector'); if(sel && sel.options[idx]) sel.options[idx].text = subjects[idx].name;
                alert(`Pengaturan ${subjects[idx].name} TERSIMPAN!`);
            } catch(e) { alert("Gagal simpan: " + e.message); }
        }
        async function saveConfigToFirebase() { await setDoc(doc(db, CONFIG_DOC_PATH), { subjects: subjects, forcedMode: forcedMode, showScore: showScore, antiCheatEnabled: antiCheatEnabled, geoCheckEnabled: geoCheckEnabled, schoolLat: schoolLat, schoolLng: schoolLng, allowedRadius: allowedRadius }, { merge: true }); }

        window.checkAccess = function() {
            const blocker = document.getElementById('blockerOverlay'); const selector = document.getElementById('mapelSelector'); const labelMapel = document.getElementById('headerMapel');
            let activeIndices = [];
            
            if (forcedMode) { 
                activeIndices = subjects.map((s, i) => (s.isActive !== false) ? i : -1).filter(i => i !== -1);
            } else {
                const now = new Date();
                subjects.forEach((sub, idx) => { 
                    if (sub.isActive !== false && sub.start && sub.end) { 
                        const start = new Date(sub.start); 
                        const end = new Date(sub.end); 
                        if (now >= start && now <= end) activeIndices.push(idx); 
                    } 
                });
            }

            if (activeIndices.length === 0) { 
                blocker.classList.remove('hidden'); 
                renderScheduleList(); 
                selector.classList.add('hidden'); 
                labelMapel.classList.remove('hidden'); 
                labelMapel.innerText = "Menunggu Jadwal..."; 
            } else { 
                blocker.classList.add('hidden'); 
                const currentOptions = Array.from(selector.options).map(o => o.value).join(','); 
                const newOptions = activeIndices.join(','); 
                
                if (currentOptions !== newOptions) { 
                    selector.innerHTML = ''; 
                    activeIndices.forEach(idx => { 
                        const opt = document.createElement('option'); 
                        opt.value = idx; 
                        opt.text = subjects[idx].name; 
                        selector.add(opt); 
                    }); 
                }

                labelMapel.classList.add('hidden'); 
                selector.classList.remove('hidden'); 
                
                let targetIndex = activeSubjectIndex; 
                if (!activeIndices.includes(parseInt(activeSubjectIndex))) { 
                    targetIndex = activeIndices[0]; 
                    window.loadExam(targetIndex); 
                } 
                selector.value = targetIndex; 
                
                if (selector.options[selector.selectedIndex]) { 
                    selector.options[selector.selectedIndex].text = subjects[activeSubjectIndex].name; 
                }
            } 
        }

        function renderScheduleList() { 
            const list = document.getElementById('scheduleList'); 
            list.innerHTML = ''; 
            subjects.forEach((sub, idx) => { 
                if(sub.isActive !== false && sub.start && sub.end) { 
                    const sTime = new Date(sub.start).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}); 
                    const eTime = new Date(sub.end).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}); 
                    list.innerHTML += `<li class="border-b border-slate-700 pb-1 last:border-0"><span class="text-yellow-400 font-bold block text-xs">Mapel ${idx+1}: ${sub.name}</span><span class="text-slate-400 text-xs">${sTime} - ${eTime}</span></li>`; 
                } 
            }); 
            if(list.innerHTML === '') list.innerHTML = '<li class="text-xs text-gray-500 italic">Tidak ada jadwal aktif.</li>';
        }

        window.loadExam = function(index) {
            index = parseInt(index); activeSubjectIndex = index; const sub = subjects[index];
            document.getElementById('headerSlot').innerText = "PILIH UJIAN"; document.getElementById('headerMapel').innerText = sub.name;
            const frame = document.getElementById('pdfFrame'); const ph = document.getElementById('pdfPlaceholder');
            const sel = document.getElementById('mapelSelector'); if(sel && !sel.classList.contains('hidden')) sel.value = index;
            
            examStarted = true;
            violations = 0;
            updateLifeIcons();

            const cleanUrl = sub.url ? sub.url.trim() : '';
            if (cleanUrl) { 
                let finalSrc = cleanUrl;
                if (cleanUrl.includes('drive.google.com')) {
                    finalSrc = cleanUrl.replace(/\/view.*/, '/preview').replace(/\/sharing.*/, '/preview');
                } else {
                    finalSrc = `https://docs.google.com/viewer?url=${cleanUrl}&embedded=true`;
                }
                if(!finalSrc.includes('#')) finalSrc += "#toolbar=0&navpanes=0&scrollbar=0";
                if(frame.src !== finalSrc) frame.src = finalSrc; 
                ph.classList.add('hidden'); 
            } else { 
                frame.src = ''; ph.classList.remove('hidden'); 
                ph.innerHTML = `<div class="text-center p-6"><i class="fas fa-exclamation-circle text-4xl text-red-300 mb-2"></i><p class="text-red-500 font-bold">Link soal untuk <br>"${sub.name}"<br> belum diatur.</p></div>`; 
            }
        }
        window.reloadPDF = function() { document.getElementById('pdfFrame').src = document.getElementById('pdfFrame').src; }

        window.changePdfZoom = function(delta) {
            let newZoom = currentPdfZoom + delta;
            if(newZoom < 0.5) newZoom = 0.5;
            if(newZoom > 2.5) newZoom = 2.5;
            newZoom = Math.round(newZoom * 10) / 10;
            applyPdfZoom(newZoom);
        }

        window.resetPdfZoom = function() {
            applyPdfZoom(1);
        }

        function applyPdfZoom(zoom) {
            currentPdfZoom = zoom;
            const frame = document.getElementById('pdfFrame');
            const label = document.getElementById('zoomLabel');
            if(frame) {
                frame.style.transform = `scale(${zoom})`;
                frame.style.width = `${100 / zoom}%`;
                frame.style.height = `${100 / zoom}%`;
            }
            if(label) {
                label.innerText = `${Math.round(zoom * 100)}%`;
            }
        }

        window.submitExam = async function(forceSubmit = false) {
            if (activeSubjectIndex === -1) return; if(!studentData.name) return alert('Data tidak valid.');
            
            if (!forceSubmit) {
                let unanswered = [];
                for(let i=1; i<=JUMLAH_SOAL; i++){
                    const row = document.getElementById(`row-q${i}`);
                    if(row) { row.classList.remove('bg-red-50', 'border-red-500', 'ring-1', 'ring-red-500'); row.classList.add('bg-white', 'border-slate-200'); }
                }
                for(let i=1; i<=JUMLAH_SOAL; i++){
                    const el = document.querySelector(`input[name="q${i}"]:checked`);
                    if (!el) {
                        unanswered.push(i);
                        const row = document.getElementById(`row-q${i}`);
                        if(row) { row.classList.remove('bg-white', 'border-slate-200'); row.classList.add('bg-red-50', 'border-red-500', 'ring-1', 'ring-red-500'); }
                    }
                }
                if (unanswered.length > 0) {
                    const firstMiss = document.getElementById(`row-q${unanswered[0]}`);
                    if(firstMiss) firstMiss.scrollIntoView({behavior: 'smooth', block: 'center'});
                    let listStr = unanswered.join(', ');
                    if (unanswered.length > 15) listStr = unanswered.slice(0, 15).join(', ') + '...';
                    
                    // PERUBAHAN: BLOCKIR JIKA ADA YANG KOSONG
                    alert(` MAAF, TIDAK BISA KIRIM!\n\nAnda masih memiliki soal yang belum dijawab:\nNomor: ${listStr}\n\nSilakan lengkapi semua jawaban terlebih dahulu.`);
                    return; // HENTIKAN PROSES DI SINI
                } else {
                    if(!confirm(`Halo ${studentData.name}, jawaban sudah lengkap.\nYakin ingin mengirim jawaban ke server?`)) return;
                }
            }

            examStarted = false;

            const sub = subjects[activeSubjectIndex]; const key = sub.key || ''; 
            let correct = 0; for(let i=1; i<=JUMLAH_SOAL; i++){ const el = document.querySelector(`input[name="q${i}"]:checked`); const val = el ? el.value : 'X'; const keyChar = key[i-1] || '?'; if(val === keyChar) correct++; }
            const scoreRaw = (correct / JUMLAH_SOAL) * 100;
            const score = Number.isInteger(scoreRaw) ? scoreRaw : parseFloat(scoreRaw.toFixed(2));

            const wibTime = new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' });
            
            let detailStr = `${correct} Benar, ${JUMLAH_SOAL-correct} Salah`;
            if (violations > 0) {
                detailStr += ` (Pelanggaran: ${violations})`;
            }

            const resultData = { time: wibTime, mapel: sub.name, name: studentData.name, class: studentData.class, number: studentData.number, score: score, correct: correct, detail: detailStr, timestamp: Date.now() };
            const uniqueDocId = `${sub.name}_${studentData.class}_${studentData.number}_${studentData.name}`.replace(/[^a-zA-Z0-9]/g, '_').toUpperCase();
            const docRef = doc(db, RESULTS_COLLECTION, uniqueDocId);
            try {
                const docSnap = await getDoc(docRef); if (docSnap.exists()) { return alert(" AKSES DITOLAK! Data sudah ada."); }
                await setDoc(docRef, resultData);
                document.getElementById('resMapelName').innerText = sub.name;
                if (showScore) { document.getElementById('resScore').innerText = score; document.getElementById('resCorrect').innerText = correct; document.getElementById('resWrong').innerText = JUMLAH_SOAL - correct; document.getElementById('scoreContainer').classList.remove('hidden'); document.getElementById('hiddenScoreMsg').classList.add('hidden'); document.getElementById('resTitle').innerText = "Hasil Ujian"; } 
                else { document.getElementById('scoreContainer').classList.add('hidden'); document.getElementById('hiddenScoreMsg').classList.remove('hidden'); document.getElementById('resTitle').innerText = "Terkirim!"; }
                document.getElementById('resultModal').classList.remove('hidden');
                
                if(forceSubmit) {
                    document.getElementById('cheatOverlay').style.display = 'none';
                }

            } catch(e) { alert("Gagal kirim: " + e.message); }
        }

        window.openAdminLogin = function() { document.getElementById('adminLoginModal').classList.remove('hidden'); document.getElementById('adminLoginModal').style.zIndex = "160"; }
        window.closeModal = function(id) { document.getElementById(id).classList.add('hidden'); }
        // PASSWORD SUDAH DIUBAH KE admin123
        window.verifyAdmin = function() { if(document.getElementById('adminPass').value === 'admin123'){ window.closeModal('adminLoginModal'); window.closeModal('loginOverlay'); window.closeModal('blockerOverlay'); document.getElementById('adminPanel').classList.remove('hidden'); window.switchTab('general'); } else { alert('Salah password'); } }

        window.switchTab = function(idx) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'border-blue-500', 'bg-blue-50'));
            document.getElementById('rekapSection').classList.add('hidden'); document.getElementById('mapelConfigForm').classList.add('hidden'); document.getElementById('generalSection').classList.add('hidden');
            if (idx === 'rekap') { document.getElementById('tabrekap').classList.add('active', 'bg-purple-50'); document.getElementById('rekapSection').classList.remove('hidden'); window.refreshRekap(); }
            else if (idx === 'general') { document.getElementById('tabgeneral').classList.add('active', 'bg-blue-50'); document.getElementById('generalSection').classList.remove('hidden'); renderVisibilityList(); }
            else { editingTabIndex = idx; const btn = document.getElementById(`tab${idx}`); if(btn) btn.classList.add('active'); document.getElementById('mapelConfigForm').classList.remove('hidden'); const data = subjects[idx]; document.getElementById('formSlotNum').innerText = idx + 1; document.getElementById('formSlotName').innerText = data.name; document.getElementById('inputName').value = data.name; document.getElementById('inputUrl').value = data.url; document.getElementById('inputStart').value = data.start; document.getElementById('inputEnd').value = data.end; document.getElementById('inputKey').value = data.key || ''; document.getElementById('inputKey').dispatchEvent(new Event('input')); }
        }

        window.refreshRekap = async function() {
            const tbody = document.getElementById('scoreTableBody'); tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4">Loading...</td></tr>';
            try {
                const q = query(collection(db, RESULTS_COLLECTION), orderBy('timestamp', 'desc')); const snap = await getDocs(q);
                tbody.innerHTML = ''; examHistory = [];
                if(snap.empty) { tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4">Kosong.</td></tr>'; return; }
                snap.forEach((d) => { const r = d.data(); examHistory.push(r); const wrong = JUMLAH_SOAL - (r.correct || 0); tbody.innerHTML += `<tr class="bg-white border-b text-xs"><td class="px-3 py-2 text-slate-400">${r.time}</td><td class="px-3 py-2 font-bold text-slate-500">${r.mapel}</td><td class="px-3 py-2 font-bold">${r.name}</td><td class="px-3 py-2">${r.class}</td><td class="px-3 py-2">${r.number}</td><td class="px-3 py-2 text-gray-500">${r.correct}/${wrong}</td><td class="px-3 py-2 font-bold text-blue-600">${r.score}</td><td class="px-3 py-2 text-center"><button onclick="window.deleteStudentData('${d.id}', '${r.name}')" class="bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200 text-[10px] font-bold"><i class="fas fa-trash-alt"></i></button></td></tr>`; });
            } catch(e) { tbody.innerHTML = '<tr><td colspan="8" class="text-center text-red-500">Error.</td></tr>'; }
        }

        window.deleteStudentData = async function(docId, name) { if(!confirm(`Hapus data ${name}?`)) return; try { await deleteDoc(doc(db, RESULTS_COLLECTION, docId)); alert("Reset berhasil."); window.refreshRekap(); } catch(e) { alert("Gagal: " + e.message); } }
        
        window.deleteAllData = async function() {
            if(!confirm(" PERINGATAN KERAS!\n\nApakah Anda yakin ingin MENGHAPUS SEMUA DATA HASIL UJIAN?\n\nTindakan ini tidak dapat dibatalkan!")) return;
            if(!confirm("Konfirmasi Terakhir:\nHapus semua data sekarang?")) return;

            const btn = document.getElementById('btnDeleteAll');
            const oldText = btn.innerHTML;
            btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Menghapus...";
            btn.disabled = true;

            try {
                const q = query(collection(db, RESULTS_COLLECTION));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    alert("Data sudah kosong.");
                    return;
                }
                const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);
                alert(" Semua data berhasil dihapus bersih.");
                window.refreshRekap();
            } catch (error) {
                console.error(error);
                alert("Gagal menghapus sebagian data: " + error.message);
            } finally {
                btn.innerHTML = oldText;
                btn.disabled = false;
            }
        }

        window.downloadXLS = function() {
            if(examHistory.length === 0) return alert("Data kosong.");
            
            // Sort data: Kelas (Asc), then No Absen (Asc)
            const sortedHistory = [...examHistory].sort((a, b) => {
                // Compare Class
                if (a.class < b.class) return -1;
                if (a.class > b.class) return 1;
                
                // Compare Number (Numeric)
                return (parseInt(a.number) || 0) - (parseInt(b.number) || 0);
            });

            let html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>Rekap Nilai</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--><meta charset="utf-8"></head><body>';
            html += '<table border="1" style="font-family: Arial, sans-serif; border-collapse: collapse;">';
            html += '<thead><tr style="background-color: #f0f0f0;"><th>Waktu</th><th>Mata Pelajaran</th><th>Nama Siswa</th><th>Kelas</th><th>No Absen</th><th>Benar</th><th>Salah</th><th>Nilai Akhir</th><th>Info Tambahan</th></tr></thead>';
            html += '<tbody>';
            sortedHistory.forEach(r => { 
                const correct = r.correct || 0;
                const wrong = JUMLAH_SOAL - correct;
                const score = r.score !== undefined ? r.score : 0;
                // Parse detail string for "Pelanggaran"
                let violationInfo = "-";
                if(r.detail && r.detail.includes("Pelanggaran")) {
                    violationInfo = r.detail.split('(')[1].replace(')','');
                }
                html += `<tr><td>${r.time}</td><td>${r.mapel}</td><td>${r.name}</td><td style="text-align:center">${r.class}</td><td style="text-align:center">${r.number}</td><td style="text-align:center">${correct}</td><td style="text-align:center">${wrong}</td><td style="text-align:center; font-weight:bold;">${score}</td><td>${violationInfo}</td></tr>`; 
            });
            html += '</tbody></table></body></html>';
            const blob = new Blob([html], {type: 'application/vnd.ms-excel'}); 
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Rekap_Nilai_CBT_${new Date().toISOString().slice(0,10)}.xls`; a.click();
        }
    </script>
</body>
                            </html>
