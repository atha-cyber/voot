<!DOCTYPE html>
<html lang="id" translate="no" class="notranslate">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, minimal-ui">
    <meta name="theme-color" content="#2563eb">
    <title>CBT Siswa - Ujian Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .option-radio:checked + div { background-color: #2563eb; color: white; border-color: #2563eb; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.4); }
        body { overscroll-behavior-y: none; touch-action: pan-x pan-y; -webkit-user-select: none; user-select: none; }
        .glass-header { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(5px); }
        #pdfContainer { width: 100%; height: 100%; overflow: auto; position: relative; background-color: #525659; }
        iframe#pdfFrame { display: block; border: none; width: 100%; height: 100%; transform-origin: 0 0; transition: transform 0.05s ease-out; }
        .drive-shield { position: absolute; top: 0; left: 0; width: 100%; height: 60px; z-index: 50; }
        * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        input, select, textarea { -webkit-user-select: text; user-select: text; }
    </style>
</head>
<body class="bg-gray-100 h-[100dvh] w-screen overflow-hidden font-sans text-gray-800 flex flex-col">

    <div id="dashboardView" class="fixed inset-0 bg-slate-50 z-[200] flex flex-col overflow-hidden">
        <div class="bg-blue-600 pb-12 pt-6 px-6 rounded-b-[2.5rem] shadow-lg shrink-0 text-center">
            <div class="relative z-10 flex flex-col items-center">
                <img src="https://i.ibb.co.com/DfC8xNjL/LOGO-HD-SMP-4-removebg-preview.png" alt="Logo" class="h-24 w-auto mb-3 drop-shadow-md">
                <h1 class="text-2xl font-extrabold text-white">CBT Online</h1>
                <span class="text-blue-200 text-xs font-bold tracking-widest uppercase">SMP Negeri 4 Pandak</span>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto -mt-8 px-4 pb-10 custom-scroll z-20">
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100 mb-6">
                <h3 class="font-bold text-gray-700 mb-4 text-sm uppercase tracking-wide border-b pb-2">Identitas Peserta</h3>
                <div class="space-y-4">
                    <input type="text" id="loginName" class="w-full p-3 border rounded-lg font-bold bg-gray-50 uppercase outline-none focus:ring-2 focus:ring-blue-500" placeholder="KETIK NAMA ANDA...">
                    <div class="flex gap-3">
                        <select id="loginClass" class="w-1/2 p-3 border rounded-lg font-bold bg-gray-50 outline-none focus:ring-2 focus:ring-blue-500"><option value="">- Kelas -</option></select>
                        <select id="loginNumber" class="w-1/2 p-3 border rounded-lg font-bold bg-gray-50 outline-none focus:ring-2 focus:ring-blue-500"><option value="">- No Absen -</option></select>
                    </div>
                </div>
            </div>
            <h3 class="font-bold text-gray-600 mb-3 px-2 text-sm uppercase">Ujian Tersedia</h3>
            <div id="examGrid" class="grid grid-cols-1 gap-3"></div>
        </div>
    </div>

    <div id="firebase-loader" class="fixed inset-0 bg-white/95 flex flex-col justify-center items-center z-[250] hidden">
        <div class="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
        <p class="text-blue-600 font-bold text-sm mt-4" id="loaderText">Menghubungkan Server Aman...</p>
    </div>

    <header class="h-14 glass-header text-white flex items-center px-3 justify-between shadow-md shrink-0 z-[60] relative">
        <div class="flex flex-col">
            <span id="headerMapel" class="font-bold text-sm">...</span>
            <div id="timerContainer" class="flex items-center gap-1.5 text-xs font-mono text-yellow-300">
                <i class="fas fa-clock"></i> <span id="timerDisplay">00:00:00</span>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="window.reloadFrame()" class="w-8 h-8 rounded bg-white/10 flex items-center justify-center"><i class="fas fa-sync-alt text-xs"></i></button>
            <button onclick="window.confirmExit()" class="bg-red-500 text-white w-8 h-8 rounded flex items-center justify-center shadow-md"><i class="fas fa-power-off text-xs"></i></button>
        </div>
    </header>

    <div class="flex-1 relative overflow-hidden bg-gray-200">
        <div id="view-soal" class="absolute inset-0 md:w-[70%] h-full z-10 bg-white overflow-hidden">
            <div class="drive-shield"></div>
            <div id="pdfContainer">
                <iframe id="pdfFrame" src="" class="w-full h-full"></iframe>
            </div>
        </div>

        <div id="view-ljk" class="absolute inset-0 md:w-[30%] md:left-[70%] bg-slate-50 h-full z-20 translate-y-full md:translate-y-0 transition-transform duration-300 flex flex-col border-l">
            <div class="flex-1 overflow-y-auto p-3 custom-scroll">
                <div id="saveStatus" class="text-[10px] text-green-600 font-bold text-center mb-2 opacity-0 uppercase">Tersimpan Otomatis</div>
                <form id="ljkForm" class="grid grid-cols-1 gap-2"></form>
                <button id="btnSubmit" onclick="window.submitExam()" class="w-full mt-4 py-3 rounded-lg font-bold shadow uppercase text-xs" disabled>Kirim Jawaban</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let db, auth;
        const CONFIG_DOC = 'cbt_apps/settings_v2';
        const RES_COLL = 'cbt_results';
        let subjects = [], selectedIdx = -1, studentData = {}, qCount = 40;

        async function startSecureApp() {
            const loader = document.getElementById('firebase-loader');
            const loaderText = document.getElementById('loaderText');
            loader.classList.remove('hidden');
            
            try {
                const response = await fetch('/api/get-config');
                if (!response.ok) throw new Error('Gagal memanggil API Server');
                
                const firebaseConfig = await response.json();
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                await signInAnonymously(auth);
                
                onSnapshot(doc(db, CONFIG_DOC), (snap) => {
                    if(snap.exists()) {
                        subjects = snap.data().subjects || [];
                        renderList();
                    }
                });
                loader.classList.add('hidden');
            } catch (e) {
                console.error(e);
                loaderText.innerText = "Kesalahan: " + e.message;
            }
        }

        function renderList() {
            const g = document.getElementById('examGrid'); g.innerHTML = '';
            subjects.forEach((s, i) => {
                if(s.isActive !== false) {
                    g.innerHTML += `<div class="bg-white p-4 rounded-xl shadow-sm border flex justify-between items-center"><h3 class="font-bold text-gray-700 text-sm uppercase">${s.name}</h3><button onclick="window.attemptStart(${i})" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold text-xs uppercase">Buka</button></div>`;
                }
            });
        }

        window.attemptStart = async (idx) => {
            const n = document.getElementById('loginName').value.trim(), c = document.getElementById('loginClass').value, no = document.getElementById('loginNumber').value;
            if(!n || !c || !no) return alert("Lengkapi Identitas!");
            studentData = {name:n, class:c, number:no}; selectedIdx = idx;
            loadExam(idx);
            document.getElementById('dashboardView').classList.add('hidden');
        };

        function loadExam(idx) {
            const s = subjects[idx];
            document.getElementById('headerMapel').innerText = s.name;
            qCount = s.qCount || 40;
            const f = document.getElementById('ljkForm'); f.innerHTML = '';
            for(let j=1; j<=qCount; j++){
                f.innerHTML += `<div class="bg-white p-2 border flex items-center justify-between"><span class="text-xs font-bold">${j}.</span><div class="flex gap-2">${['A','B','C','D'].map(o=>`<label><input type="radio" name="q${j}" value="${o}" class="sr-only option-radio" onchange="window.saveAnswer(${j},'${o}')"><div class="w-8 h-8 rounded-full border flex items-center justify-center font-bold text-gray-400 uppercase">${o}</div></label>`).join('')}</div></div>`;
            }
            let u = s.url || "";
            if (u.includes('drive.google.com')) u = u.replace('/view', '/preview');
            document.getElementById('pdfFrame').src = u;
            document.getElementById('view-ljk').classList.remove('translate-y-full');
        }

        window.saveAnswer = (q, v) => {
            document.getElementById('saveStatus').style.opacity='1'; 
            setTimeout(()=>document.getElementById('saveStatus').style.opacity='0',1000);
            const count = document.querySelectorAll('input.option-radio:checked').length;
            const btn = document.getElementById('btnSubmit');
            btn.disabled = count < qCount;
            if(!btn.disabled) btn.classList.add('bg-blue-600', 'text-white');
        };

        window.submitExam = async () => {
            if(!confirm("Kirim jawaban sekarang?")) return;
            document.getElementById('firebase-loader').classList.remove('hidden');
            const s = subjects[selectedIdx];
            const resultId = `${s.name}_${studentData.class}_${studentData.number}_${studentData.name}`.replace(/\s/g,'_');
            try {
                await setDoc(doc(db, RES_COLL, resultId), {
                    name: studentData.name, class: studentData.class, number: studentData.number,
                    mapel: s.name, time: new Date().toLocaleString(), status: "Terkirim"
                });
                alert("Berhasil Terkirim!");
                window.location.reload();
            } catch (e) { alert("Gagal mengirim."); document.getElementById('firebase-loader').classList.add('hidden'); }
        };

        const clsS = document.getElementById('loginClass'); ['7A','7B','8A','8B', '9A', '9B'].forEach(c=>{ const o=new Option(c,c); clsS.add(o); });
        const numS = document.getElementById('loginNumber'); for(let i=1;i<=40;i++) numS.add(new Option(i,i));
        window.confirmExit = () => { if(confirm("Keluar?")) window.location.reload(); };
        window.reloadFrame = () => { const f=document.getElementById('pdfFrame'), s=f.src; f.src=''; setTimeout(()=>f.src=s, 100); };

        startSecureApp();
    </script>
</body>
</html>
